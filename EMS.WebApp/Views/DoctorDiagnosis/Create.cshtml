@{
    ViewData["Title"] = "Create - Doctor Diagnosis";
    var shouldMaskData = ViewBag.ShouldMaskData ?? true;
    var userRole = ViewBag.UserRole ?? "";
}

<div id="alertContainer"></div>

<!-- Store masking information -->
<input type="hidden" id="shouldMaskData" value="@shouldMaskData.ToString().ToLower()" />
<input type="hidden" id="userRole" value="@userRole" />

<!-- Doctor Diagnosis Creation Page -->
<div class="glass p-4 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-4">

        <div>
            <a href="@Url.Action("Index", "DoctorDiagnosis")" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Back to List
            </a>
        </div>
    </div>

    <!-- Search employee -->
    <form class="row gx-2 gy-3 align-items-end mb-4" id="frmEmpSearch">
        <div class="col-sm-3 col-md-2">
            <label class="form-label" for="visitType">Visit Type</label>
            <select id="visitType" class="form-select glass" required>
                <option value="Regular Visitor" selected>Regular Visitor</option>
                <option value="First Aid or Emergency">First Aid or Emergency</option>
            </select>
        </div>
        <div class="col-sm-3 col-md-2">
            <label class="form-label" for="empId">Emp ID</label>
            <input type="text" id="empId" class="form-control glass" onkeyup="this.value = this.value.replace(/[^a-zA-Z0-9._\s-]/g, '');" autocomplete="off" required />
        </div>
        <div class="col-sm-3 col-md-3">
            <label class="form-label" for="examDate">Examination Date</label>
            <input type="date" id="examDate" class="form-control glass" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-sm-4 col-md-2">
            <label class="form-label" for="dependent">Dependent Name</label>
            <select id="dependent" class="form-select glass">
                <option>Self</option>
            </select>
        </div>
        <!-- UPDATED: Patient Status dropdown - not required, default --Select Status-- -->
        <div class="col-sm-3 col-md-2">
            <label class="form-label" for="patientStatus">Patient Status</label>
            <select id="patientStatus" class="form-select glass">
                <option value="NA" selected>--Select Status--</option>
                <option value="On Duty">On Duty</option>
                <option value="Off Duty">Off Duty</option>
                <option value="From BPL School">From BPL School</option>
                <option value="Guest House">Guest House</option>
            </select>
        </div>
        <div class="col-auto">
            <button class="btn btn-lg btn-primary" type="submit">Go</button>
        </div>
    </form>

    <!-- Employee Details Container -->
    <div id="empDetailsContainer"></div>

    <!-- Diagnosis details -->
    <div id="diagSection" style="display:none;">
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <label class="form-label" for="bloodPressure">Blood Pressure</label>
                <input id="bloodPressure" class="form-control glass" onkeyup="this.value = this.value.replace(/[^0-9\/]/g, '');"
                       placeholder="e.g. 120/80" @(shouldMaskData ? "disabled" : "") />
            </div>
            <div class="col-md-3">
                <label class="form-label" for="pulse">Pulse</label>
                <input id="pulse" class="form-control glass" onkeyup="this.value = this.value.replace(/[^a-zA-Z0-9.\s]/g, '');" placeholder="e.g. 72 bpm" @(shouldMaskData ? "disabled" : "") />
            </div>
            <div class="col-md-3">
                <label class="form-label" for="temperature">Temperature</label>
                <input id="temperature" class="form-control glass" onkeyup="this.value = this.value.replace(/[^a-zA-Z0-9.]/g, '');" placeholder="e.g. 98.6°F" @(shouldMaskData ? "disabled" : "") />
            </div>
            <div class="col-md-3 d-flex align-items-end">
                @if (!shouldMaskData)
                {
                    <button class="btn btn-sm btn-primary w-100" data-bs-toggle="modal" data-bs-target="#prescriptionModal">
                        Create Prescription
                    </button>
                }
                else
                {
                    <button class="btn btn-sm btn-secondary w-100" disabled title="You don't have permission to create prescriptions">
                        Prescription (No Access)
                    </button>
                }
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-md-12">
                <label class="form-label" for="remarks">
                    <i class="bi bi-chat-left-text"></i> Remarks (Optional)
                </label>
                <textarea id="remarks" class="form-control glass" rows="2" placeholder="Enter any additional remarks or notes..." maxlength="500" @(shouldMaskData ? "disabled" : "")></textarea>
                <div class="form-text">
                    <i class="bi bi-info-circle"></i> Max 500 characters. This will be appended to system-generated remarks.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prescription modal with batch tracking -->
<div class="modal fade" id="prescriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content glass p-3">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="bi bi-file-medical"></i> Prescription - Batch Tracked Medicine
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="frmRx" class="row g-3 mb-3">
                    <div class="col-lg-6">
                        <label class="form-label" for="diseaseCheckboxContainer">
                            <i class="bi bi-clipboard-pulse"></i> Disease Diagnosed
                        </label>
                        <!-- NEW: Checkbox container for diseases instead of select -->
                        <div id="diseaseCheckboxContainer" class="border p-3 glass" style="max-height: 200px; overflow-y: auto; padding-left: 40px !important;">
                            <div class="form-text mb-2">
                                <i class="bi bi-info-circle"></i> Check all applicable diseases (Format: ID - Name)
                            </div>
                            <!-- Disease checkboxes will be loaded here -->
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllDiseases">
                                <i class="bi bi-check-all"></i> Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllDiseases">
                                <i class="bi bi-x-circle"></i> Clear All
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <button class="btn btn-sm btn-outline-primary" type="button" id="btnAddMedRx">
                            <i class="bi bi-plus-lg"></i> Add medicine
                        </button>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Medicines are sorted by expiry date (Format: ID - Name - Batch)
                        </div>
                    </div>
                </form>

                <!-- Stock validation alert container -->
                <div id="stockValidationContainer"></div>

                <div class="table-responsive">
                    <table class="table table-striped table-glass glass-table" id="tblRxMeds">
                        <thead>
                            <tr>
                                <th style="width:50px">Sl.</th>
                                <th>Medicine (ID - Base - Name - Batch)</th>
                                <th style="width:100px">Available Stock</th>
                                <th style="width:100px">Quantity</th>
                                <th style="width:120px">Dose</th>
                                <th style="width:120px">Expiry</th>
                                <th style="width:80px">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="noMedicineRow">
                                <td colspan="7" class="text-center text-muted">
                                    <i class="bi bi-info-circle"></i> No medicines added yet. Click "Add medicine" to start.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-primary btn-sm" id="savePrescriptionBtn">
                    <i class="bi bi-check-circle"></i> Save Prescription
                </button>
                <button class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- View Prescription Modal -->
<div class="modal fade" id="viewPrescriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content glass p-3">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">View Prescription Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="prescriptionLoadingState" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Loading prescription details...
                </div>

                <!-- Prescription content -->
                <div id="prescriptionContent" style="display: none;">
                    <!-- Employee & Prescription Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="glass p-3">
                                <h6 class="mb-3">Employee Information</h6>
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Employee ID</label>
                                        <div class="fw-medium" id="viewEmpId"></div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Name</label>
                                        <div class="fw-medium" id="viewEmpName"></div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Department</label>
                                        <div class="fw-medium" id="viewEmpDept"></div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Plant</label>
                                        <div class="fw-medium" id="viewEmpPlant"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="glass p-3">
                                <h6 class="mb-3">Prescription Information</h6>
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Prescription Date</label>
                                        <div class="fw-medium" id="viewPrescDate"></div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Doctor</label>
                                        <div class="fw-medium" id="viewDoctor"></div>
                                    </div>
                                    <!-- NEW: Patient Status display -->
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Patient Status</label>
                                        <div class="fw-medium" id="viewPatientStatus"></div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Blood Pressure</label>
                                        <div class="fw-medium" id="viewBP"></div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Pulse</label>
                                        <div class="fw-medium" id="viewPulse"></div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted mb-0">Temperature</label>
                                        <div class="fw-medium" id="viewTemperature"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Diagnosed Diseases -->
                    <div class="mb-4">
                        <div class="glass p-3">
                            <h6 class="mb-3">Diagnosed Diseases</h6>
                            <div id="viewDiseases">
                                <p class="text-muted small">No diseases diagnosed.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Prescribed Medicines -->
                    <div class="mb-4">
                        <div class="glass p-3">
                            <h6 class="mb-3">Prescribed Medicines</h6>
                            <div class="table-responsive">
                                <table class="table table-sm glass-table w-100 align-middle" id="viewMedicinesTable">
                                    <thead>
                                        <tr>
                                            <th style="width:60px">Sl.</th>
                                            <th>Medicine</th>
                                            <th style="width:100px">Quantity</th>
                                            <th>Dose</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No medicines prescribed.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Remarks -->
                    <div id="remarksSection" style="display: none;">
                        <div class="glass p-3">
                            <h6 class="mb-3">Remarks</h6>
                            <p id="viewRemarks" class="mb-0"></p>
                        </div>
                    </div>
                </div>

                <!-- Error state -->
                <div id="prescriptionErrorState" style="display: none;" class="text-center py-4">
                    <div class="text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="prescriptionErrorMessage">Error loading prescription details.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="~/css/jquery-ui.css">
    <script src="~/js/jquery-ui.min.js"></script>
    <link href="~/css/select2.min.css" rel="stylesheet" />
    <link href="~/css/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <script src="~/js/select2.min.js"></script>


    <script>
        let prescriptionData = { diseases: [], medicines: [] };
        let currentEmpId = '';
        let currentVisitType = 'Regular Visitor';
        let currentPatientStatus = ''; // UPDATED: No default value - patient status is optional

        // Get masking info
        const shouldMaskData = $('#shouldMaskData').val() === 'true';
        const userRole = $('#userRole').val();

        // Masking utility function
        function maskValue(value) {
            return shouldMaskData ? '*****' : (value || '');
        }

        $(document).ready(function () {
            // Load prescription data
            loadPrescriptionData();

            // Employee ID autocomplete
            $("#empId").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: '@Url.Action("SearchEmployeeIds", "DoctorDiagnosis")',
                        data: { term: request.term },
                        success: function (data) {
                            response(data);
                        }
                    });
                },
                minLength: 1
            });

            // Load dependents when employee is searched
            $('#empId').on('blur', function() {
                var empId = $(this).val().trim();
                if (empId) {
                    loadEmployeeDependents(empId);
                }
            });

            // NEW: Handle dependent selection change
            $('#dependent').on('change', function() {
                var dependentName = $(this).val();
                console.log('Dependent changed to:', dependentName);

                // If employee details are already loaded, reload them with dependent info
                if (currentEmpId) {
                    var examDate = $('#examDate').val();
                    var visitType = $('#visitType').val();
                    var patientStatus = $('#patientStatus').val();

                    console.log('Reloading employee details with dependent:', dependentName);
                    searchEmployeeWithDependent(currentEmpId, examDate, visitType, patientStatus, dependentName);
                }
            });

            // Track visit type changes
            $('#visitType').on('change', function() {
                currentVisitType = $(this).val();
                console.log('Visit type changed to:', currentVisitType);
            });

            // Track patient status changes
            $('#patientStatus').on('change', function() {
                currentPatientStatus = $(this).val();
                console.log('Patient status changed to:', currentPatientStatus);
            });

            // Form submission
            $('#frmEmpSearch').on('submit', function (e) {
                e.preventDefault();
                var visitType = $('#visitType').val();
                var empId = $('#empId').val().trim();
                var examDate = $('#examDate').val();
                var patientStatus = $('#patientStatus').val();
                var dependentName = $('#dependent').val(); // NEW: Get selected dependent

                if (!visitType) {
                    showAlert('error', 'Please select a visit type.');
                    return;
                }

                if (!empId) {
                    showAlert('error', 'Please enter an Employee ID.');
                    return;
                }

                // REMOVED: Patient status validation - field is now optional

                currentVisitType = visitType;
                currentPatientStatus = patientStatus;
                console.log('Processing visit:', visitType, 'for employee:', empId, 'with patient status:', patientStatus, 'and dependent:', dependentName);

                searchEmployeeWithDependent(empId, examDate, visitType, patientStatus, dependentName);
            });

            // Add medicine row with batch tracking
            $('#btnAddMedRx').on('click', function () {
                addMedicineRowWithBatch();
            });

            // Save prescription with stock validation
            $('#savePrescriptionBtn').on('click', function () {
                savePrescriptionWithStockValidation();
            });

            // Disease selection buttons
            $('#selectAllDiseases').on('click', function() {
                $('#diseaseCheckboxContainer input[type="checkbox"]').prop('checked', true);
            });

            $('#clearAllDiseases').on('click', function() {
                $('#diseaseCheckboxContainer input[type="checkbox"]').prop('checked', false);
            });
        })
        // UPDATED: Search employee with dependent support
        function searchEmployeeWithDependent(empId, examDate, visitType, patientStatus, dependentName) {
            currentEmpId = empId;

            $.ajax({
                url: '@Url.Action("GetEmployeeDetails", "DoctorDiagnosis")',
                type: 'GET',
                data: {
                    empId: empId,
                    examDate: examDate,
                    visitType: visitType || currentVisitType,
                    patientStatus: patientStatus || currentPatientStatus,
                    dependentName: dependentName // NEW: Include dependent name
                },
                success: function (result) {
                    $('#empDetailsContainer').html(result);
                    $('#diagSection').show();

                    if (shouldMaskData) {
                        $('#bloodPressure, #pulse, #temperature').val('*****').prop('disabled', true);
                    }

                    // Show appropriate alert based on patient type
                    var patientInfo = dependentName && dependentName !== "Self" ? `dependent: ${dependentName}` : "employee (self)";
                    var visitTypeDisplay = (visitType || currentVisitType);
                    var patientStatusDisplay = (patientStatus || currentPatientStatus);

                    if (visitTypeDisplay === 'First Aid or Emergency') {
                        showAlert('info', `First Aid/Emergency visit for ${patientInfo} - Status: ${patientStatusDisplay}`);
                    } else {
                        showAlert('success', `Regular visit for ${patientInfo} - Status: ${patientStatusDisplay}`);
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 404) {
                        showAlert('error', 'Employee not found.');
                    } else {
                        showAlert('error', 'Error loading employee details.');
                    }
                    $('#empDetailsContainer').empty();
                    $('#diagSection').hide();
                }
            });
        }
        // Load employee dependents
        function loadEmployeeDependents(empId) {
            $.ajax({
                url: '@Url.Action("GetEmployeeDependents", "DoctorDiagnosis")',
                type: 'GET',
                data: { empId: empId },
                success: function (response) {
                    var dependentSelect = $('#dependent');
                    dependentSelect.empty();

                    if (response.success && response.dependents) {
                        response.dependents.forEach(function (dependent) {
                            dependentSelect.append(new Option(dependent.text, dependent.value));
                        });
                        console.log('Loaded dependents:', response.dependents.length);
                    } else {
                        dependentSelect.append(new Option('Self', 'Self'));
                        console.log('No dependents found, using Self only');
                    }
                },
                error: function () {
                    console.log('Error loading dependents');
                    var dependentSelect = $('#dependent');
                    dependentSelect.empty();
                    dependentSelect.append(new Option('Self', 'Self'));
                }
            });
        }

        function searchEmployee(empId, examDate) {
            currentEmpId = empId;

            $.ajax({
                url: '@Url.Action("GetEmployeeDetails", "DoctorDiagnosis")',
                type: 'GET',
                data: {
                    empId: empId,
                    examDate: examDate,
                    visitType: currentVisitType,
                    patientStatus: currentPatientStatus // NEW: Include patient status
                },
                success: function (result) {
                    $('#empDetailsContainer').html(result);
                    $('#diagSection').show();

                    if (shouldMaskData) {
                        $('#bloodPressure, #pulse, #temperature').val('*****').prop('disabled', true);
                    }

                    // NEW: Show patient status in alert
                    if (currentVisitType === 'First Aid or Emergency') {
                        showAlert('info', `First Aid/Emergency visit for ${empId} - Status: ${currentPatientStatus}`);
                    } else {
                        showAlert('success', `Regular visit for ${empId} - Status: ${currentPatientStatus}`);
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 404) {
                        showAlert('error', 'Employee not found.');
                    } else {
                        showAlert('error', 'Error loading employee details.');
                    }
                    $('#empDetailsContainer').empty();
                    $('#diagSection').hide();
                }
            });
        }

        // Load prescription data with batch information
        function loadPrescriptionData() {
            if (shouldMaskData) {
                return;
            }

            $.ajax({
                url: '@Url.Action("GetPrescriptionData", "DoctorDiagnosis")',
                type: 'GET',
                success: function (data) {
                    if (data.success) {
                        prescriptionData = data;
                        populateDiseaseCheckboxes();
                    } else {
                        showAlert('warning', 'Failed to load medicine data: ' + (data.message || 'Unknown error'));
                    }
                },
                error: function () {
                    console.log('Error loading prescription data');
                    showAlert('error', 'Error loading prescription data.');
                }
            });
        }

        // NEW: Populate disease checkboxes instead of select dropdown
        function populateDiseaseCheckboxes() {
            var diseaseContainer = $('#diseaseCheckboxContainer');
            diseaseContainer.find('.form-check').remove(); // Clear existing checkboxes

            if (prescriptionData.diseases && prescriptionData.diseases.length > 0) {
                prescriptionData.diseases.forEach(function (disease) {
                    var checkboxHtml = `
                        <div class="form-check mb-2">
                            <input class="form-check-input disease-checkbox" type="checkbox" value="${disease.value}" id="disease_${disease.value}">
                            <label class="form-check-label small" for="disease_${disease.value}">
                                ${disease.text}
                            </label>
                        </div>
                    `;
                    diseaseContainer.append(checkboxHtml);
                });
                console.log('Populated', prescriptionData.diseases.length, 'disease checkboxes');
            } else {
                diseaseContainer.append('<div class="text-muted small">No diseases available</div>');
            }
        }

        // NEW: Function to get selected diseases from checkboxes
        function getSelectedDiseases() {
            var selectedDiseases = [];
            $('#diseaseCheckboxContainer .disease-checkbox:checked').each(function() {
                selectedDiseases.push(parseInt($(this).val()));
            });
            return selectedDiseases;
        }

        // Add medicine row with batch tracking and stock information
        function addMedicineRowWithBatch() {
            const tbody = $('#tblRxMeds tbody');

            $('#noMedicineRow').remove();

            const idx = tbody.children().length + 1;

            var medicineOptions = '<option value="">-- Select Medicine (ID - Base - Name - Batch) --</option>';

            if (prescriptionData.medicines && prescriptionData.medicines.length > 0) {
                prescriptionData.medicines.forEach(function (medicine) {
                    medicineOptions += `<option value="${medicine.medItemId}"
                                               data-indent-item-id="${medicine.indentItemId}"
                                               data-available-stock="${medicine.availableStock}"
                                               data-batch-no="${medicine.batchNo || ''}"
                                               data-expiry-date="${medicine.expiryDate || ''}"
                                               data-expiry-days="${medicine.daysToExpiry}"
                                               data-company-name="${medicine.companyName || ''}"
                                               data-medicine-name="${medicine.text.split(' - ')[1] || medicine.text}"
                                               class="${medicine.expiryClass || ''}">
                                            ${medicine.text}
                                        </option>`;
                });
            } else {
                medicineOptions += '<option value="" disabled>No medicines with available stock</option>';
            }

            const tr = $(`
                <tr class="medicine-row" data-row-index="${idx}">
                    <td class="text-center fw-bold">${idx}</td>
                    <td>
                        <select class="form-control form-control-sm medicine-select" name="medicineId" onchange="handleMedicineSelection(this)" required>
                            ${medicineOptions}
                        </select>
                    </td>
                    <td class="text-center">
                        <span class="available-stock fw-bold text-success">-</span>
                    </td>
                    <td>
                        <input class="form-control form-control-sm text-center quantity-input"
                               name="quantity" type="number" min="1" max="999" onkeyup="onlyDigits(this)"
                               placeholder="0" onchange="validateQuantity(this)" required />
                        <div class="invalid-feedback small"></div>
                    </td>
                    <td>
                        <input class="form-control form-control-sm" type="text" name="dose" onkeyup="onlyDigitsAndHyphen(this)"
                               placeholder="e.g. 1-0-1 (optional)" />
                    </td>
                    <td class="text-center">
                        <span class="expiry-status small">-</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger" type="button"
                                onclick="removeMedicineRowEnhanced(this)" title="Remove this medicine">
                            <i class="bi bi-trash"></i>Del
                        </button>
                    </td>
                </tr>
            `);

            tbody.append(tr);

            // Initialize Select2 on the medicine dropdown
            tr.find('.medicine-select').select2({
                theme: 'bootstrap-5',
                placeholder: '-- Select Medicine (ID - Base - Name - Batch) --',
                allowClear: true,
                width: '100%',
                dropdownParent: $('#prescriptionModal'),
                templateResult: formatMedicineOption,
                templateSelection: formatMedicineSelection
            });

            tr.find('.medicine-select').focus();

            console.log('Medicine row added with batch tracking. Total:', tbody.children().length);
        }

        // Custom formatting for Select2 medicine options
        function formatMedicineOption(option) {
            if (!option.id) {
                return option.text;
            }

            var $option = $(option.element);
            var expiryClass = $option.attr('class') || '';
            var $formatted = $('<span></span>');
            $formatted.text(option.text);

            // Apply the expiry class for color coding
            if (expiryClass.includes('text-danger')) {
                $formatted.addClass('text-danger fw-bold');
            } else if (expiryClass.includes('text-warning')) {
                $formatted.addClass('text-warning fw-semibold');
            } else if (expiryClass.includes('text-info')) {
                $formatted.addClass('text-info');
            } else if (expiryClass.includes('text-success')) {
                $formatted.addClass('text-success');
            }

            return $formatted;
        }

        // Custom formatting for selected medicine
        function formatMedicineSelection(option) {
            return option.text;
        }

        function onlyDigitsAndHyphen(inputText) {
            inputText.value = inputText.value.replace(/[^0-9-]/g, '');
        }

        function onlyDigits(inputNumber) {
            inputNumber.value = inputNumber.value.replace(/[^0-9]/g, '');
        }

        // Handle medicine selection with proper name extraction
        function handleMedicineSelection(selectElement) {
            const $select = $(selectElement);
            const $row = $select.closest('tr');
            const selectedOption = $select.find('option:selected');

            if (selectedOption.val()) {
                const indentItemId = selectedOption.data('indent-item-id');
                const availableStock = selectedOption.data('available-stock');
                const batchNo = selectedOption.data('batch-no');
                const expiryDate = selectedOption.data('expiry-date');
                const expiryDays = selectedOption.data('expiry-days');
                const companyName = selectedOption.data('company-name');
                const medicineName = selectedOption.data('medicine-name');

                $row.find('.available-stock').text(availableStock);
                $row.find('.quantity-input').attr('max', availableStock);

                const $expiryStatus = $row.find('.expiry-status');
                if (expiryDays < 0) {
                    $expiryStatus.html('<span class="text-danger">EXPIRED</span>');
                } else if (expiryDays <= 7) {
                    $expiryStatus.html(`<span class="text-warning">${expiryDate} - (${expiryDays}d)</span>`);
                } else if (expiryDays <= 30) {
                    $expiryStatus.html(`<span class="text-info">${expiryDate } - (${expiryDays}d)</span>`);
                } else {
                    $expiryStatus.html(`<span class="text-success">${expiryDate} - (${expiryDays}d)</span>`);
                }

                if ($row.find('input[name="indentItemId"]').length === 0) {
                    $row.append(`
                        <input type="hidden" name="indentItemId" value="${indentItemId}" />
                        <input type="hidden" name="batchNo" value="${batchNo}" />
                        <input type="hidden" name="expiryDate" value="${expiryDate}" />
                        <input type="hidden" name="availableStock" value="${availableStock}" />
                        <input type="hidden" name="medicineName" value="${medicineName}" />
                    `);
                } else {
                    $row.find('input[name="indentItemId"]').val(indentItemId);
                    $row.find('input[name="batchNo"]').val(batchNo);
                    $row.find('input[name="expiryDate"]').val(expiryDate);
                    $row.find('input[name="availableStock"]').val(availableStock);
                    $row.find('input[name="medicineName"]').val(medicineName);
                }

                console.log('Medicine selected:', {
                    id: selectedOption.val(),
                    name: medicineName,
                    batchNo: batchNo,
                    availableStock: availableStock,
                    expiryDays: expiryDays
                });
            } else {
                $row.find('.available-stock').text('-');
                $row.find('.expiry-status').text('-');
                $row.find('.quantity-input').attr('max', 999);
                $row.find('input[type="hidden"]').remove();
            }
        }

        // Validate quantity against available stock
        function validateQuantity(quantityInput) {
            const $input = $(quantityInput);
            const $row = $input.closest('tr');
            const quantity = parseInt($input.val()) || 0;
            const availableStock = parseInt($row.find('input[name="availableStock"]').val()) || 0;
            const medicineName = $row.find('.medicine-select option:selected').text();

            const $feedback = $input.siblings('.invalid-feedback');

            $input.removeClass('is-invalid is-valid');
            $feedback.text('');

            if (quantity > 0) {
                if (quantity > availableStock) {
                    $input.addClass('is-invalid');
                    $feedback.text(`Insufficient stock! Available: ${availableStock}`);
                    console.log('Insufficient stock validation failed:', {
                        medicine: medicineName,
                        requested: quantity,
                        available: availableStock
                    });
                } else {
                    $input.addClass('is-valid');
                    console.log('Stock validation passed:', {
                        medicine: medicineName,
                        requested: quantity,
                        available: availableStock
                    });
                }
            }
        }

        function removeMedicineRowEnhanced(button) {
            const tbody = $('#tblRxMeds tbody');
            const $row = $(button).closest('tr');

            // Destroy Select2 instance before removing the row
            const $select = $row.find('.medicine-select');
            if ($select.length > 0 && $select.hasClass('select2-hidden-accessible')) {
                $select.select2('destroy');
            }

            $row.remove();

            tbody.find('tr.medicine-row').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('data-row-index', index + 1);
            });

            if (tbody.children().length === 0) {
                tbody.append(`
                    <tr id="noMedicineRow">
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-info-circle"></i> No medicines added yet. Click "Add medicine" to start.
                        </td>
                    </tr>
                `);
            }

            console.log('Medicine row removed');
        }

        // UPDATED: Save prescription with checkbox validation and patient status
        function savePrescriptionWithStockValidation() {
            if (shouldMaskData) {
                showAlert('error', 'You don\'t have permission to save prescriptions.');
                return;
            }

            // Get selected diseases from checkboxes
            var selectedDiseases = getSelectedDiseases();
            var medicines = [];
            var bloodPressure = $('#bloodPressure').val();
            var pulse = $('#pulse').val();
            var temperature = $('#temperature').val();
            var remarks = $('#remarks').val().trim(); // NEW: Get user-provided remarks
            var examDate = $('#examDate').val();
            var dependentName = $('#dependent').val(); // NEW: Get selected dependent

            if (selectedDiseases.length === 0) {
                showAlert('error', 'Please select at least one disease.');
                $('#diseaseCheckboxContainer').focus();
                return;
            }

            let hasValidMedicine = false;
            let hasValidationErrors = false;

            // Debug: Log all medicine rows
            console.log('Processing medicine rows...');
            $('#tblRxMeds tbody tr.medicine-row').each(function (index) {
                const $row = $(this);
                const medicineId = $row.find('[name="medicineId"]').val();
                const quantity = parseInt($row.find('[name="quantity"]').val()) || 0;
                const dose = $row.find('[name="dose"]').val();
                const indentItemId = parseInt($row.find('[name="indentItemId"]').val()) || 0;
                const batchNo = $row.find('[name="batchNo"]').val();
                const expiryDate = $row.find('[name="expiryDate"]').val();
                const availableStock = parseInt($row.find('[name="availableStock"]').val()) || 0;
                const medicineName = $row.find('[name="medicineName"]').val();

                if (medicineId && quantity) {
                    if (quantity > availableStock) {
                        hasValidationErrors = true;
                        $row.find('.quantity-input').addClass('is-invalid');
                        showAlert('error', `Insufficient stock for ${medicineName}. Available: ${availableStock}, Requested: ${quantity}`);
                        return false;
                    }

                    medicines.push({
                        MedItemId: parseInt(medicineId),
                        Quantity: quantity,
                        Dose: dose || '',
                        MedicineName: medicineName || 'Unknown Medicine',
                        IndentItemId: indentItemId > 0 ? indentItemId : null,
                        BatchNo: batchNo,
                        ExpiryDate: expiryDate,
                        AvailableStock: availableStock
                    });
                    hasValidMedicine = true;
                }
            });

            if (hasValidationErrors) {
                return;
            }

            if (!hasValidMedicine) {
                showAlert('error', 'Please add at least one complete medicine entry with valid stock.');
                return;
            }

            const $saveBtn = $('#savePrescriptionBtn');
            const originalText = $saveBtn.html();
            $saveBtn.html('<i class="bi bi-hourglass-split"></i> Validating stock & saving...').prop('disabled', true);

            console.log('Saving prescription with dependent support and remarks:', {
                visitType: currentVisitType,
                patientStatus: currentPatientStatus,
                dependentName: dependentName,
                remarks: remarks,
                diseases: selectedDiseases,
                medicines: medicines
            });

            $.ajax({
                url: '@Url.Action("SavePrescription", "DoctorDiagnosis")',
                type: 'POST',
                data: {
                    empId: currentEmpId,
                    examDate: examDate,
                    selectedDiseases: selectedDiseases,
                    medicines: medicines,
                    bloodPressure: bloodPressure,
                    pulse: pulse,
                    temperature: temperature,
                    remarks: remarks, // NEW: Include user-provided remarks
                    visitType: currentVisitType,
                    patientStatus: currentPatientStatus,
                    dependentName: dependentName // NEW: Include dependent name
                },
                success: function (response) {
                    if (response.success) {
                        var patientInfo = dependentName && dependentName !== "Self" ? `dependent: ${dependentName}` : "employee";
                        showAlert('success', response.message || `Prescription saved successfully for ${patientInfo} with stock updates!`);
                        $('#prescriptionModal').modal('hide');

                        // Clear form - INCLUDING remarks
                        $('#diseaseCheckboxContainer .disease-checkbox').prop('checked', false);
                        $('#tblRxMeds tbody').html(`
                            <tr id="noMedicineRow">
                                <td colspan="7" class="text-center text-muted">
                                    <i class="bi bi-info-circle"></i> No medicines added yet.
                                </td>
                            </tr>
                        `);
                        $('#bloodPressure, #pulse, #temperature, #remarks').val(''); // UPDATED: Clear remarks too

                        loadPrescriptionData();

                        // Redirect to list after successful save
                        setTimeout(function() {
                            window.location.href = '@Url.Action("Index", "DoctorDiagnosis")';
                        }, 2000);
                    } else {
                        showAlert('error', response.message || 'Error saving prescription.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error saving prescription:', error);
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        showAlert('error', xhr.responseJSON.message);
                    } else {
                        showAlert('error', 'Error saving prescription: ' + error);
                    }
                },
                complete: function() {
                    $saveBtn.html(originalText).prop('disabled', false);
                }
            });
        }
        function viewDiagnosis(prescriptionId) {
            $('#viewPrescriptionModal').modal('show');

            $('#prescriptionLoadingState').show();
            $('#prescriptionContent').hide();
            $('#prescriptionErrorState').hide();

            $.ajax({
                url: '@Url.Action("GetPrescriptionDetails", "DoctorDiagnosis")',
                type: 'GET',
                data: { prescriptionId: prescriptionId },
                success: function (data) {
                    if (data.success) {
                        populatePrescriptionModal(data.prescription);
                        $('#prescriptionLoadingState').hide();
                        $('#prescriptionContent').show();
                    } else {
                        showPrescriptionError(data.message || 'Failed to load prescription details.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading prescription:', error);
                    showPrescriptionError('Error loading prescription details: ' + error);
                }
            });
        }

        function populatePrescriptionModal(prescription) {
            $('#viewEmpId').text(prescription.employeeId || 'N/A');
            $('#viewEmpName').text(prescription.employeeName || 'N/A');
            $('#viewEmpDept').text(prescription.department || 'N/A');
            $('#viewEmpPlant').text(prescription.plant || 'N/A');

            $('#viewPrescDate').text(formatDate(prescription.prescriptionDate));
            $('#viewDoctor').text(prescription.createdBy || 'N/A');
            $('#viewPatientStatus').text(prescription.patientStatus || 'N/A'); // NEW: Display patient status
            $('#viewBP').text(maskValue(prescription.bloodPressure) || 'Not recorded');
            $('#viewPulse').text(maskValue(prescription.pulse) || 'Not recorded');
            $('#viewTemperature').text(maskValue(prescription.temperature) || 'Not recorded');

            populateDiseases(prescription.diseases);
            populateMedicinesWithMasking(prescription.medicines);

            if (prescription.remarks && prescription.remarks.trim()) {
                $('#viewRemarks').text(prescription.remarks);
                $('#remarksSection').show();
            } else {
                $('#remarksSection').hide();
            }
        }

        function populateDiseases(diseases) {
            const diseaseContainer = $('#viewDiseases');

            if (diseases && diseases.length > 0) {
                var diseaseList = '';
                diseases.forEach(function(disease) {
                    diseaseList += '<span class="badge bg-info me-2 mb-2">' + disease.diseaseName + '</span>';
                });
                diseaseContainer.html(diseaseList);
            } else {
                diseaseContainer.html('<p class="text-muted small mb-0">No diseases diagnosed.</p>');
            }
        }

        function populateMedicinesWithMasking(medicines) {
            const tbody = $('#viewMedicinesTable tbody');
            tbody.empty();

            if (medicines && medicines.length > 0) {
                medicines.forEach(function (medicine, index) {
                    const row = '<tr>' +
                        '<td>' + (index + 1) + '</td>' +
                        '<td>' + maskValue(medicine.medicineName) + '</td>' +
                        '<td>' + medicine.quantity + '</td>' +
                        '<td>' + (medicine.dose || 'Not specified') + '</td>' +
                    '</tr>';
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="4" class="text-center text-muted">No medicines prescribed.</td></tr>');
            }
        }

        function showPrescriptionError(message) {
            $('#prescriptionLoadingState').hide();
            $('#prescriptionContent').hide();
            $('#prescriptionErrorMessage').text(message);
            $('#prescriptionErrorState').show();
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showAlert(type, message) {
            const alertClass = type === 'error' ? 'alert-danger' :
                              type === 'success' ? 'alert-success' :
                              type === 'info' ? 'alert-info' : 'alert-warning';

            const alert = $(`
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);

            $('#alertContainer').html(alert);

            setTimeout(() => {
                alert.alert('close');
            }, 5000);
        }
    </script>
}

<style>
    /* ===== STYLING ===== */
    .modal-backdrop {
        z-index: -1 !important;
    }

    .glass {
        /* --glass-bg: #93c1e975 !important;   */
        --glass-bg: rgba(255, 255, 255, 0.38) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    /* NEW: Disease checkbox container styling */
    #diseaseCheckboxContainer {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 0.5rem;
    }

        #diseaseCheckboxContainer .form-check {
            padding: 0.375rem 0.5rem;
            margin: 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

            #diseaseCheckboxContainer .form-check:last-child {
                border-bottom: none;
            }

            #diseaseCheckboxContainer .form-check:hover {
                background-color: rgba(13, 110, 253, 0.05);
            }

        #diseaseCheckboxContainer .form-check-input:checked + .form-check-label {
            color: #0d6efd;
            font-weight: 500;
        }

    .modal .form-control, .modal .form-select {
        font-size: 0.9rem;
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

        .modal .form-control:focus, .modal .form-select:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

    /* Select2 custom styling for modal */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border: 1px solid #ced4da;
    }

    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        padding-left: 0;
        line-height: calc(1.5em + 0.5rem);
        color: inherit;
    }

    .select2-container--bootstrap-5 .select2-dropdown {
        font-size: 0.875rem;
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        z-index: 9999 !important;
    }

    .select2-container--bootstrap-5 .select2-results__option {
        padding: 0.375rem 0.75rem;
        font-family: 'Courier New', monospace;
    }

    .select2-container {
        width: 100% !important;
    }

    /* Maintain color coding in Select2 dropdown */
    .select2-container--bootstrap-5 .select2-results__option.text-danger {
        background: linear-gradient(90deg, #f8d7da 0%, white 100%) !important;
        color: #721c24 !important;
        font-weight: 600;
    }

    .select2-container--bootstrap-5 .select2-results__option.text-warning {
        background: linear-gradient(90deg, #fff3cd 0%, white 100%) !important;
        color: #856404 !important;
        font-weight: 500;
    }

    .select2-container--bootstrap-5 .select2-results__option.text-info {
        background: linear-gradient(90deg, #d1ecf1 0%, white 100%) !important;
        color: #0c5460 !important;
    }

    .select2-container--bootstrap-5 .select2-results__option.text-success {
        background: linear-gradient(90deg, #d4edda 0%, white 100%) !important;
        color: #155724 !important;
    }

    .medicine-select {
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
    }

        .medicine-select option {
            padding: 8px;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
        }

        .medicine-select optgroup {
            font-weight: bold;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            color: #495057;
            padding: 4px 8px;
        }

            .medicine-select optgroup option {
                font-weight: normal;
                padding-left: 16px;
                font-size: 0.8rem;
            }

        .medicine-select option.text-danger {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }

        .medicine-select option.text-warning {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }

        .medicine-select option.text-info {
            background-color: #d1ecf1 !important;
            color: #0c5460 !important;
        }

        .medicine-select option.text-success {
            background-color: #d4edda !important;
            color: #155724 !important;
        }

    .table th {
        background-color: rgba(13, 110, 253, 0.1);
        border: none;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .table td {
        vertical-align: middle;
        border-color: rgba(0,0,0,0.1);
    }

    .badge {
        font-size: 0.75rem;
    }

    .btn-group-vertical .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .table-responsive {
        background: white;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        max-height: 400px;
        overflow-y: auto;
    }

    #alertContainer {
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        z-index: 9999 !important;
        max-width: 400px !important;
    }

    .breadcrumb {
        background: none;
        padding: 0;
        margin: 0;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
        color: #6c757d;
    }

    @@media (max-width: 768px) {
        .modal-dialog {
            margin: 0.5rem !important;
            max-width: calc(100% - 1rem) !important;
            width: calc(100% - 1rem) !important;
        }

        .modal-content {
            max-height: calc(100vh - 1rem) !important;
        }

        .modal-body {
            max-height: calc(100vh - 150px) !important;
            padding: 0.75rem !important;
        }

        #tblRxMeds {
            font-size: 0.8rem;
        }

        .medicine-select, #diseaseCheckboxContainer {
            font-size: 0.8rem;
        }
    }
</style>