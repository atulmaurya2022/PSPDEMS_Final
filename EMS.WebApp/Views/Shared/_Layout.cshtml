@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@inject IAuthorizationService AuthorizationService
@using Microsoft.AspNetCore.Identity
@inject IHttpContextAccessor HttpContextAccessor
@using EMS.WebApp.Authorization
@using EMS.WebApp.Data
@using EMS.WebApp.Services
@inject IMenuService MenuService
@{
    var userName = User.Identity.Name ?? User.FindFirst("name")?.Value ?? "";
    var groupedMenus = await MenuService.GetGroupedMenuItemsForUserAsync(userName);
    var UserRole = User.FindFirst("RoleName")?.Value ?? "";
}

@{
    var allowedScreens = ViewBag.AllowedScreens as List<MenuItemViewModel>;
}
@functions {
    public string InsertSpaceBeforeCapsAfterSecondIndex(string input)
    {
        if (string.IsNullOrEmpty(input) || input.Length <= 2)
            return input;
        var result = new System.Text.StringBuilder();
        result.Append(input[0]);
        result.Append(input[1]);
        for (int i = 2; i < input.Length; i++)
        {
            char c = input[i];
            if (char.IsUpper(c))
            {
                result.Append(' ');
            }
            result.Append(c);
        }
        return result.ToString();
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] | EMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Local Bootstrap CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css" />
    <link href="~/css/site.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/jquery-ui.min.css">

    

    @if (User.Identity?.IsAuthenticated == true)
    {
        <script src="~/js/session-timeout.js"></script>
    }
   
    <link rel="stylesheet" href="~/lib/bootstrap/bootstrap-icons/bootstrap-icons.css"/>

</head>
<body>
    <!-- ===== Header ===== -->

    <header class="app-header d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <a class="navbar-brand d-flex align-items-center gap-2" asp-controller="Dashboard" asp-action="">
                <img src="~/images/logo_itc.png" alt="Logo" style="height:32px" />
            </a>
            <span class="mainTexinNav">Employee Medical System (EMS)  </span>
            


            <ul class="nav top-nav d-none d-md-flex aligntnavcenter">
                <li class="nav-item"><a class="nav-link" asp-controller="Dashboard" asp-action="" role="button"><i class="bi bi-display"></i>Dashboard</a> </li>

                <!-- Masters Menu -->
                @if (groupedMenus.ContainsKey("Masters") && groupedMenus["Masters"].Any())
                {

                    bool hasActiveItem = false;
                    if (groupedMenus.ContainsKey("Masters"))
                    {
                        hasActiveItem = groupedMenus["Masters"].Any(item =>
                        ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName);
                    }

                    <li class="nav-item dropdown @(hasActiveItem ? "has-active-item" : "")" ">
                        <a class="nav-link dropdown-toggle" href="#" id="mastersDropdown" role="button">
                            <i class="bi bi-gear"></i> Masters
                        </a>
                        <div class="dropdown-menu mega-menu">
                            @foreach (var item in groupedMenus["Masters"])
                            {
                                string screenName = item.ScreenName;
                                string iconClass = "bi-gear"; // Default icon


                                if (screenName.Contains("User") || screenName.Contains("Hr")) iconClass = "bi-people";
                                else if (screenName.Contains("Doctor")) iconClass = "bi-person-badge";
                                
                                else if (screenName.Contains("PlantMaster")) iconClass = "bi bi-building";
                                else if (screenName.Contains("MedDisease")) iconClass = "bi bi-virus";
                                else if (screenName.Contains("DepartmentMaster")) iconClass = "bi bi-diagram-3";
                                else if (screenName.Contains("MedAmbulanceMaster")) iconClass = "bi bi-truck";
                                else if (screenName.Contains("MedCategory")) iconClass = "bi bi-grid-3x3";
                                else if (screenName.Contains("MedDiagnosis")) iconClass = "bi bi-clipboard-heart";

                                else if (screenName.Contains("MedExamCategory")) iconClass = "bi bi-calendar2-check";
                                else if (screenName.Contains("SysUser")) iconClass = "bi bi-person-lines-fill";
                                else if (screenName.Contains("SystemScreenMaster")) iconClass = "bi bi-display";
                                else if (screenName.Contains("SysRole")) iconClass = "bi bi-person-badge";


                                else if (screenName.Contains("SysAttachScreenRole")) iconClass = "bi bi-diagram-3";
                                else if (screenName.Contains("MedBase")) iconClass = "bi bi-capsule";
                                else if (screenName.Contains("MedRefHospital")) iconClass = "bi bi-hospital";
                                else if (screenName.Contains("MedMaster")) iconClass = "bi bi-capsule-pill";

                                // Process screen name as per your logic
                                if (screenName.Contains("SysAttachScreenRole"))
                                {
                                    screenName = screenName.Replace("SysAttachScreenRole", "Role Mapping");
                                }
                                if (screenName.Contains("Hr"))
                                {
                                    screenName = screenName.Replace("Hr", "");
                                }
                                if (screenName.Contains("Med"))
                                {
                                    screenName = screenName.Replace("Med", "Medicine ");
                                }
                                if (screenName.Contains("System"))
                                {
                                    screenName = screenName.Replace("System", "");
                                }
                                if (screenName.Contains("Sys"))
                                {
                                    screenName = screenName.Replace("Sys", "");
                                }
                                if (!screenName.Contains("Master") && !screenName.Contains("Base") && screenName != "Role Mapping")
                                {
                                    screenName = screenName + " Master";
                                }
                                screenName = InsertSpaceBeforeCapsAfterSecondIndex(screenName);
                                screenName = screenName.Trim();

                                bool isActive = ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName;
                                
                                <a href="@Url.Action(item.ActionName, item.ControllerName)"
                                   class="menu-tile @(isActive ? "active" : "")"
                                   title="@screenName" style="text-decoration: none !important; border-bottom: none !important;">
                                    <div class="menu-tile-icon">
                                        <i class="bi @iconClass"></i>
                                    </div>
                                    <span class="menu-tile-text">@screenName</span>
                                </a>
                            }
                        </div>
                    </li>
                }

                <!-- Transactions Menu -->
                @if (groupedMenus.ContainsKey("Transactions") && groupedMenus["Transactions"].Any())
                {

                    bool hasActiveItem = false;
                    if (groupedMenus.ContainsKey("Transactions"))
                    {
                        hasActiveItem = groupedMenus["Transactions"].Any(item =>
                        ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName);
                    }

                    <li class="nav-item dropdown @(hasActiveItem ? "has-active-item" : "")" ">
                        <a class="nav-link dropdown-toggle" href="#" id="transactionsDropdown" role="button">
                            <i class="bi bi-arrow-left-right"></i> Transactions
                        </a>
                        <div class="dropdown-menu mega-menu">
                            @foreach (var item in groupedMenus["Transactions"])
                            {
                                string screenName = item.ScreenName;
                                string iconClass = "bi-arrow-left-right"; // Default icon

                                // Icon assignment - BOOTSTRAP ICONS
                                if (screenName.Contains("Diagnosis")) iconClass = "bi-heart-pulse";
                                else if (screenName.Contains("Patient")) iconClass = "bi-person-plus";
                                else if (screenName.Contains("Prescription")) iconClass = "bi-prescription2";
                                else if (screenName.Contains("Billing")) iconClass = "bi-receipt";

                                // Process screen name
                                if (screenName.Contains("OthersDiagnosis"))
                                {
                                    screenName = screenName.Replace("OthersDiagnosis", "Doctor Diagnosis - Others");
                                }
                                if(@UserRole.Contains("Compounder") && screenName.Contains("Doctor"))
                                {
                                    screenName = screenName.Replace("Doctor", "Compounder");
                                }
                                
                                screenName = InsertSpaceBeforeCapsAfterSecondIndex(screenName);
                                if (screenName.Contains("Compounder"))
                                {
                                    screenName = screenName.Replace("Compounder", "Compounder/Pharmacist");
                                }
                                screenName = screenName.Trim();

                                bool isActive = ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName;

                                <a href="@Url.Action(item.ActionName, item.ControllerName)"
                                   class="menu-tile @(isActive ? "active" : "")"
                                   title="@screenName" style="text-decoration: none !important; border-bottom: none !important;">
                                    <div class="menu-tile-icon">
                                        <i class="bi @iconClass"></i>
                                    </div>
                                    <span class="menu-tile-text">@screenName</span>
                                </a>
                            }
                        </div>
                    </li>
                }

                <!-- Reports Menu -->
                @if (groupedMenus.ContainsKey("Reports") && groupedMenus["Reports"].Any())
                {

                    bool hasActiveItem = false;
                    if (groupedMenus.ContainsKey("Reports"))
                    {
                        hasActiveItem = groupedMenus["Reports"].Any(item =>
                        ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName);
                    }

                    <li class="nav-item dropdown @(hasActiveItem ? "has-active-item" : "")" ">
                        <a class="nav-link dropdown-toggle" href="#" id="reportsDropdown" role="button">
                            <i class="bi bi-bar-chart"></i> Reports
                        </a>
                        <div class="dropdown-menu mega-menu">
                            @foreach (var item in groupedMenus["Reports"])
                            {
                                string screenName = item.ScreenName;
                                string iconClass = "bi-graph-up"; // Default icon

                                // Icon assignment - BOOTSTRAP ICONS
                                if (screenName.Contains("Login")) iconClass = "bi-box-arrow-in-right";
                                else if (screenName.Contains("Medicine")) iconClass = "bi-capsule";
                                else if (screenName.Contains("Patient")) iconClass = "bi-person-plus";
                                else if (screenName.Contains("Summary")) iconClass = "bi-pie-chart";

                                
                                screenName = InsertSpaceBeforeCapsAfterSecondIndex(screenName);
                                if (screenName.Contains("Compounder"))
                                {
                                    screenName = screenName.Replace("Compounder", "Compounder/Pharmacist");
                                }
                                screenName = screenName.Trim();

                                bool isActive = ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName;

                                <a href="@Url.Action(item.ActionName, item.ControllerName)"
                                   class="menu-tile @(isActive ? "active" : "")"
                                   title="@screenName" style="text-decoration: none !important; border-bottom: none !important;">
                                    <div class="menu-tile-icon">
                                        <i class="bi @iconClass"></i>
                                    </div>
                                    <span class="menu-tile-text">@screenName</span>
                                </a>
                            }
                        </div>
                    </li>
                }

                <!-- AuditLog Menu -->
                @if (groupedMenus.ContainsKey("AuditLog") && groupedMenus["AuditLog"].Any())
                {
                    bool hasActiveItem = false;
                    if (groupedMenus.ContainsKey("AuditLog"))
                    {
                        hasActiveItem = groupedMenus["AuditLog"].Any(item =>
                        ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName);
                    }

                    <li class="nav-item dropdown @(hasActiveItem ? "has-active-item" : "")" ">

                        <a class="nav-link dropdown-toggle" href="#" id="auditLogDropdown" role="button">
                            <i class="bi bi-clock-history"></i> Audit Log
                        </a>
                        <div class="dropdown-menu mega-menu">
                            @foreach (var item in groupedMenus["AuditLog"])
                            {
                                string screenName = item.ScreenName;
                                string iconClass = "bi-clock-history"; // Default icon

                                // Icon assignment - BOOTSTRAP ICONS
                                if (screenName.Contains("User")) iconClass = "bi-person-check";
                                else if (screenName.Contains("System")) iconClass = "bi-server";
                                else if (screenName.Contains("Activity")) iconClass = "bi-list-check";

                                screenName = InsertSpaceBeforeCapsAfterSecondIndex(screenName);
                                screenName = screenName.Trim();

                                bool isActive = ViewContext.RouteData.Values["Controller"]?.ToString() == item.ControllerName;

                                <a href="@Url.Action(item.ActionName, item.ControllerName)"
                                   class="menu-tile @(isActive ? "active" : "")"
                                   title="@screenName" style="text-decoration: none !important; border-bottom: none !important;">
                                    <div class="menu-tile-icon">
                                        <i class="bi @iconClass"></i>
                                    </div>
                                    <span class="menu-tile-text">@screenName</span>
                                </a>
                            }
                        </div>
                    </li>
                }
           
            </ul>
        </div>
        <div class="d-flex align-items-center gap-2">
            

            <div class="user-info-section">
                <!-- User Avatar with Initial -->
                
                <div class="user-details">
                    <div class="user-details-top">
                        <span class="user-name" id="userName">@userName</span>
                        <span class="user-emp-id" id="userEmpId"></span>
                    </div>
                    <div class="user-details-bottom">
                        <span class="user-designation" id="userDesignation"></span>
                        <span class="user-divider">•</span>
                        <span class="user-plant" id="userPlant"> </span>
                    </div>
                </div>

                <!-- Dropdown Toggle for Menu -->
                <div class="dropdown">
                    <button class="user-dropdown-toggle" data-bs-toggle="dropdown">
                        <div class="user-avatar" id="userAvatar">
                            <span id="userInitial"></span>
                        </div>
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end user-dropdown-menu">
                        @if (User.Identity != null && User.Identity.IsAuthenticated)
                        {
                            <li class="user-welcome">
                                Welcome Back, @User.Identity.Name !
                                
                            </li>
                            
                            <li>
                                <form asp-controller="Account" asp-action="Logout" method="post" class="form-inline">
                                    <button type="submit" class="dropdown-item">
                                        <i class="bi bi-box-arrow-right"></i>
                                        Logout
                                    </button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <li>
                                <a class="dropdown-item" asp-controller="Account" asp-action="Login">
                                    <i class="bi bi-box-arrow-in-right"></i>
                                    Login
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>




        </div>
    </header>



    <!-- ===== Sidebar (mobile only) ===== -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Navigation</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0 sidebar">
            <nav class="px-2">
                <ul class="nav flex-column small">
                    <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="Index"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                    <li class="nav-item">
                        <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#mMenu">
                            <span><i class="bi bi-card-list me-2"></i>Masters</span><i class="bi bi-chevron-down small"></i>
                        </a>
                        <div class="collapse" id="mMenu">
                            <ul class="nav flex-column ms-3 my-1">
                                <li class="nav-item"><a class="nav-link" asp-controller="UserMaster" asp-action="Index">User Master</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="DoctorMaster" asp-action="Index">Doctor Master</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#rMenu">
                            <span><i class="bi bi-bar-chart me-2"></i>Reports</span><i class="bi bi-chevron-down small"></i>
                        </a>
                        <div class="collapse" id="rMenu">
                            <ul class="nav flex-column ms-3 my-1">
                                <li class="nav-item"><a class="nav-link" asp-controller="LoginReports" asp-action="Index">Login Reports</a></li>
                                <li class="nav-item"><a class="nav-link" asp-controller="MedicineIssueReports" asp-action="Index">Medicine Issue Reports</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- ===== Main Content ===== -->
    <main class="container-fluid">
        <div class="content-wrapper">
            @* <div class="glass p-4 shadow-sm">
                <h2 class="h4 mb-3">@ViewData["Title"]</h2>
            </div> *@
      
            @* <div class="glass p-4 shadow-sm">                *@
                @RenderBody()
            @* </div> *@
        </div>
    </main>

    @* <footer class="glass position-fixed bottom-0 start-50 translate-middle-x w-100">
        &copy; 2025 ITC Limited • Powered by GetAI
    </footer> *@

    <!-- JS -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/datatables/js/datatables.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
   
    <script>
        window.app = window.app || {};
        window.app.meUrl = '@Url.Action("Me", "UserInfo")';

        window.app.logout = '@Url.Action("LogoutView", "Account")';
        window.app.logoutUrl = '@Url.Action("LogoutView", "Account", new { reason = "UserLogout" })';
        window.app.timeoutUrl = '@Url.Action("LogoutView", "Account", new { reason = "SessionTimeout" })';
    </script>
    <script src="~/js/site.js"></script>



    @RenderSection("Scripts", required: false)
</body>
</html>

@* <script>
    function showAlert(type, message) {
        if (typeof toastr !== 'undefined') {
            toastr[type](message);
        } else {
            alert(message);
        }
    }
</script> *@
<script>
    setInterval(() => {
        fetch('@Url.Action("check", "session")', {
            method: 'GET',
            credentials: 'same-origin'
        }).then(res => {
            if (res.status === 401 || res.redirected) {
                console.log("Session invalidated. Redirecting...");

                 window.location.href = '@Url.Action("LogoutView", "Account", new { reason = "SessionExpired" })';
            }
        }).catch(err => {
            console.warn("Session check failed. Forcing logout.");

            window.location.href = '@Url.Action("LogoutView", "Account", new { reason = "SessionExpired" })';

        });
    }, 15000); // check every 15 seconds
</script>
<script>
    document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
    });
</script>

<script>
    if (localStorage.getItem("tabOpen")) {
        window.location.href = "@Url.Action("LogoutView", "Account")";
    } else {
        localStorage.setItem("tabOpen", "true");
        window.addEventListener("beforeunload", function () {
            localStorage.removeItem("tabOpen");
        });
    }
</script>
