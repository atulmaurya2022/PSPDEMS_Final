@{
    ViewData["Title"] = "User Master";
}

<!-- Include Master Common Styles -->
<link href="~/css/master-common.css" rel="stylesheet" />

<div class="master-container">
    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Enhanced Master Header -->
    <div class="master-header">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="flex-grow-1">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb breadcrumb-master">
                        <li class="breadcrumb-item">Home</li>
                        <li class="breadcrumb-item active" aria-current="page">User Master</li>
                    </ol>
                </nav>
                <h1 class="master-title">
                    <i class="bi bi-person-lines-fill"></i>
                    User Master
                </h1>
                <p class="master-subtitle">Manage system users and access controls</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="position-relative">
                    <input type="text" class="form-control" placeholder="Search users..." id="searchBox" style="min-width: 250px; padding-left: 40px !important;" />
                    <i class="bi bi-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                </div>
                <button id="btnCreate" class="btn btn-add-master">
                    <i class="bi bi-plus-lg"></i>
                    Add User Master
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced DataTable Container -->
    <div class="master-form">
        <div class="card-body p-0">
            <table id="tblUser" class="table table-striped table-glass glass-table mb-0">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>ADID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Plant</th>
                        <th>Status</th>
                        <th>Created On</th>
                        <th style="width:200px">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Enhanced User Master Modal -->
<div class="modal fade" id="modalUser" tabindex="-1" aria-labelledby="modalUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content modal-content-master">
            <div class="modal-header modal-header-master">
                <h5 class="modal-title modal-title-master" id="modalUserLabel">
                    <i class="bi bi-person-lines-fill"></i>
                    User Master
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-master" id="modalBody">
                <div class="loading-overlay">
                    <div class="loading-spinner-master"></div>
                    Loading...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audit Details Modal -->
<div class="modal fade" id="modalAuditDetails" tabindex="-1" aria-labelledby="modalAuditLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-master">
            <div class="modal-header modal-header-master">
                <h5 class="modal-title modal-title-master" id="modalAuditLabel">
                    <i class="bi bi-clock-history"></i>
                    Audit Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-master" id="modalAuditBody">
                <div class="loading-overlay">
                    <div class="loading-spinner-master"></div>
                    Loading audit information...
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // Enhanced Alert System
            function showAlert(type, message, title = null) {
                const alertContainer = document.getElementById('alertContainer');
                const alertId = 'alert-' + Date.now();

                const iconMap = {
                    success: 'bi-check-circle',
                    warning: 'bi-exclamation-triangle',
                    danger: 'bi-x-circle',
                    info: 'bi-info-circle'
                };

                const icon = iconMap[type] || 'bi-info-circle';
                const alertTitle = title || type.charAt(0).toUpperCase() + type.slice(1);

                const alertHtml = `
                    <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert"
                         style="border: none; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; font-weight: 500; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);">
                        <div class="d-flex align-items-start">
                            <i class="bi ${icon} me-3 flex-shrink-0" style="font-size: 18px;"></i>
                            <div class="flex-grow-1">
                                <strong class="d-block mb-1">${alertTitle}</strong>
                                ${message}
                            </div>
                            <button type="button" class="btn-close ms-3" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                alertContainer.insertAdjacentHTML('afterbegin', alertHtml);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    const alertElement = document.getElementById(alertId);
                    if (alertElement) {
                        const alert = bootstrap.Alert.getOrCreateInstance(alertElement);
                        alert.close();
                    }
                }, 5000);
            }

            // Modal setup
            const modalEl = $('#modalUser');
            const auditModalEl = $('#modalAuditDetails');

            modalEl.appendTo('body');
            auditModalEl.appendTo('body');

            modalEl.modal({ backdrop: 'static', keyboard: false, show: false });
            auditModalEl.modal({ backdrop: 'static', keyboard: false, show: false });

            // Function to truncate text with tooltip
            function truncateText(data, maxLength = 30) {
                if (!data) return 'N/A';
                if (data.length > maxLength) {
                    return `<span title="${data}" data-bs-toggle="tooltip">${data.substring(0, maxLength)}...</span>`;
                }
                return data;
            }

            // Function to format date
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                } catch (e) {
                    return 'N/A';
                }
            }

            // Enhanced DataTable
            const tbl = $('#tblUser').DataTable({
                ajax: {
                    url: '@Url.Action("LoadData")',
                    dataSrc: 'data',
                    error: function(xhr, error, code) {
                        console.error('DataTable error:', error);
                        if (xhr.status === 403) {
                            showAlert('danger', 'You do not have permission to view users from other plants.', 'Access Denied');
                        } else {
                            showAlert('danger', 'Failed to load user data. Please refresh the page.', 'Loading Error');
                        }
                    }
                },
                columns: [
                    {
                        data: 'user_id',
                        className: 'text-center',
                        width: '80px'
                    },
                    {
                        data: 'adid',
                        render: function(data) {
                            return data ? `<span class="badge bg-info" style="font-size: 11px;">${data}</span>` : '<em class="text-muted">N/A</em>';
                        }
                    },
                    {
                        data: 'full_name',
                        render: function(data) {
                            return truncateText(data, 25);
                        }
                    },
                    {
                        data: 'email',
                        render: function(data) {
                            return truncateText(data, 30);
                        }
                    },
                    {
                        data: 'role_name',
                        render: function(data) {
                            return data ? `<span class="badge bg-success" style="font-size: 11px;">${data}</span>` : '<em class="text-muted">No Role</em>';
                        }
                    },
                    {
                        data: 'plant_name',
                        render: function(data) {
                            return data ? `<span class="badge bg-primary" style="font-size: 11px;">${truncateText(data, 15)}</span>` : '<em class="text-muted">No Plant</em>';
                        }
                    },
                    {
                        data: 'is_active',
                        className: 'text-center',
                        render: function(data) {
                            return data ?
                                '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>' :
                                '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Inactive</span>';
                        }
                    },
                    {
                        data: 'createdOn',
                        title: 'Created On',
                        render: function(data) {
                            return formatDate(data);
                        }
                    },
                    {
                        data: null,
                        className: 'text-center',
                        orderable: false,
                        render: function(data, type, row) {
                            const id = row.user_id;
                            const hasAuditData = row.createdOn || row.modifiedOn;

                            let buttons = `
                                <button class="btn btn-action-view view me-1" data-id="${id}" title="View Details">
                                    <i class="bi bi-eye fs-6"></i>
                                </button>
                                <button class="btn btn-action-edit edit me-1" data-id="${id}" title="Edit">
                                    <i class="bi bi-pencil fs-6"></i>
                                </button>`;

                            // if (hasAuditData) {
                            //     buttons += `
                            //         <button class="btn btn-action-audit audit me-1" data-id="${id}" title="Audit Details">
                            //             <i class="bi bi-clock-history fs-6"></i>
                            //         </button>`;
                            // }

                            buttons += `
                                <button class="btn btn-action-delete delete" data-id="${id}" title="Delete">
                                    <i class="bi bi-trash fs-6"></i>
                                </button>`;

                            return buttons;
                        }
                    }
                ],
                pageLength: 25,
                responsive: true,
                language: {
                    emptyTable: '<div class="empty-state-master"><i class="bi bi-person-lines-fill"></i><h6>No Users Found</h6><p>No user records are available. Click "Add User Master" to create your first user.</p></div>',
                    processing: '<div class="loading-spinner-master"></div> Processing...',
                    loadingRecords: '<div class="loading-spinner-master"></div> Loading...',
                    zeroRecords: '<div class="empty-state-master"><i class="bi bi-search"></i><h6>No Results Found</h6><p>No users match your search criteria.</p></div>'
                },
                drawCallback: function() {
                    // Initialize tooltips
                    $('[data-bs-toggle="tooltip"]').tooltip();
                }
            });

            // Enhanced search functionality
            $('#searchBox').on('keyup', function() {
                tbl.search(this.value).draw();
            });



                    // === Init function for Create/Edit partial ===
        window.initOrgPlantForm = function () {
             // Form elements
            const form = $('#sysUserForm');
            const submitBtn = $('#submitBtn');
            const adidInput = $('#adidInput');
            const fullNameInput = $('#fullNameInput');
            const emailInput = $('#emailInput');
            const roleSelect = $('#roleSelect');
            const plantSelect = $('#plantSelect');
            const statusRadios = $('input[name="is_active"]');
            const userId = $('#user_id').val();

            // Character count elements
            const adidCharCount = $('#adidCharCount');
            const fullNameCharCount = $('#fullNameCharCount');
            const emailCharCount = $('#emailCharCount');

            // Validation flags
            let isCheckingEmail = false;
            let isCheckingAdid = false;

            // Initialize validation
            form.removeData("validator");
            form.removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse(form);

            // Security patterns to check for
            const dangerousPatterns = [
                /<script[^>]*>.*?<\/script>/gi,
                /javascript:/gi,
                /vbscript:/gi,
                /on\w+\s*=/gi,
                /<iframe/gi,
                /<object/gi,
                /<embed/gi,
                /<form/gi,
                /eval\s*\(/gi,
                /expression\s*\(/gi
            ];

            // Allowed email domains
            const allowedDomains = ['itc.in', 'associatemail.in'];

            // Function to check for dangerous input
            function containsDangerousInput(text) {
                if (!text) return false;
                return dangerousPatterns.some(pattern => pattern.test(text));
            }

            // Enhanced character count functions
            function updateCharCount(input, countElement, maxLength) {
                const currentLength = input.val().length;
                countElement.text(`${currentLength}/${maxLength}`);

                // Remove previous classes
                countElement.removeClass('text-warning text-danger');

                // Calculate thresholds
                const warningThreshold = Math.floor(maxLength * 0.8);

                if (currentLength >= maxLength) {
                    countElement.addClass('text-danger');
                } else if (currentLength >= warningThreshold) {
                    countElement.addClass('text-warning');
                }
            }

            // Enhanced validation functions
            function validateAdid() {
                const adid = adidInput.val().trim();
                const validationSpan = $('#adidValidation');
                let isValid = true;

                validationSpan.text('').removeClass('field-validation-error').hide();
                adidInput.removeClass('is-invalid is-valid');

                if (!adid) {
                    showFieldError(validationSpan, adidInput, 'ADID is required.');
                    isValid = false;
                } else if (adid.length < 2) {
                    showFieldError(validationSpan, adidInput, 'ADID must be at least 2 characters.');
                    isValid = false;
                } else if (adid.length > 15) {
                    showFieldError(validationSpan, adidInput, 'ADID cannot exceed 15 characters.');
                    isValid = false;
                } else if (containsDangerousInput(adid)) {
                    showFieldError(validationSpan, adidInput, 'ADID contains invalid characters. Script tags and unsafe characters are not allowed.');
                    isValid = false;
                } else if (!/^[pi0-9_]+$/i.test(adid)) {
                    showFieldError(validationSpan, adidInput, 'Only P, p, I, i, underscore (_) and digits are allowed.');
                    isValid = false;
                } else {
                    adidInput.addClass('is-valid');
                }

                return isValid;
            }

            function validateFullName() {
                const fullName = fullNameInput.val().trim();
                const validationSpan = $('#fullNameValidation');
                let isValid = true;

                validationSpan.text('').removeClass('field-validation-error').hide();
                fullNameInput.removeClass('is-invalid is-valid');

                if (!fullName) {
                    showFieldError(validationSpan, fullNameInput, 'Full Name is required.');
                    isValid = false;
                } else if (fullName.length < 2) {
                    showFieldError(validationSpan, fullNameInput, 'Full Name must be at least 2 characters.');
                    isValid = false;
                } else if (fullName.length > 80) {
                    showFieldError(validationSpan, fullNameInput, 'Full Name cannot exceed 80 characters.');
                    isValid = false;
                } else if (containsDangerousInput(fullName)) {
                    showFieldError(validationSpan, fullNameInput, 'Full Name contains invalid characters. Script tags and unsafe characters are not allowed.');
                    isValid = false;
                } else if (!/^[a-zA-Z\s\-\.]+$/.test(fullName)) {
                    showFieldError(validationSpan, fullNameInput, 'Full Name can only contain letters, spaces, hyphens, and dots.');
                    isValid = false;
                } else {
                    fullNameInput.addClass('is-valid');
                }

                return isValid;
            }

            function validateEmail() {
                const email = emailInput.val().trim().toLowerCase();
                const validationSpan = $('#emailValidation');
                let isValid = true;

                validationSpan.text('').removeClass('field-validation-error').hide();
                emailInput.removeClass('is-invalid is-valid');

                if (!email) {
                    showFieldError(validationSpan, emailInput, 'Email Address is required.');
                    isValid = false;
                } else if (email.length > 120) {
                    showFieldError(validationSpan, emailInput, 'Email Address cannot exceed 120 characters.');
                    isValid = false;
                } else if (containsDangerousInput(email)) {
                    showFieldError(validationSpan, emailInput, 'Email Address contains invalid characters. Script tags and unsafe characters are not allowed.');
                    isValid = false;
                } else if (!/^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(email)) {
                    showFieldError(validationSpan, emailInput, 'Please enter a valid email address.');
                    isValid = false;
                } else {
                    // Check domain validation
                    const domain = email.split('@@')[1];
                    if (!allowedDomains.includes(domain)) {
                        showFieldError(validationSpan, emailInput, 'Email domain must be @@itc.in or @@associatemail.in');
                        isValid = false;
                    } else {
                        emailInput.addClass('is-valid');
                    }
                }

                return isValid;
            }

            function validateRole() {
                const roleId = roleSelect.val();
                const validationSpan = $('#roleValidation');
                let isValid = true;

                validationSpan.text('').removeClass('field-validation-error').hide();
                roleSelect.removeClass('is-invalid is-valid');

                if (!roleId) {
                    showFieldError(validationSpan, roleSelect, 'Role selection is required.');
                    isValid = false;
                } else {
                    roleSelect.addClass('is-valid');
                }

                return isValid;
            }

            function validatePlant() {
                const plantId = plantSelect.val();
                const validationSpan = $('#plantValidation');
                let isValid = true;

                validationSpan.text('').removeClass('field-validation-error').hide();
                plantSelect.removeClass('is-invalid is-valid');

                if (!plantId) {
                    showFieldError(validationSpan, plantSelect, 'Plant selection is required.');
                    isValid = false;
                } else {
                    plantSelect.addClass('is-valid');
                }

                return isValid;
            }

            function validateStatus() {
                const isSelected = statusRadios.filter(':checked').length > 0;
                const validationSpan = $('#statusValidation');
                let isValid = true;

                validationSpan.text('').removeClass('field-validation-error').hide();

                if (!isSelected) {
                    validationSpan.text('User Status selection is required.')
                                 .addClass('field-validation-error')
                                 .show();
                    isValid = false;
                }

                return isValid;
            }

            function showFieldError(validationSpan, inputElement, message) {
                validationSpan.text(message)
                           .addClass('field-validation-error')
                           .show();
                inputElement.addClass('is-invalid');
            }

            // Real-time validation for email uniqueness
            function checkEmailUniqueness() {
                const email = emailInput.val().trim();
                const validationSpan = $('#emailValidation');

                if (!email || !validateEmail()) {
                    updateSubmitButton();
                    return;
                }

                if (isCheckingEmail) return;

                isCheckingEmail = true;
                submitBtn.prop('disabled', true);

                $.post('@Url.Action("CheckEmailExists", "SysUser")', {
                    email: email,
                    userId: userId || null
                })
                .done(function(response) {
                    if (response.exists) {
                        showFieldError(validationSpan, emailInput, 'A user with this email already exists. Please use a different email.');
                        submitBtn.prop('disabled', true);
                    } else {
                        if (validateEmail()) {
                            validationSpan.text('').removeClass('field-validation-error').hide();
                            emailInput.removeClass('is-invalid').addClass('is-valid');
                        }
                        updateSubmitButton();
                    }
                })
                .fail(function() {
                    console.log('Error checking email uniqueness');
                    updateSubmitButton();
                })
                .always(function() {
                    isCheckingEmail = false;
                });
            }

            // Real-time validation for ADID uniqueness
            function checkAdidUniqueness() {
                const adid = adidInput.val().trim();
                const validationSpan = $('#adidValidation');

                if (!adid || !validateAdid()) {
                    updateSubmitButton();
                    return;
                }

                if (isCheckingAdid) return;

                isCheckingAdid = true;
                submitBtn.prop('disabled', true);

                $.post('@Url.Action("CheckAdidExists", "SysUser")', {
                    adid: adid,
                    userId: userId || null
                })
                .done(function(response) {
                    if (response.exists) {
                        showFieldError(validationSpan, adidInput, 'A user with this ADID already exists. Please use a different ADID.');
                        submitBtn.prop('disabled', true);
                    } else {
                        if (validateAdid()) {
                            validationSpan.text('').removeClass('field-validation-error').hide();
                            adidInput.removeClass('is-invalid').addClass('is-valid');
                        }
                        updateSubmitButton();
                    }
                })
                .fail(function() {
                    console.log('Error checking ADID uniqueness');
                    updateSubmitButton();
                })
                .always(function() {
                    isCheckingAdid = false;
                });
            }

            function updateSubmitButton() {
                const hasErrors = $('.field-validation-error:visible').length > 0 ||
                                $('.is-invalid').length > 0 ||
                                isCheckingEmail ||
                                isCheckingAdid;
                submitBtn.prop('disabled', hasErrors);
            }

            // Real-time character counting and validation
            adidInput.on('input paste keyup', function() {
                setTimeout(() => {
                    updateCharCount($(this), adidCharCount, 15);
                    validateAdid();
                    updateSubmitButton();
                }, 10);
            });

            fullNameInput.on('input paste keyup', function() {
                setTimeout(() => {
                    updateCharCount($(this), fullNameCharCount, 80);
                    validateFullName();
                    updateSubmitButton();
                }, 10);
            });

            emailInput.on('input paste keyup', function() {
                setTimeout(() => {
                    updateCharCount($(this), emailCharCount, 120);
                    validateEmail();
                    updateSubmitButton();
                }, 10);
            });

            roleSelect.on('change', function() {
                validateRole();
                updateSubmitButton();
            });

            plantSelect.on('change', function() {
                validatePlant();
                updateSubmitButton();
            });

            statusRadios.on('change', function() {
                validateStatus();
                updateSubmitButton();
            });

            // Debounced uniqueness checks
            let emailCheckTimeout;
            emailInput.on('input keyup', function() {
                clearTimeout(emailCheckTimeout);
                emailCheckTimeout = setTimeout(checkEmailUniqueness, 500);
            });

            let adidCheckTimeout;
            adidInput.on('input keyup', function() {
                clearTimeout(adidCheckTimeout);
                adidCheckTimeout = setTimeout(checkAdidUniqueness, 500);
            });

            // Initialize on page load
            updateCharCount(adidInput, adidCharCount, 15);
            updateCharCount(fullNameInput, fullNameCharCount, 80);
            updateCharCount(emailInput, emailCharCount, 120);
            validateAdid();
            validateFullName();
            validateEmail();
            validateRole();
            validatePlant();
            validateStatus();
            updateSubmitButton();

            // Prevent form submission if validation fails
            form.on('submit', function(e) {
                if (!validateAdid() || !validateFullName() || !validateEmail() ||
                    !validateRole() || !validatePlant() || !validateStatus() ||
                    isCheckingEmail || isCheckingAdid) {
                    e.preventDefault();
                    return false;
                }

                // Final check for any visible errors
                if ($('.field-validation-error:visible').length > 0) {
                    e.preventDefault();
                    return false;
                }

                // Double-check for dangerous input before submission
                const adid = adidInput.val().trim();
                const fullName = fullNameInput.val().trim();
                const email = emailInput.val().trim();

                if (containsDangerousInput(adid) || containsDangerousInput(fullName) || containsDangerousInput(email)) {
                    e.preventDefault();
                    alert('Invalid input detected. Please remove any script tags or unsafe characters.');
                    return false;
                }

                // Final domain check
                const emailDomain = email.split('@@')[1];
                if (email && !allowedDomains.includes(emailDomain.toLowerCase())) {
                    e.preventDefault();
                    alert('Email domain must be @@itc.in or @@associatemail.in');
                    return false;
                }
            });

            // Prevent pasting of dangerous content
            function handleDangerousPaste(input, inputName) {
                input.on('paste', function(e) {
                    setTimeout(function() {
                        const pastedContent = input.val();
                        if (containsDangerousInput(pastedContent)) {
                            input.val('');
                            alert('Pasted content in ' + inputName + ' contains unsafe characters and has been removed.');
                        }
                    }, 10);
                });
            }

            handleDangerousPaste(adidInput, 'ADID');
            handleDangerousPaste(fullNameInput, 'Full Name');
            handleDangerousPaste(emailInput, 'Email Address');
        };






            // Open Create Modal
            $('#btnCreate').click(function() {
                showModalLoading('Add User Master', '<i class="bi bi-plus-lg"></i>');

                $.get('@Url.Action("Create")')
                    .done(function(html) {
                        $('#modalBody').html(html);
                        modalEl.modal('show');
                        window.initOrgPlantForm();   // << init counters + validation here

                    })
                    .fail(function(xhr) {
                        if (xhr.status === 403) {
                            showAlert('danger', 'You do not have permission to create users.', 'Access Denied');
                        } else {
                            showAlert('danger', 'Failed to load create form. Please try again.', 'Loading Error');
                        }
                        modalEl.modal('hide');
                    });
            });

            // Open Edit Modal
            $('#tblUser').on('click', '.edit', function () {
                const id = $(this).data('id');
                showModalLoading('Edit User Master', '<i class="bi bi-pencil"></i>');

                $.get('@Url.Action("Edit")', { id: id })
                    .done(function(html) {
                        $('#modalBody').html(html);
                        modalEl.modal('show');
                        window.initOrgPlantForm();   // << init counters + validation here

                    })
                    .fail(function(xhr) {
                        if (xhr.status === 404) {
                            showAlert('danger', 'User not found.', 'Not Found');
                        } else if (xhr.status === 403) {
                            showAlert('danger', 'You do not have permission to edit this user.', 'Access Denied');
                        } else {
                            showAlert('danger', 'Failed to load edit form. Please try again.', 'Loading Error');
                        }
                        modalEl.modal('hide');
                    });
            });

            // View Modal
            $('#tblUser').on('click', '.view', function (e) {
                e.stopPropagation();
                const id = $(this).data('id');
                showModalLoading('View User Master', '<i class="bi bi-eye"></i>');

                $.get('@Url.Action("Details")', { id: id })
                    .done(function(html) {
                        $('#modalBody').html(html);
                        modalEl.modal('show');
                    })
                    .fail(function(xhr) {
                        if (xhr.status === 404) {
                            showAlert('danger', 'User not found.', 'Not Found');
                        } else if (xhr.status === 403) {
                            showAlert('danger', 'You do not have permission to view this user.', 'Access Denied');
                        } else {
                            showAlert('danger', 'Failed to load user details. Please try again.', 'Loading Error');
                        }
                        modalEl.modal('hide');
                    });
            });

            // Audit Details Modal
            $('#tblUser').on('click', '.audit', function (e) {
                e.stopPropagation();
                const id = $(this).data('id');
                showAuditModalLoading();

                $.get(`@Url.Action("AuditDetails")/${id}`)
                    .done(function(html) {
                        $('#modalAuditBody').html(html);
                        auditModalEl.modal('show');
                    })
                    .fail(function() {
                        showAlert('danger', 'Failed to load audit details. Please try again.', 'Loading Error');
                        auditModalEl.modal('hide');
                    });
            });

            // Submit Form (Create/Edit)
            modalEl.on('submit', 'form', function (e) {
                e.preventDefault();
                const form = $(this);
                const submitBtn = form.find('[type="submit"]');
                const originalText = submitBtn.html();

                // Show loading state
                submitBtn.prop('disabled', true).html('<div class="loading-spinner-master"></div> Saving...');

                $.post(form.attr('action'), form.serialize())
                    .done(function(res) {
                        if (res.success) {
                            modalEl.modal('hide');
                            tbl.ajax.reload(null, false);
                            const isCreate = form.attr('action').includes('Create');
                            showAlert('success',
                                isCreate ? 'User Master created successfully.' : 'User Master updated successfully.',
                                'Success'
                            );
                        } else {
                            $('#modalBody').html(res);
                        }
                    })
                    .fail(function(xhr) {
                        if (xhr.status === 403) {
                            showAlert('danger', 'You do not have permission to perform this action.', 'Access Denied');
                        } else {
                            showAlert('danger', 'Failed to save user. Please try again.', 'Save Error');
                        }
                    })
                    .always(function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    });
            });

            // Enhanced Delete with confirmation
            $('#tblUser').on('click', '.delete', function (e) {
                e.stopPropagation();
                const id = $(this).data('id');
                const row = tbl.row($(this).closest('tr')).data();
                const userName = row ? row.full_name : 'this user';

                if (!confirm(`Are you sure you want to delete "${userName}"?\n\nThis action cannot be undone.`)) {
                    return;
                }

                const deleteBtn = $(this);
                const originalText = deleteBtn.html();
                deleteBtn.prop('disabled', true).html('<div class="loading-spinner-master"></div>');

                $.post('@Url.Action("Delete")', { id: id })
                    .done(function(response) {
                        if (response.success) {
                            tbl.ajax.reload(null, false);
                            showAlert('warning', `User Master "${userName}" has been deleted.`, 'Deleted');
                        } else {
                            showAlert('danger', response.message || 'Failed to delete user.', 'Delete Error');
                        }
                    })
                    .fail(function(xhr) {
                        if (xhr.status === 403) {
                            showAlert('danger', 'You do not have permission to delete this user.', 'Access Denied');
                        } else {
                            showAlert('danger', 'Failed to delete user. Please try again.', 'Delete Error');
                        }
                    })
                    .always(function() {
                        deleteBtn.prop('disabled', false).html(originalText);
                    });
            });

            // Helper functions
            function showModalLoading(title, icon) {
                modalEl.find('.modal-title').html(icon + ' ' + title);
                $('#modalBody').html(`
                    <div class="loading-overlay">
                        <div class="loading-spinner-master"></div>
                        Loading...
                    </div>
                `);
                modalEl.modal('show');
            }

            function showAuditModalLoading() {
                $('#modalAuditBody').html(`
                    <div class="loading-overlay">
                        <div class="loading-spinner-master"></div>
                        Loading audit information...
                    </div>
                `);
                auditModalEl.modal('show');
            }

            // Clear search on page load
            $('#searchBox').val('');
        });
    </script>
}