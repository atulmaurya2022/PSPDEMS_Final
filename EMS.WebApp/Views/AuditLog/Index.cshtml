@{
    ViewData["Title"] = "Audit Log";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="tableFilter">Table:</label>
                        <select id="tableFilter" class="form-control">
                            <option value="">All Tables</option>
                            @foreach (var table in ViewBag.TableNames as SelectList)
                            {
                                <option value="@table.Value">@table.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="actionFilter">Action:</label>
                        <select id="actionFilter" class="form-control">
                            <option value="">All Actions</option>
                            @foreach (var action in ViewBag.ActionTypes as SelectList)
                            {
                                <option value="@action.Value">@action.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label>&nbsp;</label><br>
                        <button id="btnFilter" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button id="btnClear" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button id="btnExport" class="btn btn-success">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="table-responsive">
                    <table id="auditLogTable" class="table table-striped table-glass glass-table">
                        <thead >
                            <tr>
                                <th>ID</th>
                                <th>Modules</th>
                                <th>Action</th>
                                <th>UID</th>
                                <th>User</th>
                                @* <th>IP Address</th> *@
                                <th>Timestamp</th>
                                @* <th>Controller/Action</th> *@
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal - FIXED VERSION -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Audit Log Details</h5>
                <!-- Bootstrap 5 version -->
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                <!-- OR Bootstrap 4 version -->
                <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button> -->
            </div>
            <div class="modal-body" id="detailsModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>

<!-- Entity History Modal - FIXED VERSION -->
<div class="modal fade" id="historyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entity History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

            </div>
            <div class="modal-body" id="historyModalBody">
                <!-- Content loaded via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-backdrop {
        z-index: -1;
    }
</style>
@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            var table = $('#auditLogTable').DataTable({
                
                   ajax: { url: '@Url.Action("LoadData")', dataSrc: 'data' },
                    columns: [
                    { "data": "auditId", "width": "5%" },
                    { "data": "tableName", "width": "12%" },
                    {
                        "data": "actionType",
                        "width": "8%",
                    },
                    { "data": "recordId", "width": "8%" },
                    { "data": "userName", "width": "12%" },
                    // { "data": "ipAddress", "width": "10%" },
                    {
                        "data": "timestamp",
                        "width": "15%",
                        "render": function (data) {
                            return new Date(data).toLocaleString();
                        }
                    },
                    // { "data": "controllerAction", "width": "15%" },
                    {
                        "data": null,
                        "width": "15%",
                        "orderable": false,
                        "render": function (data, type, row) {
                            var buttons = '<div class="btn-group" role="group">';
                            buttons += '<button class="btn btn-sm btn-info view-details" data-id="' + row.auditId + '" title="View Details">View Details</button>';
                            buttons += '<button class="btn btn-sm btn-secondary view-history" data-table="' + row.tableName + '" data-record="' + row.recordId + '" title="View History">View History</button>';
                            buttons += '</div>';
                            return buttons;
                        }
                    }]
               
            });

            // Filter button click
            $('#btnFilter').click(function () {
                table.ajax.reload();
            });

            // Clear filters
            $('#btnClear').click(function () {
                $('#tableFilter').val('');
                $('#actionFilter').val('');
                $('#startDate').val('');
                $('#endDate').val('');
                table.ajax.reload();
            });

            // Export button
            $('#btnExport').click(function () {
                var params = new URLSearchParams();
                if ($('#tableFilter').val()) params.append('tableName', $('#tableFilter').val());
                if ($('#actionFilter').val()) params.append('actionType', $('#actionFilter').val());
                if ($('#startDate').val()) params.append('startDate', $('#startDate').val());
                if ($('#endDate').val()) params.append('endDate', $('#endDate').val());

                window.open('@Url.Action("ExportCsv", "AuditLog")?' + params.toString());
            });

            // View details
            $(document).on('click', '.view-details', function () {
                var auditId = $(this).data('id');
                $.get('@Url.Action("Details", "AuditLog")/' + auditId)
                    .done(function (data) {
                        $('#detailsModalBody').html(data);
                        $('#detailsModal').modal('show');
                    })
                    .fail(function () {
                        alert('Error loading audit details.');
                    });
            });

            // View history
            $(document).on('click', '.view-history', function () {
                var tableName = $(this).data('table');
                var recordId = $(this).data('record');
                $.get('@Url.Action("EntityHistory", "AuditLog")', { tableName: tableName, recordId: recordId })
                    .done(function (data) {
                        $('#historyModalBody').html(data);
                        $('#historyModal').modal('show');
                    })
                    .fail(function () {
                        alert('Error loading entity history.');
                    });
            });

            // Auto-refresh every 30 seconds
            setInterval(function () {
                table.ajax.reload(null, false);
            }, 30000);
        });
    </script>
}

