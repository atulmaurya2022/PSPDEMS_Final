@model EMS.WebApp.Data.StoreIndent

@{
    bool isStoreInventory = Model.Status == "Approved";
}

<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Indent ID</label>
        <input class="form-control rounded-2" value="@Model.IndentId" readonly />
    </div>

    <div class="col-md-4">
        <label class="form-label">Indent Type</label>
        <input class="form-control rounded-2" value="@Model.IndentType" readonly />
    </div>

    <div class="col-md-4">
        <label class="form-label">Status</label>
        <div class="form-control rounded-2 border-0 d-flex align-items-center">
            @{
                var statusClass = Model.Status switch
                {
                    "Draft" => "bg-secondary",
                    "Pending" => "bg-warning",
                    "Approved" => "bg-success",
                    "Rejected" => "bg-danger",
                    _ => "bg-secondary"
                };
                var statusIcon = Model.Status switch
                {
                    "Draft" => "bi-file-text",
                    "Pending" => "bi-clock",
                    "Approved" => "bi-check-circle",
                    "Rejected" => "bi-x-circle",
                    _ => "bi-question-circle"
                };
            }
            <span class="badge @statusClass">
                <i class="@statusIcon me-1"></i>@Model.Status
            </span>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Indent Raised Date</label>
        <input class="form-control rounded-2" value="@Model.IndentDate.ToString("dd/MM/yyyy")" readonly />
    </div>

    <div class="col-md-4">
        <label class="form-label">Created Date</label>
        <input class="form-control rounded-2" value="@Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")" readonly />
    </div>
    <div class="col-md-4">
        <label class="form-label">Created By</label>
        <input class="form-control rounded-2" value="@(Model.CreatedBy ?? "N/A")" readonly />
    </div>
</div>

@if (Model.Status == "Draft")
{
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Draft Status:</strong> This indent is still in draft mode. The creator can continue editing and submit it when ready.
            </div>
        </div>
    </div>
}

@if (Model.Status != "Pending" && Model.Status != "Draft")
{
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">@(Model.Status == "Approved" ? "Approved By" : "Rejected By")</label>
            <input class="form-control rounded-2" value="@(Model.ApprovedBy ?? "N/A")" readonly />
        </div>
        <div class="col-md-4">
            <label class="form-label">@(Model.Status == "Approved" ? "Approved Date" : "Rejected Date")</label>
            <input class="form-control rounded-2" value="@(Model.ApprovedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")" readonly />
        </div>
        <div class="col-md-4"></div>
    </div>

    @if (!string.IsNullOrEmpty(Model.Comments))
    {
        <div class="row mb-3">
            <div class="col-12">
                <label class="form-label">@(Model.Status == "Approved" ? "Approval" : "Rejection") Comments</label>
                <div class="alert @(Model.Status == "Approved" ? "alert-success" : "alert-danger") mb-0">
                    <i class="bi @(Model.Status == "Approved" ? "bi-check-circle" : "bi-x-circle") me-2"></i>
                    @Model.Comments
                </div>
            </div>
        </div>
    }
}

@if (Model.StoreIndentItems?.Any() == true)
{
    <div class="row mb-3">
        <div class="col-12">
            <label class="form-label"><strong>Medicines (@Model.StoreIndentItems.Count() items)</strong></label>
            <div class="table-responsive">
                <table class="table table-striped table-glass glass-table w-100 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width:50px">Sl.</th>
                            <th style="width:120px">Medicine Name</th>
                            <th style="width:120px">Company Name</th>
                            <th style="width:120px">Vendor Code</th>
                            <th style="width:80px">Raised Qty</th>
                            <th style="width:80px">Pending Qty</th>
                            @if (isStoreInventory)
                            {
                                <th style="width:100px">Unit Price</th>
                                <th style="width:120px">Total Amount</th>
                                <th style="width:80px">Remark</th>
                            }
                            <th style="width:120px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.StoreIndentItems.Count; i++)
                        {
                            var item = Model.StoreIndentItems.ElementAt(i);
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@item.MedMaster?.MedItemName</td>
                                <td>@(item.MedMaster?.CompanyName ?? "Not Defined")</td>
                                <td>@(item.VendorCode ?? "N/A")</td>
                                <td class="text-center">@item.RaisedQuantity</td>
                                <td class="text-center">
                                    <span class="badge @(item.PendingQuantity > 0 ? "bg-warning" : "bg-success")">
                                        @item.PendingQuantity
                                    </span>
                                </td>
                                @if (isStoreInventory)
                                {
                                    <td class="text-center">
                                        <span class="fw-semibold text-primary">
                                            @(item.UnitPrice.HasValue ? $"₹{item.UnitPrice.Value:F2}" : "Not Available")
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="fw-semibold text-success">
                                            @(item.TotalAmount.HasValue ? $"₹{item.TotalAmount.Value:F2}" : "Not Available")
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        @item.Remark
                                    </td>
                                }
                                <td>
                                    @if (item.ReceivedQuantity > 0)
                                    {
                                        <button type="button"
                                                class="btn btn-sm btn-info view-batches-btn"
                                                data-indent-item-id="@item.IndentItemId"
                                                data-med-name="@item.MedMaster?.MedItemName"
                                                data-received-qty="@item.ReceivedQuantity"
                                                title="View Batch Details">
                                            <i class="bi bi-eye"></i> View Batches
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No Batches</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                    @if (isStoreInventory && Model.StoreIndentItems.Any(i => i.UnitPrice.HasValue && i.UnitPrice.Value > 0))
                    {
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="@(isStoreInventory ? "7" : "5")" class="text-end"><strong>Grand Total:</strong></th>
                                <th class="text-center">
                                    <span class="fw-bold text-success fs-5">
                                        ₹@(Model.StoreIndentItems.Where(i => i.TotalAmount.HasValue).Sum(i => i.TotalAmount.Value).ToString("F2"))
                                    </span>
                                </th>
                                <th></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    }
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="row mb-3">
        <div class="col-12">
            <label class="form-label"><strong>Medicines</strong></label>
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-2"></i>No medicines have been added to this indent yet.
            </div>
        </div>
    </div>
}

<div class="text-end">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>


<!-- Enhanced View Batches Modal with Available Stock -->
<div id="batchViewModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-boxes me-2"></i>Batch Details for <span id="viewModalMedName" class="text-primary"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Medicine Name:</strong></label>
                            <span id="viewModalMedicineDisplay" class="form-control-plaintext"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Total Received Quantity:</strong></label>
                            <span id="viewModalReceivedQty" class="form-control-plaintext text-success fw-bold"></span>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Summary Cards -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center py-2">
                                <h6 class="card-title mb-1"><i class="bi bi-box-seam me-1"></i>Total Received</h6>
                                <h4 class="mb-0" id="viewTotalReceived">0</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <h6 class="card-title mb-1"><i class="bi bi-check-circle me-1"></i>Available Stock</h6>
                                <h4 class="mb-0" id="viewTotalAvailable">0</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center py-2">
                                <h6 class="card-title mb-1"><i class="bi bi-arrow-down-circle me-1"></i>Consumed Stock</h6>
                                <h4 class="mb-0" id="viewTotalConsumed">0</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center py-2">
                                <h6 class="card-title mb-1"><i class="bi bi-graph-up me-1"></i>Stock Status</h6>
                                <h6 class="mb-0" id="viewOverallStatus">-</h6>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Detailed Batch Information:</strong></label>
                </div>

                <!-- Loading indicator -->
                <div id="batchLoadingIndicator" class="text-center py-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading batches...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading batch details...</p>
                </div>

                <!-- Enhanced Batch table -->
                <div id="batchTableContainer">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="viewBatchTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 8%">Sl.</th>
                                    <th style="width: 18%">Batch No</th>
                                    <th style="width: 15%">Expiry Date</th>
                                    <th style="width: 12%">Received Qty</th>
                                    <th style="width: 12%">Available Stock</th>
                                    <th style="width: 10%">Vendor Code</th>
                                </tr>
                            </thead>
                            <tbody id="viewBatchTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="3" class="text-end">Totals:</th>
                                    <th id="footerTotalReceived" class="text-center fw-bold">0</th>
                                    <th id="footerTotalAvailable" class="text-center fw-bold">0</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- No batches message -->
                <div id="noBatchesMessage" class="alert alert-info text-center" style="display: none;">
                    <i class="bi bi-info-circle me-2"></i>No batch information available for this medicine.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Reason Modal for Store Inventory -->
<div class="modal fade" id="editReasonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Medicine Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="card-body">
                    <form id="editReasonForm">
                        <input type="hidden" id="editItemId" />

                        <!-- Medicine Details (Read-only) -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Medicine Name</label>
                                <input type="text" class="form-control" id="editMedicineName" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="editCompanyName" readonly />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Vendor Code</label>
                                <input type="text" class="form-control" id="editVendorCode" readonly />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Raised Qty</label>
                                <input type="number" class="form-control" id="editRaisedQty" readonly />
                            </div>
                        </div>

                        <!-- Editable Fields -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Received Qty</label>
                                <input type="number" class="form-control" id="editReceivedQty" min="0" />
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Unit Price</label>
                                <input type="number" class="form-control" id="editUnitPrice" min="0" step="0.01" />
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total Amount</label>
                                <input type="text" class="form-control" id="editTotalAmount" readonly />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Batch No</label>
                                <input type="text" class="form-control" id="editBatchNo" maxlength="50" />
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Expiry Date</label>
                                <input type="date" class="form-control" id="editExpiryDate" />
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Reason for Edit -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Reason for Edit <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="editReason" rows="3"
                                          placeholder="Please provide a reason for editing this item..." required></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditChanges">
                    <i class="bi bi-check-circle me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function($) {
        'use strict';

        $(document).ready(function() {
            // Initialize namespace for View module
            window.ViewModule = window.ViewModule || {};
            var module = window.ViewModule;

            module.isStoreInventory = @(isStoreInventory ? "true" : "false");

            // Function to validate expiry date - prevents past dates
            function validateModalExpiryDate(inputElement) {
                var $input = $(inputElement);
                var expiryDateValue = $input.val();

                if (expiryDateValue) {
                    var expiryDate = new Date(expiryDateValue);
                    var today = new Date();
                    today.setHours(0, 0, 0, 0);
                    expiryDate.setHours(0, 0, 0, 0);

                    if (expiryDate < today) {
                        $input.addClass('is-invalid');
                        $input.siblings('.invalid-feedback').text('Expiry date cannot be in the past.');
                        return false;
                    } else {
                        $input.removeClass('is-invalid');
                        $input.siblings('.invalid-feedback').text('');
                        return true;
                    }
                }
                return true;
            }

            // Function to validate inline expiry date editing
            function validateInlineExpiryDate(inputElement) {
                var $input = $(inputElement);
                var expiryDateValue = $input.val();

                if (expiryDateValue) {
                    var expiryDate = new Date(expiryDateValue);
                    var today = new Date();
                    today.setHours(0, 0, 0, 0);
                    expiryDate.setHours(0, 0, 0, 0);

                    if (expiryDate < today) {
                        $input.addClass('is-invalid');
                        $input.siblings('.invalid-feedback').text('Expiry date cannot be in the past.');
                        return false;
                    } else {
                        $input.removeClass('is-invalid');
                        $input.siblings('.invalid-feedback').text('');
                        return true;
                    }
                }
                return true;
            }

            // Enhanced View Batches functionality
            $(document).on('click', '.view-batches-btn', function() {
                var indentItemId = $(this).data('indent-item-id');
                var medName = $(this).data('med-name');
                var receivedQty = $(this).data('received-qty');

                openViewBatchModal(indentItemId, medName, receivedQty);
            });

            function openViewBatchModal(indentItemId, medName, receivedQty) {
                $('#viewModalMedName').text(medName);
                $('#viewModalMedicineDisplay').text(medName);
                $('#viewModalReceivedQty').text(receivedQty);

                $('#batchViewModal').modal('show');

                $('#batchLoadingIndicator').show();
                $('#batchTableContainer').hide();
                $('#noBatchesMessage').hide();

                // Reset summary cards
                resetSummaryCards();

                $('#viewBatchTableBody').empty();
                $('#footerTotalReceived').text('0');
                $('#footerTotalAvailable').text('0');
                $('#footerTotalConsumed').text('0');

                $.get('@Url.Action("GetBatchesForMedicine", "StoreIndent")', { indentItemId: indentItemId })
                    .done(function(response) {
                        if (response.success) {
                            var batches = response.data || [];
                            renderViewBatchTable(batches);
                        } else {
                            showNoBatchesMessage();
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Failed to load batch data:', status, error);
                        showNoBatchesMessage();
                    })
                    .always(function() {
                        $('#batchLoadingIndicator').hide();
                    });
            }

            function resetSummaryCards() {
                $('#viewTotalReceived').text('0');
                $('#viewTotalAvailable').text('0');
                $('#viewTotalConsumed').text('0');
                $('#viewOverallStatus').text('-');
                $('#viewOverallStatus').closest('.card').removeClass('bg-danger bg-warning bg-success').addClass('bg-info');
            }

            function renderViewBatchTable(batches) {
                var tbody = $('#viewBatchTableBody');
                tbody.empty();

                if (!batches || batches.length === 0) {
                    showNoBatchesMessage();
                    return;
                }

                var totalReceived = 0;
                var totalAvailable = 0;
                var totalConsumed = 0;

                batches.forEach(function(batch, index) {
                    var expiryDate = batch.expiryDate ?
                        new Date(batch.expiryDate).toLocaleDateString('en-GB') :
                        'Not Set';

                    var receivedQty = batch.receivedQuantity || 0;
                    var availableStock = batch.availableStock || 0;
                    var consumedStock = receivedQty - availableStock;

                    // Calculate totals
                    totalReceived += receivedQty;
                    totalAvailable += availableStock;
                    totalConsumed += consumedStock;

                    // Determine stock status and styling
                    var stockStatus = '';
                    var stockStatusClass = '';
                    var stockStatusIcon = '';

                    if (availableStock === 0) {
                        stockStatus = 'Out of Stock';
                        stockStatusClass = 'badge bg-danger';
                        stockStatusIcon = '<i class="bi bi-x-circle me-1"></i>';
                    } else if (availableStock <= (receivedQty * 0.2)) {
                        stockStatus = 'Low Stock';
                        stockStatusClass = 'badge bg-warning text-dark';
                        stockStatusIcon = '<i class="bi bi-exclamation-triangle me-1"></i>';
                    } else {
                        stockStatus = 'In Stock';
                        stockStatusClass = 'badge bg-success';
                        stockStatusIcon = '<i class="bi bi-check-circle me-1"></i>';
                    }

                    // Expiry date styling
                    var isExpiringSoon = batch.expiryDate &&
                        new Date(batch.expiryDate) <= new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);

                    var isExpired = batch.expiryDate &&
                        new Date(batch.expiryDate) < new Date();

                    var expiryClass = '';
                    var expiryIcon = '';

                    if (isExpired) {
                        expiryClass = 'text-danger fw-bold';
                        expiryIcon = '<i class="bi bi-exclamation-triangle-fill me-1"></i>';
                    } else if (isExpiringSoon) {
                        expiryClass = 'text-warning fw-bold';
                        expiryIcon = '<i class="bi bi-exclamation-triangle me-1"></i>';
                    }

                    var row = `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>
                                <strong>${batch.batchNo || 'Not Set'}</strong>
                            </td>
                            <td class="${expiryClass}">
                                ${expiryIcon}${expiryDate}
                            </td>
                            <td class="text-center">
                                <span class="badge bg-primary">${receivedQty}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-success">${availableStock}</span>
                            </td>
                            <td>${batch.vendorCode || 'Not Set'}</td>
                        </tr>
                    `;

                    tbody.append(row);
                });

                // Update footer totals
                $('#footerTotalReceived').text(totalReceived);
                $('#footerTotalAvailable').text(totalAvailable);

                // Update summary cards
                $('#viewTotalReceived').text(totalReceived);
                $('#viewTotalAvailable').text(totalAvailable);
                $('#viewTotalConsumed').text(totalConsumed);

                // Update overall status
                var overallStatus = '';
                var overallClass = '';
                if (totalAvailable === 0) {
                    overallStatus = 'Out of Stock';
                    overallClass = 'bg-danger';
                } else if (totalAvailable <= (totalReceived * 0.2)) {
                    overallStatus = 'Low Stock';
                    overallClass = 'bg-warning';
                } else {
                    overallStatus = 'Good Stock';
                    overallClass = 'bg-success';
                }

                var statusCard = $('#viewOverallStatus').closest('.card');
                statusCard.removeClass('bg-danger bg-warning bg-success bg-info').addClass(overallClass);
                $('#viewOverallStatus').text(overallStatus);

                $('#batchTableContainer').show();
            }

            function showNoBatchesMessage() {
                $('#batchTableContainer').hide();
                $('#noBatchesMessage').show();
                resetSummaryCards();
            }

            // Auto-calculate total amount in edit reason modal
            $('#editReceivedQty, #editUnitPrice').on('input', function() {
                var receivedQty = parseFloat($('#editReceivedQty').val()) || 0;
                var unitPrice = parseFloat($('#editUnitPrice').val()) || 0;
                var totalAmount = receivedQty * unitPrice;
                $('#editTotalAmount').val(totalAmount > 0 ? `₹${totalAmount.toFixed(2)}` : '₹0.00');
            });

            // Handle edit medicine item inline (normal edit)
            $(document).on('click', '.edit-medicine-inline', function() {
                var itemId = $(this).data('id');
                var row = $(this).closest('tr');

                convertRowToEditMode(row, itemId);
            });

            // Handle edit medicine with reason (for fully received items)
            $(document).on('click', '.edit-medicine-with-reason', function() {
                var itemId = $(this).data('id');
                var row = $(this).closest('tr');

                showEditReasonModal(row, itemId);
            });

            function showEditReasonModal(row, itemId) {
                console.log('showEditReasonModal called with itemId:', itemId);

                var medicineName = row.find('td:eq(1)').text().trim();
                var companyName = row.find('td:eq(2)').text().trim();
                var vendorCode = row.find('td:eq(3)').text().trim();
                var raisedQty = parseInt(row.find('td:eq(4)').text()) || 0;
                var currentReceivedQty = parseInt(row.find('td:eq(5)').text()) || 0;

                // Get unit price and total amount if available (for store inventory)
                var currentUnitPrice = 0;
                var currentTotalAmount = 0;
                if (module.isStoreInventory) {
                    var unitPriceText = row.find('td:eq(6)').text().replace('₹', '').replace(',', '').trim();
                    currentUnitPrice = unitPriceText === '0.00' ? 0 : parseFloat(unitPriceText) || 0;

                    var totalAmountText = row.find('td:eq(7)').text().replace('₹', '').replace(',', '').trim();
                    currentTotalAmount = totalAmountText === '0.00' ? 0 : parseFloat(totalAmountText) || 0;
                }

                var table = row.closest('table');
                var headerRow = table.find('thead tr');
                var headers = [];

                headerRow.find('th').each(function(index) {
                    var headerText = $(this).text().trim();
                    headers.push(headerText);
                });

                var batchColumnIndex = -1;
                var expiryColumnIndex = -1;

                headers.forEach((header, index) => {
                    if (header.toLowerCase().includes('batch')) {
                        batchColumnIndex = index;
                    }
                    if (header.toLowerCase().includes('expiry')) {
                        expiryColumnIndex = index;
                    }
                });

                var currentBatchNo = '';
                var currentExpiryDate = '';

                if (batchColumnIndex >= 0 && batchColumnIndex < row.find('td').length) {
                    currentBatchNo = row.find(`td:eq(${batchColumnIndex})`).text().trim();
                }

                if (expiryColumnIndex >= 0 && expiryColumnIndex < row.find('td').length) {
                    currentExpiryDate = row.find(`td:eq(${expiryColumnIndex})`).text().trim();
                }

                $('#editItemId').val(itemId);
                $('#editMedicineName').val(medicineName);
                $('#editCompanyName').val(companyName);
                $('#editVendorCode').val(vendorCode);
                $('#editRaisedQty').val(raisedQty);
                $('#editReceivedQty').val(currentReceivedQty).attr('max', raisedQty);
                $('#editUnitPrice').val(currentUnitPrice);
                $('#editTotalAmount').val(currentTotalAmount > 0 ? `₹${currentTotalAmount.toFixed(2)}` : '₹0.00');
                $('#editBatchNo').val(currentBatchNo === '-' || currentBatchNo === 'N/A' ? '' : currentBatchNo);

                var expiryDateValue = '';

                if (currentExpiryDate &&
                    currentExpiryDate !== '-' &&
                    currentExpiryDate !== 'N/A' &&
                    currentExpiryDate !== '' &&
                    currentExpiryDate.toLowerCase() !== 'null' &&
                    currentExpiryDate.toLowerCase() !== 'undefined') {

                    if (currentExpiryDate.includes('/')) {
                        var dateParts = currentExpiryDate.split('/');

                        if (dateParts.length === 3) {
                            var day = dateParts[0].padStart(2, '0');
                            var month = dateParts[1].padStart(2, '0');
                            var year = dateParts[2];

                            if (!isNaN(parseInt(day)) && !isNaN(parseInt(month)) && !isNaN(parseInt(year)) && year.length === 4) {
                                expiryDateValue = `${year}-${month}-${day}`;
                            }
                        }
                    }
                    else if (currentExpiryDate.includes('-') && currentExpiryDate.length === 10) {
                        var dateParts = currentExpiryDate.split('-');

                        if (dateParts.length === 3) {
                            if (dateParts[0].length === 4) {
                                expiryDateValue = currentExpiryDate;
                            } else {
                                var day = dateParts[0].padStart(2, '0');
                                var month = dateParts[1].padStart(2, '0');
                                var year = dateParts[2];
                                expiryDateValue = `${year}-${month}-${day}`;
                            }
                        }
                    }
                    else {
                        var testDate = new Date(currentExpiryDate);
                        if (!isNaN(testDate.getTime())) {
                            var year = testDate.getFullYear();
                            var month = String(testDate.getMonth() + 1).padStart(2, '0');
                            var day = String(testDate.getDate()).padStart(2, '0');
                            expiryDateValue = `${year}-${month}-${day}`;
                        }
                    }
                }

                // Set minimum date to today and add validation
                var today = new Date().toISOString().split('T')[0];
                $('#editExpiryDate').val(expiryDateValue).attr('min', today);

                // Add real-time validation for expiry date
                $('#editExpiryDate').off('change.expiryValidation').on('change.expiryValidation', function() {
                    validateModalExpiryDate(this);
                });

                $('#editReason').val('');
                $('#editReasonForm .is-invalid').removeClass('is-invalid');
                $('#editReasonForm .invalid-feedback').text('');

                $('#editReasonModal').modal('show');
            }

            // Auto-validate received quantity in the modal
            $('#editReceivedQty').on('input', function() {
                var raisedQty = parseInt($('#editRaisedQty').val()) || 0;
                var receivedQty = parseInt($(this).val()) || 0;

                if (receivedQty > raisedQty) {
                    $(this).addClass('is-invalid');
                    $(this).siblings('.invalid-feedback').text('Received quantity cannot exceed raised quantity.');
                } else {
                    $(this).removeClass('is-invalid');
                    $(this).siblings('.invalid-feedback').text('');
                }
            });

            // Validate unit price
            $('#editUnitPrice').on('input', function() {
                var unitPrice = parseFloat($(this).val()) || 0;

                if (unitPrice < 0) {
                    $(this).addClass('is-invalid');
                    $(this).siblings('.invalid-feedback').text('Unit price cannot be negative.');
                } else if (unitPrice > 999999.99) {
                    $(this).addClass('is-invalid');
                    $(this).siblings('.invalid-feedback').text('Unit price cannot exceed ₹999,999.99.');
                } else {
                    $(this).removeClass('is-invalid');
                    $(this).siblings('.invalid-feedback').text('');
                }
            });

            // Save changes from the modal
            $('#saveEditChanges').click(function() {
                var itemId = $('#editItemId').val();
                var receivedQty = parseInt($('#editReceivedQty').val()) || 0;
                var raisedQty = parseInt($('#editRaisedQty').val()) || 0;
                var unitPrice = parseFloat($('#editUnitPrice').val()) || 0;
                var batchNo = $('#editBatchNo').val().trim();
                var expiryDateValue = $('#editExpiryDate').val();
                var reason = $('#editReason').val().trim();

                $('#editReasonForm .is-invalid').removeClass('is-invalid');
                $('#editReasonForm .invalid-feedback').text('');

                var isValid = true;

                if (receivedQty > raisedQty) {
                    $('#editReceivedQty').addClass('is-invalid');
                    $('#editReceivedQty').siblings('.invalid-feedback').text('Received quantity cannot exceed raised quantity.');
                    isValid = false;
                }

                if (unitPrice < 0) {
                    $('#editUnitPrice').addClass('is-invalid');
                    $('#editUnitPrice').siblings('.invalid-feedback').text('Unit price cannot be negative.');
                    isValid = false;
                } else if (unitPrice > 999999.99) {
                    $('#editUnitPrice').addClass('is-invalid');
                    $('#editUnitPrice').siblings('.invalid-feedback').text('Unit price cannot exceed ₹999,999.99.');
                    isValid = false;
                }

                if (!reason || reason.length < 10) {
                    $('#editReason').addClass('is-invalid');
                    $('#editReason').siblings('.invalid-feedback').text('Please provide a detailed reason (minimum 10 characters).');
                    isValid = false;
                }

                // Validate expiry date before saving
                var expiryDateValid = true;
                if (expiryDateValue) {
                    expiryDateValid = validateModalExpiryDate($('#editExpiryDate')[0]);
                }

                if (!isValid || !expiryDateValid) {
                    return;
                }

                $(this).prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Saving...');

                var postData = {
                    indentItemId: itemId,
                    receivedQuantity: receivedQty,
                    unitPrice: unitPrice,
                    batchNo: batchNo,
                    editReason: reason
                };

                if (expiryDateValue) {
                    postData.expiryDate = new Date(expiryDateValue).toISOString();
                }

                $.post('@Url.Action("UpdateMedicineItemWithReason", "StoreIndent")', postData)
                .done(function(response) {
                    if (response.success) {
                        var row = $(`button[data-id="${itemId}"]`).closest('tr');
                        var headerRow = row.closest('table').find('thead tr');
                        var hasUnitPriceColumn = module.isStoreInventory;

                        row.find('td:eq(5)').text(response.data.receivedQuantity);
                        row.find('td:eq(6)').html(`
                            <span class="badge ${response.data.pendingQuantity > 0 ? 'bg-warning' : 'bg-success'}">
                                ${response.data.pendingQuantity}
                            </span>
                        `);

                        if (hasUnitPriceColumn) {
                            // Update unit price and total amount
                            row.find('td:eq(6)').html(`
                                <span class="fw-semibold text-primary">
                                    ${response.data.unitPrice ? `₹${response.data.unitPrice.toFixed(2)}` : '₹0.00'}
                                </span>
                            `);
                            row.find('td:eq(7)').html(`
                                <span class="fw-semibold text-success">
                                    ${response.data.totalAmount ? `₹${response.data.totalAmount.toFixed(2)}` : '₹0.00'}
                                </span>
                            `);
                        }

                        $('#editReasonModal').modal('hide');

                        if (typeof showMessage === 'function') {
                            showMessage(response.message, 'success');
                        }

                        if (typeof tbl !== 'undefined' && tbl.ajax) {
                            tbl.ajax.reload();
                        }
                    } else {
                        alert(response.message || 'Failed to update medicine item.');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Update medicine item request failed:', status, error);
                    alert('Network error occurred. Please try again.');
                })
                .always(function() {
                    $('#saveEditChanges').prop('disabled', false).html('<i class="bi bi-check-circle me-1"></i>Save Changes');
                });
            });

            function convertRowToEditMode(row, itemId) {
                var currentReceivedQty = parseInt(row.find('td:eq(5)').text()) || 0;
                var raisedQty = parseInt(row.find('td:eq(4)').text()) || 0;
                var currentUnitPrice = '';
                var currentBatchNo = '';
                var currentExpiryDate = '';

                var headerRow = row.closest('table').find('thead tr');
                var hasUnitPriceColumn = headerRow.find('th:contains("Unit Price")').length > 0;

                if (hasUnitPriceColumn) {
                    var unitPriceText = row.find('td:eq(7)').text().replace('₹', '').replace(',', '').trim();
                    currentUnitPrice = unitPriceText === '-' ? '' : unitPriceText;
                }

                if (module.isStoreInventory) {
                    if (hasUnitPriceColumn) {
                        currentBatchNo = row.find('td:eq(9)').text().trim();
                        currentExpiryDate = row.find('td:eq(10)').text().trim();
                    } else {
                        currentBatchNo = row.find('td:eq(7)').text().trim();
                        currentExpiryDate = row.find('td:eq(8)').text().trim();
                    }

                    if (currentBatchNo === '-') currentBatchNo = '';
                    if (currentExpiryDate === '-') currentExpiryDate = '';
                    else if (currentExpiryDate) {
                        var dateParts = currentExpiryDate.split('/');
                        if (dateParts.length === 3) {
                            currentExpiryDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                        }
                    }
                }

                row.data('original-content', row.html());

                row.find('td:eq(5)').html(`
                    <input type="number" class="form-control form-control-sm edit-received-qty"
                           value="${currentReceivedQty}" min="0" max="${raisedQty}" />
                `);

                if (hasUnitPriceColumn && !module.isStoreInventory) {
                    row.find('td:eq(7)').html(`
                        <input type="number" class="form-control form-control-sm edit-unit-price"
                               value="${currentUnitPrice}" min="0" step="0.01" placeholder="Unit Price" />
                    `);
                } else if (hasUnitPriceColumn && module.isStoreInventory && currentUnitPrice !== undefined) {
                    row.find('td:eq(7)').html(`
                        <input type="number" class="form-control form-control-sm edit-unit-price"
                               value="${currentUnitPrice}" min="0" step="0.01" placeholder="Unit Price" />
                    `);
                }

                if (module.isStoreInventory) {
                    var batchColIndex = hasUnitPriceColumn ? 9 : 7;
                    var expiryColIndex = hasUnitPriceColumn ? 10 : 8;
                    var today = new Date().toISOString().split('T')[0]; // Get today's date

                    row.find(`td:eq(${batchColIndex})`).html(`
                        <input type="text" class="form-control form-control-sm edit-batch-no"
                               value="${currentBatchNo}" placeholder="Batch No" maxlength="50" />
                    `);

                    row.find(`td:eq(${expiryColIndex})`).html(`
                        <input type="date" class="form-control form-control-sm edit-expiry-date"
                               value="${currentExpiryDate}" min="${today}"
                               onchange="validateInlineExpiryDate(this)" />
                        <div class="invalid-feedback"></div>
                    `);
                }

                var actionColumnIndex = row.find('td').length - 1;
                row.find(`td:eq(${actionColumnIndex})`).html(`
                    <button class="btn btn-sm btn-success save-medicine-inline me-1" data-id="${itemId}" title="Save Changes">
                        <i class="bi bi-check"></i>Save
                    </button>
                    <button class="btn btn-sm btn-secondary cancel-medicine-inline" title="Cancel">
                        <i class="bi bi-x"></i>Cancel
                    </button>
                `);

                updateCalculatedFields(row, raisedQty);

                row.find('.edit-received-qty, .edit-unit-price').on('input', function() {
                    updateCalculatedFields(row, raisedQty);
                });
            }

            function updateCalculatedFields(row, raisedQty) {
                var receivedQty = parseInt(row.find('.edit-received-qty').val()) || 0;
                var unitPrice = parseFloat(row.find('.edit-unit-price').val()) || 0;
                var pendingQty = Math.max(0, raisedQty - receivedQty);
                var totalAmount = receivedQty * unitPrice;

                row.find('td:eq(6)').html(`
                    <span class="badge ${pendingQty > 0 ? 'bg-warning' : 'bg-success'}">
                        ${pendingQty}
                    </span>
                `);

                var headerRow = row.closest('table').find('thead tr');
                var hasUnitPriceColumn = headerRow.find('th:contains("Unit Price")').length > 0;

                if (hasUnitPriceColumn && !module.isStoreInventory) {
                    row.find('td:eq(8)').text(totalAmount > 0 ? `₹${totalAmount.toFixed(2)}` : '-');
                } else if (hasUnitPriceColumn && module.isStoreInventory) {
                    row.find('td:eq(8)').text(totalAmount > 0 ? `₹${totalAmount.toFixed(2)}` : '-');
                }
            }

            // Save medicine item inline
            $(document).on('click', '.save-medicine-inline', function() {
                var itemId = $(this).data('id');
                var row = $(this).closest('tr');
                var receivedQty = parseInt(row.find('.edit-received-qty').val()) || 0;
                var unitPrice = parseFloat(row.find('.edit-unit-price').val()) || null;
                var raisedQty = parseInt(row.find('td:eq(4)').text()) || 0;

                var headerRow = row.closest('table').find('thead tr');
                var hasUnitPriceColumn = headerRow.find('th:contains("Unit Price")').length > 0;

                var batchNo = null;
                var expiryDate = null;
                if (module.isStoreInventory) {
                    batchNo = row.find('.edit-batch-no').val() || '';
                    var expiryDateValue = row.find('.edit-expiry-date').val();
                    expiryDate = expiryDateValue ? new Date(expiryDateValue).toISOString() : null;

                    // Validate expiry date before saving
                    if (expiryDateValue) {
                        var expiryDateElement = row.find('.edit-expiry-date')[0];
                        if (!validateInlineExpiryDate(expiryDateElement)) {
                            alert('Please correct the expiry date before saving.');
                            return;
                        }
                    }
                }

                if (receivedQty > raisedQty) {
                    alert('Received quantity cannot exceed raised quantity.');
                    return;
                }

                if (unitPrice !== null && (unitPrice < 0 || unitPrice > 999999.99)) {
                    alert('Please enter a valid unit price between 0 and ₹999,999.99.');
                    return;
                }

                $(this).prop('disabled', true);

                var postData = {
                    indentItemId: itemId,
                    receivedQuantity: receivedQty,
                    unitPrice: unitPrice
                };

                if (module.isStoreInventory) {
                    postData.batchNo = batchNo;
                    if (expiryDate) {
                        postData.expiryDate = expiryDate;
                    }
                }

                $.post('@Url.Action("UpdateMedicineItem", "StoreIndent")', postData)
                .done(function(response) {
                    if (response.success) {
                        row.find('td:eq(5)').text(response.data.receivedQuantity);
                        row.find('td:eq(6)').html(`
                            <span class="badge ${response.data.pendingQuantity > 0 ? 'bg-warning' : 'bg-success'}">
                                ${response.data.pendingQuantity}
                            </span>
                        `);

                        if (hasUnitPriceColumn && !module.isStoreInventory) {
                            row.find('td:eq(7)').text(response.data.unitPrice ? `₹${response.data.unitPrice.toFixed(2)}` : '-');
                            row.find('td:eq(8)').text(response.data.totalAmount ? `₹${response.data.totalAmount.toFixed(2)}` : '-');
                        } else if (hasUnitPriceColumn && module.isStoreInventory) {
                            row.find('td:eq(7)').text(response.data.unitPrice ? `₹${response.data.unitPrice.toFixed(2)}` : '-');
                            row.find('td:eq(8)').text(response.data.totalAmount ? `₹${response.data.totalAmount.toFixed(2)}` : '-');

                            var batchColIndex = 9;
                            var expiryColIndex = 10;
                            row.find(`td:eq(${batchColIndex})`).text(response.data.batchNo || '-');
                            row.find(`td:eq(${expiryColIndex})`).text(
                                response.data.expiryDate ?
                                new Date(response.data.expiryDate).toLocaleDateString('en-GB') :
                                '-'
                            );
                        } else if (module.isStoreInventory) {
                            var batchColIndex = 7;
                            var expiryColIndex = 8;
                            row.find(`td:eq(${batchColIndex})`).text(response.data.batchNo || '-');
                            row.find(`td:eq(${expiryColIndex})`).text(
                                response.data.expiryDate ?
                                new Date(response.data.expiryDate).toLocaleDateString('en-GB') :
                                '-'
                            );
                        }

                        var actionColumnIndex = row.find('td').length - 1;
                        if (response.data.pendingQuantity > 0) {
                            row.find(`td:eq(${actionColumnIndex})`).html(`
                                <span class="text-muted">View Only</span>
                            `);
                        } else {
                            row.find(`td:eq(${actionColumnIndex})`).html(`
                                <span class="text-muted">View Only</span>
                            `);
                        }

                        if (typeof showMessage === 'function') {
                            showMessage(response.message, 'success');
                        }

                        if (typeof tbl !== 'undefined' && tbl.ajax) {
                            tbl.ajax.reload();
                        }
                    } else {
                        alert(response.message || 'Failed to update medicine item.');
                        $(this).prop('disabled', false);
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Update medicine item request failed:', status, error);
                    alert('Network error occurred. Please try again.');
                    $(this).prop('disabled', false);
                });
            });

            // Cancel medicine item inline edit
            $(document).on('click', '.cancel-medicine-inline', function() {
                var row = $(this).closest('tr');
                var originalContent = row.data('original-content');

                if (originalContent) {
                    row.html(originalContent);
                    row.removeData('original-content');
                }
            });

            // Reset summary cards when modal is closed
            $('#batchViewModal').on('hidden.bs.modal', function() {
                resetSummaryCards();
            });

            // Make validateInlineExpiryDate globally available
            window.validateInlineExpiryDate = validateInlineExpiryDate;

            // Make renderViewBatchTable globally available
            window.renderViewBatchTable = renderViewBatchTable;
        });

    })(jQuery);
</script>