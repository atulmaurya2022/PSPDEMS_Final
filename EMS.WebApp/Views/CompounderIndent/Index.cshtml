@{
    ViewData["Title"] = "Compounder Indent";
}
<!-- Include Master Common Styles -->
<link href="~/css/master-common.css" rel="stylesheet" />

<!-- Enhanced Master Header -->
<!-- Enhanced Master Header with Search and Add Button -->
<div class="master-header">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div class="flex-grow-1">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-master">
                    <li class="breadcrumb-item">Home</li>
                    <li class="breadcrumb-item active" aria-current="page" id="breadcrumbTitle">Compounder Indent</li>
                </ol>
            </nav>
            <h1 class="master-title">
                <i class="bi bi-building"></i>
                <span id="pageTitle">Compounder Indent</span>
            </h1>
            <p class="master-subtitle" id="pageSubtitle">Manage Compounder indent requests and approvals</p>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <label for="indentTypeFilter" class="form-label mb-0">Indent Type:</label>
                <select id="indentTypeFilter" class="form-select form-select-sm glass-input" style="width: 180px">
                    <!-- Options will be populated based on user role -->
                </select>
            </div>
            <button id="btnCreate" class="btn btn-add-master">
                <i class="bi bi-plus-lg"></i>
                <span id="btnCreateText">Add Compounder Indent</span>
            </button>
        </div>
    </div>
</div>


<!-- Success/Error message area -->
<div id="messageArea" style="display:none;"></div>

<div class="master-form">
    <div class="card-body p-0">
        <table id="tblCompounderIndents" class="table table-striped table-glass glass-table">
            <thead>
                <tr>
                    <th>SI.No</th>
                    <th>Indent No.</th>
                    <th>Indent Type</th>
                    <th>Indent Date</th>
                    <th>Approval Status</th>
                    <th>Issued Status</th>
                    <th>Created By</th>
                    <th style="width:200px">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>



<!-- Modal -->
<div class="modal fade" id="modalCompounderIndent" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content glass">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

<style>
    /* Hide any warning messages on the main index page */
    .main-content .alert.alert-info:contains("read-only"),
    .main-content .compounder-readonly-alert,
    .main-content .compounder-inventory-info {
        display: none !important;
    }

    /* Ensure table container uses full width */
    .dataTables_wrapper {
        width: 100% !important;
        clear: both;
    }
</style>

@section Scripts {
    <script>
        // Global variables for user roles
        let currentUserRole = '';
        let isStoreUser = false;
        let isCompounderUser = false;
        let isDoctor = false;
        let isTribeniPlant = false;
        let roleLabelSingular = 'Compounder'; // Will be updated based on plant
        let roleLabelPlural = 'Compounder'; // Will be updated based on plant
        let inventoryLabel = 'Compounder Inventory'; // Will be updated based on plant

        // Function to get role label based on plant
        function getRoleLabel() {
            return isTribeniPlant ? 'Pharmacist' : 'Compounder';
        }

        function getRoleLabelPlural() {
            return isTribeniPlant ? 'Pharmacist' : 'Compounder';
        }

        function getInventoryLabel() {
            return isTribeniPlant ? 'Pharmacist Inventory' : 'Compounder Inventory';
        }

        // Function to update page labels based on plant
        function updatePageLabels() {
            roleLabelSingular = getRoleLabel();
            roleLabelPlural = getRoleLabelPlural();
            inventoryLabel = getInventoryLabel();

            // Update page title and headers
            $('#breadcrumbTitle').text(roleLabelPlural + ' Indent');
            $('#pageTitle').text(roleLabelPlural + ' Indent');
            $('#pageSubtitle').text('Manage ' + roleLabelPlural + ' indent requests and approvals');
            $('#btnCreateText').text('Add ' + roleLabelPlural + ' Indent');

            // Update document title
            document.title = roleLabelPlural + ' Indent | EMS';
        }

        // Function to get current user role
        function getCurrentUserRole() {
            return $.get('@Url.Action("GetCurrentUserRole", "CompounderIndent")')
                .done(function(response) {
                    if (response && response.role) {
                        currentUserRole = response.role.toLowerCase();
                        isStoreUser = currentUserRole.includes('store');
                        isCompounderUser = currentUserRole.includes('compounder');
                        isDoctor = currentUserRole === 'doctor';
                    }
                    // Check plant name
                    if (response && response.plantName) {
                        isTribeniPlant = response.plantName.toLowerCase() === 'tribeni';
                        updatePageLabels();
                    }
                })
                .fail(function() {
                    console.log('Could not determine user role');
                });
        }

        // Function to populate filter options based on user role
        function populateFilterOptions() {
            const filterSelect = $('#indentTypeFilter');
            filterSelect.empty();

            if (isStoreUser) {
                // Store users can only see Compounder Inventory
                filterSelect.append('<option value="Compounder Inventory">' + inventoryLabel + '</option>');
                filterSelect.val('Compounder Inventory');
                $('#btnCreate').hide(); // Store users cannot create new indents
            } else if (isCompounderUser) {
                // Compounder users can see all types and CAN create
                filterSelect.append('<option selected disabled value="">Select Indent Type</option>');
                filterSelect.append('<option value="Draft Indent">Draft Indent</option>');
                filterSelect.append('<option value="Pending Indents">Pending Indents</option>');
                filterSelect.append('<option value="Approved Indents">Approved Indents</option>');
                filterSelect.append('<option value="Rejected Indents">Rejected Indents</option>');
                filterSelect.append('<option value="Compounder Inventory">' + inventoryLabel + '</option>');
                $('#btnCreate').show(); // Compounder users CAN create new indents
            } else {
                // Regular users and doctors can see all types
                filterSelect.append('<option selected disabled value="">Select Indent Type</option>');
                filterSelect.append('<option value="Draft Indent">Draft Indent</option>');
                filterSelect.append('<option value="Pending Indents">Pending Indents</option>');
                filterSelect.append('<option value="Approved Indents">Approved Indents</option>');
                filterSelect.append('<option value="Rejected Indents">Rejected Indents</option>');
                filterSelect.append('<option value="Compounder Inventory">' + inventoryLabel + '</option>');

                // Only non-doctors can create indents
                if (!isDoctor) {
                    $('#btnCreate').show();
                } else {
                    $('#btnCreate').hide();
                }
            }
        }

        // Show message function for page-level notifications
        function showMessage(message, type = 'success') {
            // Don't show read-only warning messages on the main index page
            if (message && typeof message === 'string' &&
                (message.includes('read-only mode') ||
                 message.includes('cannot edit Compounder Inventory') ||
                 message.includes('cannot edit Pharmacist Inventory') ||
                 message.includes('viewing this inventory in read-only mode'))) {
                return; // Skip showing these messages on the main page
            }

            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-warning';
            $('#messageArea')
                .removeClass('alert-success alert-warning alert-danger')
                .addClass(`alert ${alertClass}`)
                .html(message)
                .show();

            // Auto hide after 5 seconds
            setTimeout(function() {
                $('#messageArea').fadeOut();
            }, 5000);

            // Scroll to top to show message
            $('html, body').animate({ scrollTop: 0 }, 300);
        }

        // Function to remove unwanted warning messages
        function removeWarningMessages() {
            // Remove alerts with specific text content
            $('.alert').each(function() {
                const alertText = $(this).text().trim();
                if (alertText.includes('You are viewing this inventory in read-only mode') ||
                    alertText.includes('Compounder users cannot edit Compounder Inventory') ||
                    alertText.includes('read-only mode')) {
                    $(this).remove();
                }
            });

            // Remove alerts with specific classes
            $('.compounder-readonly-alert, .compounder-inventory-info').remove();
        }

        $(function () {
            const modalEl = $('#modalCompounderIndent');
            modalEl.appendTo('body');
            modalEl.modal({ backdrop: 'static', keyboard: false, show: false });

            // Remove any existing warning messages immediately
            removeWarningMessages();

            // Initialize user role and then setup the page
            getCurrentUserRole().then(function() {
                populateFilterOptions();
                initializeDataTable();

                // Remove warning messages after initialization
                setTimeout(removeWarningMessages, 500);
            });

            // Initialize page state
            function initializePageState() {
                const selectedType = $('#indentTypeFilter').val();
                if (selectedType === '' && !isStoreUser) { // "All Types" selected (not applicable for store users)
                    $('#tblCompounderIndents').hide();
                    if ($('#noFilterMessage').length === 0) {
                        $('#tblCompounderIndents').after('<div id="noFilterMessage" class="alert alert-info text-center"><i class="bi bi-info-circle me-2"></i>Please select a specific Indent Type to view records.</div>');
                    }
                } else {
                    $('#tblCompounderIndents').show();
                    $('#noFilterMessage').remove();
                }
            }

            // Initialize DataTable
            function initializeDataTable() {
                const tbl = $('#tblCompounderIndents').DataTable({
                    ajax: {
                        url: '@Url.Action("LoadData", "CompounderIndent")',
                        dataSrc: 'data',
                        data: function(d) {
                            d.indentType = $('#indentTypeFilter').val();
                        }
                    },
                    columns: [
                        {
                            data: null,
                            render: function(data, type, row, meta) {
                                return meta.row + 1;
                            }
                        },
                        { data: 'indentNo' },
                        {
                            data: 'indentType',
                            render: function(data) {
                                if (data === 'Draft Indent') {
                                    return '<span class="badge bg-secondary"><i class="bi bi-file-text me-1"></i>' + data + '</span>';
                                } else if (data === 'Compounder Inventory') {
                                    return '<span class="badge bg-info"><i class="bi bi-boxes me-1"></i>' + data + '</span>';
                                }
                                return data;
                            }
                        },
                        { data: 'indentDate' },
                        {
                            data: 'status',
                            render: function(data) {
                                var badgeClass = 'bg-secondary';
                                var icon = 'bi-question-circle';

                                if (data === 'Draft') {
                                    badgeClass = 'bg-secondary';
                                    icon = 'bi-file-text';
                                } else if (data === 'Pending') {
                                    badgeClass = 'bg-warning';
                                    icon = 'bi-clock';
                                } else if (data === 'Approved') {
                                    badgeClass = 'bg-success';
                                    icon = 'bi-check-circle';
                                } else if (data === 'Rejected') {
                                    badgeClass = 'bg-danger';
                                    icon = 'bi-x-circle';
                                }

                                return '<span class="badge ' + badgeClass + '"><i class="' + icon + ' me-1"></i>' + data + '</span>';
                            }
                        },
                        {
                            data: 'totalPendingQty',
                            render: function(data, type, row) {
                                // Check if total pending quantity from medicines table is 0
                                const totalPendingQty = parseInt(data) || 0;
                                const isCompleted = totalPendingQty === 0;

                                if (isCompleted) {
                                    return '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span>';
                                } else {
                                    return '<span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Pending (' + totalPendingQty + ')</span>';
                                }
                            }
                        },
                        { data: 'createdBy', render: function(data) { return data || 'N/A'; } },
                        {
                            data: null,
                            render: function(data, type, row) {
                                const id = row.indentId;
                                const status = row.status;
                                const indentType = row.indentType;
                                const canApproveReject = row.canApproveReject;
                                const canEdit = row.canEdit;
                                const canDelete = row.canDelete;
                                const isDoctor = row.isDoctor;
                                const isStoreUser = row.isStoreUser;
                                const isCompounderUser = row.isCompounderUser;
                                const allItemsReceived = row.allItemsReceived;
                                const hasItems = row.hasItems;

                                let buttons = '';

                                // REVIEW & APPROVE BUTTON - ONLY FOR DOCTORS
                                if (canApproveReject) {
                                    buttons += `<button class="btn btn-sm btn-success approve-reject me-1" data-id="${id}" title="Review & Approve/Reject Indent">
                                                    <i class="bi bi-check2-square"></i> Review & Approve
                                                </button>`;
                                }

                                // Handle different indent types based on user roles
                                if (indentType === 'Compounder Inventory') {
                                    // For Compounder Inventory - show both pending and approved indents
                                    // - Store users can edit both pending and approved indents with items
                                    // - Compounder users can ONLY view (no edit buttons)
                                    // - Other users can edit both pending and approved indents with items

                                    if (isCompounderUser) {
                                        // Compounder users get ONLY view button for Compounder Inventory
                                        buttons += `<button class="btn btn-action-view view me-1" data-id="${id}" title="View Inventory Details">
                                                        <i class="bi bi-eye fs-6"></i>
                                                    </button>`;
                                    } else {
                                        // View button for all non-compounder users
                                        buttons += `<button class="btn btn-action-view view me-1" data-id="${id}" title="View Inventory Details">
                                                        <i class="bi bi-eye fs-6"></i>
                                                    </button>`;

                                        // Store users and others can edit both pending and approved indents with items
                                        if (canEdit && hasItems) {
                                            const editTitle = isStoreUser ? "Manage Inventory" : "Update Inventory";

                                            buttons += `<button class="btn btn-action-edit edit me-1" data-id="${id}" title="${editTitle}">
                                                            <i class="bi bi-pencil fs-6"></i>
                                                        </button>`;
                                        }
                                    }
                                } else if (indentType === 'Draft Indent') {
                                    // Draft indents - creator can edit (including compounder users, excluding doctors and store users)
                                    if (canEdit && !isDoctor && !isStoreUser) {
                                        buttons += `<button class="btn btn-action-edit edit me-1" data-id="${id}" title="Edit Draft">
                                                        <i class="bi bi-pencil fs-6"></i>
                                                    </button>`;
                                    }
                                    if (canDelete && !isDoctor && !isStoreUser) {
                                        buttons += `<button class="btn btn-action-delete delete" data-id="${id}" title="Delete Draft">
                                                        <i class="bi bi-trash fs-6"></i>
                                                    </button>`;
                                    }
                                    // Show view button for others or restricted users
                                    if (!canEdit || isDoctor || isStoreUser) {
                                        buttons += `<button class="btn btn-action-view view me-1" data-id="${id}" title="View Details">
                                                        <i class="bi bi-eye fs-6"></i>
                                                    </button>`;
                                    }
                                } else {
                                    // Non-draft indents
                                    switch(status) {
                                        case 'Pending':
                                            if (canEdit && !isDoctor && !isStoreUser) {
                                                buttons += `<button class="btn btn-action-edit edit me-1" data-id="${id}" title="Edit Indent">
                                                                <i class="bi bi-pencil fs-6"></i>
                                                            </button>`;
                                            }
                                            if (canDelete && !isDoctor && !isStoreUser) {
                                                buttons += `<button class="btn btn-action-delete delete" data-id="${id}" title="Delete Indent">
                                                                <i class="bi bi-trash fs-6"></i>
                                                            </button>`;
                                            }
                                            // Show view button for restricted users or when they cannot edit
                                            if ((!canEdit || isDoctor || isStoreUser) && !canApproveReject) {
                                                buttons += `<button class="btn btn-action-view view me-1" data-id="${id}" title="View Details">
                                                                <i class="bi bi-eye fs-6"></i>
                                                            </button>`;
                                            }
                                            break;

                                        case 'Approved':
                                        case 'Rejected':
                                            // Only view button for completed indents
                                            buttons += `<button class="btn btn-action-view view me-1" data-id="${id}" title="View Details">
                                                            <i class="bi bi-eye fs-6"></i>
                                                        </button>`;
                                            break;

                                        default:
                                            // For any other status
                                            if (canEdit && !isDoctor && !isStoreUser) {
                                                buttons += `<button class="btn btn-action-edit edit me-1" data-id="${id}" title="Edit Indent">
                                                                <i class="bi bi-pencil fs-6"></i>
                                                            </button>`;
                                            }
                                            if (canDelete && !isDoctor && !isStoreUser) {
                                                buttons += `<button class="btn btn-action-delete delete" data-id="${id}" title="Delete Indent">
                                                                <i class="bi bi-trash fs-6"></i>
                                                            </button>`;
                                            }
                                            // Show view button for restricted users or when they cannot edit
                                            if (!canEdit || isDoctor || isStoreUser) {
                                                buttons += `<button class="btn btn-action-view view me-1" data-id="${id}" title="View Details">
                                                                <i class="bi bi-eye fs-6"></i>
                                                            </button>`;
                                            }
                                    }
                                }

                                // If no buttons are available, show "No Actions Available"
                                if (!buttons.trim()) {
                                    buttons = '<span class="text-muted">No Actions Available</span>';
                                }

                                return buttons;
                            }
                        }
                    ],
                    order: [[1, 'desc']],
                    pageLength: 25,
                    language: {
                        emptyTable: 'No data available in table'
                    },
                    drawCallback: function() {
                        // Update empty message based on filter and user role
                        const selectedType = $('#indentTypeFilter').val();
                        const isEmpty = this.api().data().length === 0;

                        if (isEmpty && selectedType === 'Draft Indent') {
                            if (isStoreUser) {
                                $('.dataTables_empty').html('Store users cannot create draft indents.');
                            } else {
                                $('.dataTables_empty').html('You have no draft indents. Click "Add Compounder Indent" and save as draft to create one.');
                            }
                        } else if (isEmpty && selectedType === 'Compounder Inventory') {
                            // Update message for Compounder Inventory
                            $('.dataTables_empty').html('No approved or pending indents available for inventory management.');
                        } else if (isEmpty && isStoreUser) {
                            $('.dataTables_empty').html('No Compounder Inventory records available.');
                        }

                        // Remove warning messages after table draw
                        setTimeout(removeWarningMessages, 100);
                    }
                });

                // Filter change handler
                $('#indentTypeFilter').change(function() {
                    const selectedType = $(this).val();

                    if (selectedType === '' && !isStoreUser) { // "All Types" selected (not applicable for store users)
                        // Hide the table
                        $('#tblCompounderIndents').hide();
                        // Show a message instead
                        if ($('#noFilterMessage').length === 0) {
                            $('#tblCompounderIndents').after('<div id="noFilterMessage" class="alert alert-info text-center"><i class="bi bi-info-circle me-2"></i>Please select a specific Indent Type to view records.</div>');
                        }
                    } else {
                        // Show the table and remove message
                        $('#tblCompounderIndents').show();
                        $('#noFilterMessage').remove();
                        // Reload table data
                        tbl.ajax.reload();
                    }

                    // Remove warning messages after filter change
                    setTimeout(removeWarningMessages, 300);
                });

                // Open Create Modal (only for allowed users)
                $('#btnCreate').click(() => {
                    if (isStoreUser) {
                        showMessage('Access denied. Store users can only manage ' + inventoryLabel + '.', 'error');
                        return;
                    }

                    // Compounder users CAN create indents (removed restriction)

                    const createUrl = '@Url.Action("Create", "CompounderIndent")';

                    $.get(createUrl)
                    .done(html => {
                        modalEl.find('.modal-title').text('Add ' + roleLabelPlural + ' Indent');
                        $('#modalBody').html(html);
                        modalEl.modal('show');
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Create request failed:', status, error);
                        showMessage('Failed to load create form. Please try again.', 'error');
                    });
                });

                // Open Edit Modal
                $('#tblCompounderIndents').on('click', '.edit', function () {
                    const id = $(this).data('id');
                    const currentIndentType = $('#indentTypeFilter').val();
                    const editUrl = '@Url.Action("Edit", "CompounderIndent")' + '/' + id + '?indentType=' + encodeURIComponent(currentIndentType);

                    $.get(editUrl)
                    .done(html => {
                        // Set appropriate modal title based on context
                        let modalTitle = 'Edit ' + roleLabelPlural + ' Indent';
                        if (currentIndentType === 'Compounder Inventory') {
                            modalTitle = isStoreUser ? 'Manage ' + inventoryLabel : 'Update ' + inventoryLabel;
                        }

                        modalEl.find('.modal-title').text(modalTitle);
                        $('#modalBody').html(html);
                        modalEl.modal('show');
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Edit request failed:', status, error);
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            showMessage(xhr.responseJSON.message, 'error');
                        } else {
                            showMessage('Failed to load edit form. Please try again.', 'error');
                        }
                    });
                });

                // Open Approve/Reject Modal
                $('#tblCompounderIndents').on('click', '.approve-reject', function () {
                    const id = $(this).data('id');
                    const currentIndentType = $('#indentTypeFilter').val();
                    const approveRejectUrl = '@Url.Action("ApproveReject", "CompounderIndent")' + '/' + id + '?indentType=' + encodeURIComponent(currentIndentType);

                    $.get(approveRejectUrl)
                    .done(html => {
                        modalEl.find('.modal-title').text('Approve/Reject ' + roleLabelSingular + ' Indent');
                        $('#modalBody').html(html);
                        modalEl.modal('show');
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Approve/Reject request failed:', status, error);
                        showMessage('Failed to load approve/reject form. Please try again.', 'error');
                    });
                });

                // View Modal
                $('#tblCompounderIndents').on('click', '.view', function (e) {
                    if ($(e.target).is('button') || $(e.target).is('i')) {
                        const id = $(this).data('id');
                        const currentIndentType = $('#indentTypeFilter').val();
                        const detailsUrl = '@Url.Action("Details", "CompounderIndent")' + '/' + id + '?indentType=' + encodeURIComponent(currentIndentType);

                        $.get(detailsUrl)
                        .done(html => {
                            modalEl.find('.modal-title').text('View ' + roleLabelPlural + ' Indent');
                            $('#modalBody').html(html);
                            modalEl.modal('show');
                        })
                        .fail(function(xhr, status, error) {
                            console.error('View request failed:', status, error);
                            showMessage('Failed to load details. Please try again.', 'error');
                        });
                    }
                });

                // Delete
                $('#tblCompounderIndents').on('click', '.delete', function () {
                    const indentType = $(this).closest('tr').find('td:eq(2)').text().trim();
                    const confirmText = indentType === 'Draft Indent' ? 'Delete this Draft?' : 'Delete this ' + roleLabelSingular + ' Indent?';

                    if (!confirm(confirmText)) return;

                    const id = $(this).data('id');
                    const deleteUrl = '@Url.Action("Delete", "CompounderIndent")';

                    $.post(deleteUrl, { id: id })
                    .done(function(response) {
                        if (response.success) {
                            tbl.ajax.reload(null, false);
                            const successText = indentType === 'Draft Indent' ? 'Draft deleted successfully.' : roleLabelSingular + ' Indent deleted successfully.';
                            showMessage(successText, 'success');
                        } else {
                            showMessage(response.message || 'Failed to delete ' + roleLabelSingular + ' Indent.', 'error');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Delete request failed:', status, error);
                        showMessage('Failed to delete ' + roleLabelSingular + ' Indent. Please try again.', 'error');
                    });
                });

                // Handle edit link in success message
                $(document).on('click', '.edit-link', function(e) {
                    e.preventDefault();
                    const id = $(this).data('id');
                    const currentIndentType = $('#indentTypeFilter').val();
                    const editUrl = '@Url.Action("Edit", "CompounderIndent")' + '/' + id + '?indentType=' + encodeURIComponent(currentIndentType);

                    $.get(editUrl)
                    .done(html => {
                        modalEl.find('.modal-title').text('Edit ' + roleLabelSingular + ' Indent - Add Medicines');
                        $('#modalBody').html(html);
                        modalEl.modal('show');
                        $('#messageArea').hide();
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Edit link request failed:', status, error);
                        showMessage('Failed to load edit form. Please try again.', 'error');
                    });
                });

                // Hide message area when modal is shown
                modalEl.on('shown.bs.modal', function() {
                    $('#messageArea').hide();
                });

                // Initialize the page state
                if (isStoreUser) {
                    // For store users, automatically load Compounder Inventory
                    $('#tblCompounderIndents').show();
                    tbl.ajax.reload();
                } else {
                    initializePageState();
                }

                // Make tbl available globally for the approve/reject modal
                window.tbl = tbl;
            }

            // Set up periodic cleanup of warning messages
            setInterval(removeWarningMessages, 1000);

            // Also remove warnings when page becomes visible
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(removeWarningMessages, 100);
                }
            });
        });
    </script>
}