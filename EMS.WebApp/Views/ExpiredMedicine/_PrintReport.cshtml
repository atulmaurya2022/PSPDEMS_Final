@model IEnumerable<EMS.WebApp.Data.ExpiredMedicine>

<div class="header">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-center">BIOMEDICAL WASTE DISPOSAL REPORT</h2>
        <h4 class="text-muted text-center">Expired Medicines Management</h4>
        <hr style="border: 1px solid #000; margin: 30px 0;">
    </div>
    <div class="row mb-4">
        <div class="col-md-6">
            <table class="table table-borderless">
                <tr>
                    <td class="fw-bold">Report Generated:</td>
                    <td>@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</td>
                </tr>
                <tr>
                    <td class="fw-bold">Generated By:</td>
                    <td>@User.Identity?.Name</td>
                </tr>
                <tr>
                    <td class="fw-bold">Total Items:</td>
                    <td class="fw-bold text-primary">@Model.Count()</td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <table class="table table-borderless">
                <tr>
                    <td class="fw-bold">Total Quantity Disposed:</td>
                    <td class="fw-bold text-success">@Model.Sum(m => m.QuantityExpired) units</td>
                </tr>
                <tr>
                    <td class="fw-bold">Report Type:</td>
                    <td>
                        @if (Model.Any(m => m.Status == "Issued to Biomedical Waste"))
                        {
                            <span class="badge bg-success">Disposal Confirmation</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Pre-Disposal Report</span>
                        }
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- NEW: Source Type Summary -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h6 class="fw-bold text-primary">Source & Medicine Type Summary</h6>
            <table class="table table-borderless table-sm">
                <tr>
                    @{
                        var storeCount = Model.Count(m => m.SourceType == "Store");
                        var compounderCount = Model.Count(m => m.SourceType == "Compounder");
                        var solidCount = Model.Count(m => m.TypeOfMedicine == "Solid");
                        var liquidCount = Model.Count(m => m.TypeOfMedicine == "Liquid");
                        var gelCount = Model.Count(m => m.TypeOfMedicine == "Gel");
                    }
                    <!-- Source Type Summary -->
                    <td class="fw-bold">Store Medicines:</td>
                    <td><span class="badge bg-primary">@storeCount items</span></td>
                    <td class="fw-bold">Compounder Medicines:</td>
                    <td><span class="badge bg-info">@compounderCount items</span></td>
                </tr>
                <tr>
                    <!-- Medicine Type Summary -->
                    <td class="fw-bold">Solid Medicines:</td>
                    <td><span class="badge bg-success">@solidCount items</span></td>
                    <td class="fw-bold">Liquid Medicines:</td>
                    <td><span class="badge bg-info">@liquidCount items</span></td>
                    <td class="fw-bold">Gel Medicines:</td>
                    <td><span class="badge bg-warning text-dark">@gelCount items</span></td>
                </tr>
            </table>
        </div>
    </div>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th style="width: 3%;">SI.No</th>
            <th style="width: 16%;">Medicine Name</th>
            <th style="width: 8%;">Company</th>
            <th style="width: 6%;">Source</th> <!-- NEW: Source column -->
            <th style="width: 6%;">Type</th>
            <th style="width: 10%;">Batch Number</th>
            <th style="width: 8%;">Vendor Code</th>
            <th style="width: 8%;">Expired On</th>
            <th style="width: 6%;">Days Overdue</th>
            <th style="width: 6%;">Qty Disposed</th>
            <th style="width: 8%;">Plant</th> <!-- NEW: Plant column -->
        </tr>
    </thead>
    <tbody>
        @{
            int counter = 1;
        }
        @foreach (var item in Model.OrderBy(m => m.SourceType).ThenBy(m => m.TypeOfMedicine).ThenBy(m => m.MedicineName).ThenBy(m => m.BatchNumber))
        {
            <tr>
                <td class="text-center">@counter</td>
                <td>@item.MedicineName</td>
                <td>@(item.CompanyName ?? "Not Defined")</td>
                <td class="text-center">
                    <!-- NEW: Source type indicator -->
                    <span class="source-indicator @(item.SourceType.ToLower())">
                        @(item.SourceType == "Store" ? "S" : "C")
                    </span>
                </td>
                <td class="text-center">
                    <span class="type-indicator @(item.TypeOfMedicine.ToLower())">
                        @item.TypeOfMedicine.Substring(0, 1).ToUpper()
                    </span>
                </td>
                <td>@item.BatchNumber</td>
                <td>@item.VendorCode</td>
                <td class="text-center">@item.ExpiryDate.ToString("dd/MM/yyyy")</td>
                <td class="text-center">
                    <span class="badge @(item.DaysOverdue <= 30 ? "bg-warning text-dark" : item.DaysOverdue <= 90 ? "bg-danger" : "bg-dark")">
                        @item.DaysOverdue
                    </span>
                </td>
                <td class="text-center">@item.QuantityExpired</td>
                <td class="text-center small">@(item.OrgPlant?.plant_name ?? "Unknown")</td>
            </tr>
            counter++;
        }
    </tbody>
    <tfoot class="table-secondary">
        <tr>
            <th colspan="11" class="text-end"></th>
        </tr>
    </tfoot>
</table>

@if (Model.Any(m => m.Status == "Issued to Biomedical Waste"))
{
    <div class="disposal-info mt-4">
        <h5 class="text-success">
            <i class="fas fa-check-circle"></i> Disposal Information
        </h5>
        <table class="table table-sm table-bordered">
            <thead class="table-success">
                <tr>
                    <th>SI.No</th>
                    <th>Medicine Name</th>
                    <th>Source</th> <!-- NEW: Source column -->
                    <th>Type</th>
                    <th>Batch Number</th>
                    <th>Disposal Date</th>
                    <th>Disposed By</th>
                    <th>Plant</th> <!-- NEW: Plant column -->
                </tr>
            </thead>
            <tbody>
                @{
                    int disposalCounter = 1;
                }
                @foreach (var item in Model.Where(m => m.Status == "Issued to Biomedical Waste").OrderBy(m => m.BiomedicalWasteIssuedDate))
                {
                    <tr>
                        <td>@disposalCounter</td>
                        <td>@item.MedicineName</td>
                        <td class="text-center">
                            <span class="source-indicator @(item.SourceType.ToLower())">
                                @(item.SourceType == "Store" ? "S" : "C")
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="type-indicator @(item.TypeOfMedicine.ToLower())">
                                @item.TypeOfMedicine.Substring(0, 1).ToUpper()
                            </span>
                        </td>
                        <td>@item.BatchNumber</td>
                        <td>@item.BiomedicalWasteIssuedDate?.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@item.BiomedicalWasteIssuedBy</td>
                        <td class="small">@(item.OrgPlant?.plant_name ?? "Unknown")</td>
                    </tr>
                    disposalCounter++;
                }
            </tbody>
        </table>
    </div>
}

<div class="footer mt-5">
    <div class="row">
        <div class="col-md-6">
            <div class="signature-section">
                <h6 class="fw-bold text-primary">Prepared By:</h6>
                <table class="table table-borderless table-sm">
                    <tr>
                        <td class="fw-bold">Name:</td>
                        <td>@User.Identity?.Name</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Date:</td>
                        <td>@DateTime.Now.ToString("dd/MM/yyyy")</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Time:</td>
                        <td>@DateTime.Now.ToString("HH:mm")</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Signature:</td>
                        <td>
                            <div style="border-bottom: 1px solid #000; width: 200px; height: 30px; margin-top: 10px;"></div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="col-md-6">
            <div class="signature-section">
                <h6 class="fw-bold text-primary">Verified & Approved By:</h6>
                <table class="table table-borderless table-sm">
                    <tr>
                        <td class="fw-bold">Name:</td>
                        <td>
                            <div style="border-bottom: 1px solid #000; width: 200px; height: 20px;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Designation:</td>
                        <td>
                            <div style="border-bottom: 1px solid #000; width: 200px; height: 20px;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Date:</td>
                        <td>
                            <div style="border-bottom: 1px solid #000; width: 200px; height: 20px;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Signature:</td>
                        <td>
                            <div style="border-bottom: 1px solid #000; width: 200px; height: 30px; margin-top: 10px;"></div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <hr style="border: 1px solid #000; margin: 30px 0;">

    <!-- NEW: Enhanced Legend with Source Types -->
    <div class="row mt-3">
        <div class="col-md-12">
            <h6 class="fw-bold text-primary">Legend:</h6>
            <table class="table table-borderless table-sm">
                <tr>
                    <td colspan="3"><strong>Source Types:</strong></td>
                </tr>
                <tr>
                    <td><span class="source-indicator store">S</span> = Store Medicines (From Store Indent)</td>
                    <td><span class="source-indicator compounder">C</span> = Compounder Medicines (From Compounder Indent)</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>Medicine Types:</strong></td>
                </tr>
                <tr>
                    <td><span class="type-indicator solid">S</span> = Solid Medicines (Tablets, Capsules, Powders)</td>
                    <td><span class="type-indicator liquid">L</span> = Liquid Medicines (Syrups, Injections, Solutions)</td>
                    <td><span class="type-indicator gel">G</span> = Gel Medicines (Creams, Ointments, Gels)</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- NEW: Compliance Note -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="compliance-note">
                <h6 class="fw-bold text-danger">Compliance Note:</h6>
                <p class="small text-muted">
                    This report certifies that all listed expired medicines have been handled according to biomedical waste management guidelines.
                    Only expired quantities have been disposed of, and all non-expired stock remains available for use.
                    This disposal ensures compliance with pharmaceutical waste regulations and environmental safety standards.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    @@media print {
        .header

    {
        border-bottom: 3px solid #000;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    table {
        font-size: 9px;
        page-break-inside: auto;
    }

    thead {
        display: table-header-group;
    }

    tfoot {
        display: table-footer-group;
    }

    tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }

    th {
        background-color: #333 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .table-success th {
        background-color: #198754 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .table-secondary {
        background-color: #f8f9fa !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .badge {
        color: black !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .type-indicator, .source-indicator {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .footer {
        border-top: 2px solid #000;
        padding-top: 20px;
        margin-top: 30px;
        page-break-inside: avoid;
    }

    body {
        margin: 0;
        padding: 15px;
    }

    }

    .header h2 {
        margin-bottom: 5px;
        color: #333;
        font-weight: 700;
    }

    .header h4 {
        margin-bottom: 0;
    }

    .footer ul {
        margin-bottom: 0;
        padding-left: 15px;
    }

    .footer li {
        margin-bottom: 5px;
        font-size: 11px;
    }

    table {
        margin-top: 10px;
        margin-bottom: 10px;
    }

    th {
        background-color: #333;
        color: white;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
    }

    td, th {
        padding: 4px 3px;
        font-size: 10px;
        vertical-align: middle;
    }

    .table-borderless td {
        border: none !important;
        padding: 2px 5px;
    }

    .fw-bold {
        font-weight: 600;
    }

    .badge {
        font-size: 8px;
        padding: 2px 4px;
    }

    .signature-section {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    /* Medicine Type Indicators */
    .type-indicator {
        display: inline-block;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        text-align: center;
        line-height: 18px;
        font-weight: bold;
        font-size: 10px;
        color: white;
    }

        .type-indicator.solid {
            background-color: #198754; /* Green for solid */
        }

        .type-indicator.liquid {
            background-color: #0dcaf0; /* Blue for liquid */
        }

        .type-indicator.gel {
            background-color: #ffc107; /* Yellow for gel */
            color: #000;
        }

    /* NEW: Source Type Indicators */
    .source-indicator {
        display: inline-block;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        text-align: center;
        line-height: 18px;
        font-weight: bold;
        font-size: 10px;
        color: white;
    }

        .source-indicator.store {
            background-color: #0d6efd; /* Blue for store */
        }

        .source-indicator.compounder {
            background-color: #0dcaf0; /* Light blue for compounder */
            color: #000;
        }

    /* Compliance note styling */
    .compliance-note {
        border: 1px solid #dee2e6;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

        .compliance-note p {
            margin-bottom: 0;
            line-height: 1.4;
        }
</style>