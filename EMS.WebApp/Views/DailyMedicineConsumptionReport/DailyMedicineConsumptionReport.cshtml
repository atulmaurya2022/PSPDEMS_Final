@{
    ViewData["Title"] = "Daily Medicine Consumption Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/css/report.css" rel="stylesheet" />
<link href="~/css/report-inventory.css" rel="stylesheet" />

<!-- Enhanced Dashboard Header -->
<div class="dashboard-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb breadcrumb-custom">
            <li class="breadcrumb-item">Reports</li>
            <li class="breadcrumb-item active" aria-current="page">Medicine Consumption Report</li>
        </ol>
    </nav>
    <h1 class="dashboard-title">
        <i class="bi bi-graph-down"></i>
        Medicine Consumption Report
    </h1>
    <p class="dashboard-subtitle">Track medicine consumption by date range with real-time stock levels and expiry management</p>
</div>

<div class="container-fluid">
    <!-- Enhanced Control Section with Date Filters -->
    <div class="report-controls-section">
        <div class="controls-row">
            <!-- Date Filter Controls -->
            <div class="control-group">
                <label class="control-label">
                    <i class="bi bi-calendar-range me-2"></i>
                    Date Range
                </label>
                <div class="filter-controls date-filter-group">
                    <div class="date-inputs">
                        <div class="date-input-wrapper">
                            <label class="date-label">From Date</label>
                            <input type="date" class="form-control date-input" id="fromDate" />
                        </div>
                        <div class="date-separator">
                            <i class="bi bi-arrow-right"></i>
                        </div>
                        <div class="date-input-wrapper">
                            <label class="date-label">To Date</label>
                            <input type="date" class="form-control date-input" id="toDate" />
                        </div>
                    </div>
                    <div class="date-buttons">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setTodayFilter()">
                            <i class="bi bi-calendar-day me-1"></i>
                            Today
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setWeekFilter()">
                            <i class="bi bi-calendar-week me-1"></i>
                            This Week
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setMonthFilter()">
                            <i class="bi bi-calendar-month me-1"></i>
                            This Month
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearDateFilter()">
                            <i class="bi bi-x-circle me-1"></i>
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="control-actions">
                <button type="button" class="btn btn-primary btn-enhanced" onclick="loadReport()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Generate Report
                </button>
                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button type="button" class="btn btn-secondary btn-enhanced" onclick="exportReport()">
                        <i class="bi bi-download"></i>
                        Export
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-enhanced" onclick="printReport()">
                        <i class="bi bi-printer"></i>
                        Print
                    </button>
                </div>
            </div>
        </div>

        <!-- Date Range Display -->
        <div class="controls-row mt-2" id="dateRangeDisplay" style="display: none;">
            <div class="alert alert-info alert-sm d-flex align-items-center">
                <i class="bi bi-calendar-check me-2"></i>
                <span id="currentDateRangeText">Loading date range...</span>
            </div>
        </div>
    </div>

    <!-- Enhanced Report Summary Cards -->
    <div id="reportSummary" class="inventory-summary-grid" style="display: none;">
        <div class="summary-card" data-category="total-records">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Total Medicines</h6>
                    <div class="summary-icon">
                        <i class="bi bi-capsule"></i>
                    </div>
                </div>
                <div class="summary-value" id="totalRecords">0</div>
                <div class="summary-subtitle">Medicine types</div>
            </div>
        </div>

        <div class="summary-card" data-category="available-stock">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Current Stock</h6>
                    <div class="summary-icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                </div>
                <div class="summary-value" id="totalStockInInventory">0</div>
                <div class="summary-subtitle">Units available</div>
            </div>
        </div>

        <div class="summary-card" data-category="consumed-stock">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Consumed Qty</h6>
                    <div class="summary-icon">
                        <i class="bi bi-arrow-up-circle"></i>
                    </div>
                </div>
                <div class="summary-value consumed-value" id="totalIssuedQty">0</div>
                <div class="summary-subtitle">Units consumed in period</div>
            </div>
        </div>

        <div class="summary-card" data-category="expired-stock">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Expired Stock</h6>
                    <div class="summary-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="summary-value expired-value" id="totalExpiredQty">0</div>
                <div class="summary-subtitle">Units expired</div>
            </div>
        </div>
    </div>

    <!-- Enhanced Plant Information -->
    <div id="plantInfo" class="plant-info-section" style="display: none;">
        <div class="plant-info-content">
            <div class="plant-info-header">
                <i class="bi bi-building me-2"></i>
                <h6 class="plant-info-title">Plant Information</h6>
            </div>
            <div class="plant-info-details">
                <div class="plant-detail-item">
                    <span class="plant-detail-label">Plant Code:</span>
                    <span class="plant-detail-value" id="currentPlantCode">-</span>
                </div>
                <div class="plant-detail-separator"></div>
                <div class="plant-detail-item">
                    <span class="plant-detail-label">Plant Name:</span>
                    <span class="plant-detail-value" id="currentPlantName">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Report Header -->
    <div id="reportHeader" class="report-header-section" style="display: none;">
        <div class="report-header-content">
            <div class="company-info">
                <h4 id="unitHeader">Unit: ITC LIMITED - PSPD-N/A</h4>
                <div class="report-meta">
                    <span class="meta-item">
                        <i class="bi bi-clock me-1"></i>
                        Generated: <span id="runDateTime"></span>
                    </span>
                    <span class="meta-item">
                        <i class="bi bi-person me-1"></i>
                        By: <span id="generatedBy"></span>
                    </span>
                    <span class="meta-item period-display">
                        <i class="bi bi-calendar-range me-1"></i>
                        <span id="reportPeriod">Today's Consumption</span>
                    </span>
                </div>
            </div>
            <div class="report-title">
                <h3>MEDICINE CONSUMPTION REPORT</h3>
                <p class="report-subtitle" id="reportSubtitle">Today's Overview</p>
            </div>
        </div>
    </div>

    <!-- Enhanced Search Section -->
    <div id="searchSection" class="search-controls-section" style="display: none;">
        <div class="search-wrapper">
            <div class="search-input-group">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="form-control search-input-enhanced" id="searchInput"
                       placeholder="Search by medicine name...">
                <button type="button" class="btn btn-clear" onclick="clearSearch()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="search-results-info">
                <small class="text-muted" id="searchResultCount">No search applied</small>
            </div>
        </div>
    </div>

    <!-- Enhanced Report Table -->
    <div id="reportTableSection" class="inventory-table-section" style="display: none;">
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-striped table-glass glass-table table-sm" id="reportTable">
                    <thead>
                        <tr>
                            <th class="col-sl">SL NO</th>
                            <th class="col-medicine-name">MEDICINE NAME</th>
                            <th class="col-available">TOTAL STOCK IN COMPOUNDER INVENTORY</th>
                            <th class="col-consumed consumption-header">ISSUED QTY</th>
                            <th class="col-expired text-center">EXPIRED QTY</th>
                        </tr>
                    </thead>
                    <tbody id="reportData">
                        <!-- Data will be populated here -->
                    </tbody>
                    <tfoot>
                        <tr class="inventory-table-footer">
                            <th colspan="2" class="text-end">Totals:</th>
                            <th id="footerTotalStock" class="total-value">0</th>
                            <th id="footerTotalConsumed" class="total-value consumed-total">0</th>
                            <th id="footerTotalExpired" class="total-value expired-total">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Enhanced No Data State -->
    <div id="noDataMessage" class="empty-state-section" style="display: none;">
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-clipboard-data"></i>
            </div>
            <h6 class="empty-state-title">No Consumption Data Found</h6>
            <p class="empty-state-description">
                No medicine consumption found for the selected date range.<br>
                Try selecting a different date range or refresh the data.
            </p>
            <div class="empty-state-actions">
                <button type="button" class="btn btn-outline-primary btn-enhanced" onclick="setTodayFilter()">
                    <i class="bi bi-calendar-day"></i>
                    View Today's Data
                </button>
                <button type="button" class="btn btn-outline-secondary btn-enhanced" onclick="clearDateFilter()">
                    <i class="bi bi-x-circle"></i>
                    Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Loading State -->
    <div id="loadingSpinner" class="loading-state-section" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner-inventory"></div>
            <h6 class="loading-title">Loading Consumption Data</h6>
            <p class="loading-description" id="loadingDescription">Fetching consumption report...</p>
        </div>
    </div>
</div>

<!-- Additional CSS for date filters -->
<style>
    .date-filter-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .date-inputs {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .date-input-wrapper {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .date-label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
    }

    .date-input {
        min-width: 150px;
    }

    .date-separator {
        color: #6c757d;
        margin-top: 20px;
    }

    .date-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .consumption-header {
        background: linear-gradient(135deg, #ff6b35, #ff8c69);
        color: white;
    }

    .consumed-value {
        color: #ff6b35;
        font-weight: bold;
    }

    .expired-value {
        color: #dc3545;
        font-weight: bold;
    }

    .consumed-total {
        color: #ff6b35;
        font-weight: bold;
    }

    .expired-total {
        color: #dc3545;
        font-weight: bold;
    }

    .period-display {
        background: rgba(13, 110, 253, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        color: #0d6efd;
    }

    .alert-sm {
        padding: 8px 12px;
        font-size: 0.875rem;
    }

    @@media (max-width: 768px) {
        .date-inputs

    {
        flex-direction: column;
        gap: 10px;
    }

    .date-separator {
        transform: rotate(90deg);
        margin: 0;
    }

    .date-buttons {
        justify-content: center;
    }

    }
</style>

@section Scripts {
    <script>
        var allReportData = []; // Store all data for filtering
        var currentFilteredData = []; // Store currently filtered data
        var currentReportInfo = {}; // Store current report info

        $(document).ready(function() {
            // Set default to today's date
            setTodayFilter();

            // Search input event with debounce
            $('#searchInput').on('input', debounce(function() {
                applyFilters();
            }, 300));

            // Date change events
            $('#fromDate, #toDate').on('change', function() {
                validateDateRange();
            });
        });

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function validateDateRange() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            if (fromDate && toDate && fromDate > toDate) {
                showAlert('warning', 'From date cannot be later than To date', 'Invalid Date Range');
                $('#toDate').val(fromDate);
            }
        }

        function setTodayFilter() {
            var today = new Date().toISOString().split('T')[0];
            $('#fromDate').val(today);
            $('#toDate').val(today);
            loadReport();
        }

        function setWeekFilter() {
            var today = new Date();
            var firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
            var lastDay = new Date(firstDay);
            lastDay.setDate(firstDay.getDate() + 6);

            $('#fromDate').val(firstDay.toISOString().split('T')[0]);
            $('#toDate').val(lastDay.toISOString().split('T')[0]);
            loadReport();
        }

        function setMonthFilter() {
            var today = new Date();
            var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            var lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            $('#fromDate').val(firstDay.toISOString().split('T')[0]);
            $('#toDate').val(lastDay.toISOString().split('T')[0]);
            loadReport();
        }

        function clearDateFilter() {
            $('#fromDate').val('');
            $('#toDate').val('');
            loadReport();
        }

        function loadReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            // Default to today if no dates
            if (!fromDate && !toDate) {
                var today = new Date().toISOString().split('T')[0];
                fromDate = toDate = today;
                $('#fromDate').val(fromDate);
                $('#toDate').val(toDate);
            } else if (!toDate && fromDate) {
                $('#toDate').val(fromDate);
                toDate = fromDate;
            } else if (!fromDate && toDate) {
                $('#fromDate').val(toDate);
                fromDate = toDate;
            }

            // Update loading description
            var loadingDesc = 'Fetching consumption report';
            if (fromDate === toDate) {
                var displayDate = new Date(fromDate).toLocaleDateString();
                loadingDesc += ` for ${displayDate}...`;
            } else {
                var fromDisplay = new Date(fromDate).toLocaleDateString();
                var toDisplay = new Date(toDate).toLocaleDateString();
                loadingDesc += ` from ${fromDisplay} to ${toDisplay}...`;
            }
            $('#loadingDescription').text(loadingDesc);

            // Show loading state
            $('#loadingSpinner').show();
            $('#reportTableSection').hide();
            $('#reportHeader').hide();
            $('#reportSummary').hide();
            $('#plantInfo').hide();
            $('#noDataMessage').hide();
            $('#searchSection').hide();
            $('#actionButtons').hide();
            $('#dateRangeDisplay').hide();

            $.ajax({
                url: '@Url.Action("GetReport", "DailyMedicineConsumptionReport")',
                type: 'GET',
                data: {
                    fromDate: fromDate,
                    toDate: toDate
                },
                success: function(response) {
                    $('#loadingSpinner').hide();

                    if (response.success && response.data && response.data.length > 0) {
                        allReportData = response.data;
                        currentFilteredData = [...allReportData];
                        currentReportInfo = response.reportInfo;

                        applyFilters();
                        updateReportHeader(response.reportInfo);
                        updateSummaryCards(response.reportInfo);
                        updatePlantInfo(response.reportInfo);
                        updateDateRangeDisplay(response.reportInfo);

                        // Show all sections with animation
                        $('#dateRangeDisplay').fadeIn(200);
                        $('#reportSummary').fadeIn(300);
                        setTimeout(() => $('#plantInfo').fadeIn(300), 100);
                        setTimeout(() => $('#reportHeader').fadeIn(300), 200);
                        setTimeout(() => $('#searchSection').fadeIn(300), 300);
                        setTimeout(() => $('#reportTableSection').fadeIn(300), 400);
                        setTimeout(() => $('#actionButtons').fadeIn(300), 500);

                        var periodDesc = response.reportInfo.isSingleDay ?
                            (response.reportInfo.isToday ? "today" : "the selected date") :
                            "the selected period";

                        showAlert('success',
                            `Consumption report loaded with ${response.data.length} medicines for ${periodDesc}`,
                            'Report Ready');
                    } else {
                        updateDateRangeDisplay(response.reportInfo);
                        $('#dateRangeDisplay').fadeIn(200);
                        $('#noDataMessage').fadeIn(300);

                        var periodDesc = response.reportInfo?.isSingleDay ?
                            (response.reportInfo.isToday ? "today" : "the selected date") :
                            "the selected date range";

                        showAlert('info', `No consumption data found for ${periodDesc}`, 'No Results');
                    }
                },
                error: function(xhr, status, error) {
                    $('#loadingSpinner').hide();
                    $('#noDataMessage').show();
                    showAlert('danger', 'Error loading consumption report: ' + error, 'Load Error');
                }
            });
        }

        function updateDateRangeDisplay(reportInfo) {
            if (reportInfo) {
                $('#currentDateRangeText').text(reportInfo.reportPeriod);
            }
        }

        function applyFilters() {
            var searchText = $('#searchInput').val().toLowerCase().trim();
            var filteredData = allReportData;

            // Apply search filter
            if (searchText) {
                filteredData = filteredData.filter(function(item) {
                    return (item.medicineName || '').toLowerCase().includes(searchText);
                });
            }

            currentFilteredData = filteredData;
            populateReportTable(filteredData);
            updateSearchResultCount(filteredData.length);
        }

        function updateSearchResultCount(count) {
            var searchText = $('#searchInput').val().trim();

            if (searchText) {
                var filterInfo = `${count} of ${allReportData.length} medicines found`;
                $('#searchResultCount').text(filterInfo);

                if (count === 0) {
                    $('#searchResultCount').addClass('text-warning').removeClass('text-muted');
                } else {
                    $('#searchResultCount').addClass('text-success').removeClass('text-muted text-warning');
                }
            } else {
                $('#searchResultCount').text('No search applied').removeClass('text-warning text-success').addClass('text-muted');
            }
        }

        function clearSearch() {
            $('#searchInput').val('');
            applyFilters();
            showAlert('info', 'Search cleared', 'Filter Reset');
        }

        function populateReportTable(data) {
            var tbody = $('#reportData');
            tbody.empty();
            var totalStock = 0;
            var totalConsumed = 0;
            var totalExpired = 0;

            $.each(data, function(index, item) {
                var rowClass = '';
                var consumedBadgeClass = 'quantity-badge';
                var expiredBadgeClass = 'quantity-badge';

                // Highlight rows with consumption or expired stock
                if (item.issuedQty > 0 && item.expiredQty > 0) {
                    rowClass = 'row-warning'; // Both consumed and expired
                    consumedBadgeClass = 'quantity-badge consumed';
                    expiredBadgeClass = 'quantity-badge unavailable';
                } else if (item.issuedQty > 0) {
                    consumedBadgeClass = 'quantity-badge consumed';
                } else if (item.expiredQty > 0) {
                    rowClass = 'row-danger';
                    expiredBadgeClass = 'quantity-badge unavailable';
                }

                totalStock += Number(item.totalStockInCompounderInventory || 0);
                totalConsumed += Number(item.issuedQty || 0);
                totalExpired += Number(item.expiredQty || 0);

                var row = `<tr class="inventory-table-row ${rowClass}">
                    <td class="sl-cell">${index + 1}</td>
                    <td class="medicine-cell">
                        <span class="medicine-name">${item.medicineName || ''}</span>
                    </td>
                    <td class="quantity-cell">
                        <span class="quantity-badge available">${item.totalStockInCompounderInventory || 0}</span>
                    </td>
                    <td class="quantity-cell">
                        <span class="${consumedBadgeClass}">${item.issuedQty || 0}</span>
                    </td>
                    <td class="quantity-cell">
                        <span class="${expiredBadgeClass}">${item.expiredQty || 0}</span>
                        ${item.expiredQty > 0 ? '<i class="bi bi-exclamation-triangle ms-1 text-danger"></i>' : ''}
                    </td>
                </tr>`;
                tbody.append(row);
            });

            // Update footer totals with animation
            animateFooterValue('footerTotalStock', totalStock);
            animateFooterValue('footerTotalConsumed', totalConsumed);
            animateFooterValue('footerTotalExpired', totalExpired);
        }

        function animateFooterValue(elementId, newValue) {
            $('#' + elementId).fadeOut(150, function() {
                $(this).text(newValue.toLocaleString()).fadeIn(150);
            });
        }

        function updateReportHeader(reportInfo) {
            $('#runDateTime').text(reportInfo.generatedOn);
            $('#generatedBy').text(reportInfo.generatedBy);
            $('#reportPeriod').text(reportInfo.reportPeriod);

            // Update subtitle based on date range
            var subtitle = reportInfo.isSingleDay ?
                (reportInfo.isToday ? "Today's Overview" : "Single Day Overview") :
                "Date Range Overview";
            $('#reportSubtitle').text(subtitle);

            // Dynamic unit header with plant code
            var unitText = 'Unit: ITC LIMITED - PSPD-' + (reportInfo.plantCode || 'N/A');
            if (reportInfo.plantName && reportInfo.plantName !== 'Unknown Plant') {
                unitText += ' (' + reportInfo.plantName + ')';
            }
            $('#unitHeader').text(unitText);
        }

        function updateSummaryCards(reportInfo) {
            // Animate card values
            animateValue('totalRecords', 0, reportInfo.totalRecords, 1000);
            animateValue('totalStockInInventory', 0, reportInfo.totalStockInInventory, 1100);
            animateValue('totalIssuedQty', 0, reportInfo.totalIssuedQty, 1200);
            animateValue('totalExpiredQty', 0, reportInfo.totalExpiredQty, 1300);
        }

        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const startTime = performance.now();

            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (end - start) * progress);

                element.textContent = current.toLocaleString();

                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                }
            }

            requestAnimationFrame(updateValue);
        }

        function updatePlantInfo(reportInfo) {
            $('#currentPlantCode').text(reportInfo.plantCode || 'N/A');
            $('#currentPlantName').text(reportInfo.plantName || 'Unknown Plant');
        }

        function exportReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            var exportDesc = 'Preparing consumption export';
            if (fromDate === toDate) {
                exportDesc += ' for ' + new Date(fromDate).toLocaleDateString();
            } else {
                exportDesc += ' for selected period';
            }

            showAlert('info', exportDesc + '...', 'Export Started');

            var exportUrl = '@Url.Action("Export", "DailyMedicineConsumptionReport")';
            var params = new URLSearchParams();
            if (fromDate) params.append('fromDate', fromDate);
            if (toDate) params.append('toDate', toDate);

            window.location.href = exportUrl + '?' + params.toString();
        }

        function printReport() {
            if ($('#reportTableSection').is(':visible')) {
                showAlert('info', 'Preparing print view...', 'Print Started');
                setTimeout(() => window.print(), 500);
            } else {
                showAlert('warning', 'Please load the report first', 'Print Failed');
            }
        }

        // Enhanced alert system integration
        function showAlert(type, message, title = null) {
            // Integration with your existing alert system
            console.log(`${title || type.toUpperCase()}: ${message}`);

            // If you have a global showAlert function, uncomment:
            // if (typeof window.showAlert === 'function') {
            //     window.showAlert(type, message, title);
            // }
        }
    </script>
}