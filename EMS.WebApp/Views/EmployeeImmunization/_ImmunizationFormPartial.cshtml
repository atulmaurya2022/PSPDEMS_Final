@model EMS.WebApp.Data.ImmunizationViewModel

<style>
    .glass {
        --glass-bg: rgba(255, 255, 255, 0.30) !important;
    }

    .dose-field:disabled {
        background-color: #f8f9fa;
        opacity: 0.6;
    }

    .dose-info-badge {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-weight: 500;
    }

    .next-dose-highlight {
        border: 2px solid #0d6efd !important;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
</style>

<!-- Employee Details Section -->
<div id="employeeDetailsSection" class="mb-3">
    @for (int i = 0; i < Model.EmployeeDetails.Count; i++)
    {
        <div class="border p-3 mb-3 rounded glass">
            <h6>Employee Details</h6>
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Employee ID:</label>
                    <div class="form-control-plaintext">@Model.EmployeeDetails[i].emp_id</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Name:</label>
                    <div class="form-control-plaintext">@Model.EmployeeDetails[i].emp_name</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Department:</label>
                    <div class="form-control-plaintext">@(Model.EmployeeDetails[i].org_department?.dept_name ?? "")</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Grade:</label>
                    <div class="form-control-plaintext">@Model.EmployeeDetails[i].emp_Grade</div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Dose Progress Info Section -->
<div id="doseProgressSection" class="mb-3" style="display: none;">
    <div class="alert alert-info d-flex align-items-center">
        <i class="bi bi-info-circle-fill me-2"></i>
        <div>
            <strong>Dose Progress:</strong>
            <span id="doseProgressText"></span>
        </div>
    </div>
</div>

<!-- Immunization Record Form Section (Initially Hidden) -->
<div id="immunizationRecordSection" style="display: none;">
    <form asp-action="SaveImmunizationRecord" asp-controller="EmployeeImmunization" method="post" id="immunizationForm" data-ajax="true">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="EmpNo" />
        <input type="hidden" asp-for="RecordId" id="RecordId" />
        <input type="hidden" asp-for="IsNewEntry" id="IsNewEntry" value="true" />
        <input type="hidden" asp-for="PlantId" />
        <input type="hidden" asp-for="ImmunizationTypeId" id="ImmunizationTypeId" />
        <input type="hidden" id="CurrentNextDose" value="" />


        <div class="border p-3 mb-3 rounded glass">
            <h6>Immunization Record</h6>

            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Name of Patient <span class="text-danger">*</span></label>
                    <select class="form-select rounded-2 glass" id="PatientNameSelect" name="PatientName">
                        <option value="">--Select--</option>
                        @foreach (var option in Model.PatientOptions)
                        {
                            if (option.IsSelf)
                            {
                                <option value="@option.Name" data-relationship="@option.Relationship" data-is-self="true">@option.Name (Self)</option>
                            }
                            else
                            {
                                <option value="@option.Name" data-relationship="@option.Relationship" data-is-self="false">@option.Name (@option.Relationship)</option>
                            }
                        }
                    </select>
                    <span asp-validation-for="PatientName" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Relationship" class="form-label">Relationship</label>
                    <input asp-for="Relationship" class="form-control rounded-2 glass" id="Relationship" readonly />
                    <span asp-validation-for="Relationship" class="text-danger"></span>
                </div>
            </div>

            <!-- Dose Instructions -->
            <div id="doseInstructions" class="row mt-3" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="doseInstructionText">Please complete doses in sequence.</span>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-2">
                    <label asp-for="Dose1Date" class="form-label">
                        1st Dose
                        <span id="dose1Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose1Date" type="date" class="form-control rounded-2 glass dose-field" id="Dose1Date" data-dose-number="1" />
                    <span asp-validation-for="Dose1Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose2Date" class="form-label">
                        2nd Dose
                        <span id="dose2Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose2Date" type="date" class="form-control rounded-2 glass dose-field" id="Dose2Date" data-dose-number="2" />
                    <span asp-validation-for="Dose2Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose3Date" class="form-label">
                        3rd Dose
                        <span id="dose3Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose3Date" type="date" class="form-control rounded-2 glass dose-field" id="Dose3Date" data-dose-number="3" />
                    <span asp-validation-for="Dose3Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose4Date" class="form-label">
                        4th Dose
                        <span id="dose4Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose4Date" type="date" class="form-control rounded-2 glass dose-field" id="Dose4Date" data-dose-number="4" />
                    <span asp-validation-for="Dose4Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose5Date" class="form-label">
                        5th Dose
                        <span id="dose5Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose5Date" type="date" class="form-control rounded-2 glass dose-field" id="Dose5Date" data-dose-number="5" />
                    <span asp-validation-for="Dose5Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="BoosterDoseDate" class="form-label">
                        Booster Dose
                        <span id="dose6Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="BoosterDoseDate" type="date" class="form-control rounded-2 glass dose-field" id="BoosterDoseDate" data-dose-number="6" />
                    <span asp-validation-for="BoosterDoseDate" class="text-danger"></span>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <label asp-for="Remarks" class="form-label">Remarks</label>
                    <textarea asp-for="Remarks" class="form-control rounded-2 glass" rows="2" id="Remarks"></textarea>
                    <span asp-validation-for="Remarks" class="text-danger"></span>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn btn-primary me-2" id="saveBtn">Save</button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Action Buttons Section -->
<div id="actionButtonsSection" class="mb-3">
    <div class="row">
        <div class="col-12">
            <button type="button" class="btn btn-success me-2" id="addRecordBtn">Add</button>
            <button type="button" class="btn btn-outline-secondary" id="cancelRecordBtn">Cancel</button>
        </div>
    </div>
</div>

<!-- Existing Records Table Section -->
<div id="existingRecordsSection" class="mb-3">
    @if (Model.ExistingRecords.Any())
    {
        <div class="border p-3 mb-3 rounded glass">
            <h6>Existing Immunization Records</h6>
            <div class="table-responsive">
                <table class="table table-striped table-glass glass-table">
                    <thead class="table-light">
                        <tr>
                            <th>Immunization Type</th>
                            <th>Name Of Patient</th>
                            <th>Relationship</th>
                            @* <th>Status</th> *@
                            <th>1st Dose</th>
                            <th>2nd Dose</th>
                            <th>3rd Dose</th>
                            <th>4th Dose</th>
                            <th>5th Dose</th>
                            <th>Booster Dose</th>
                            <th>Remarks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in Model.ExistingRecords)
                        {
                            // Calculate completion status
                            @* var isComplete = record.dose_1_date.HasValue &&
                            record.dose_2_date.HasValue &&
                            record.dose_3_date.HasValue &&
                            record.dose_4_date.HasValue &&
                            record.dose_5_date.HasValue &&
                            record.booster_dose_date.HasValue; *@
                            <tr>
                                <td>@(record.RefImmunizationType?.immun_type_name ?? "")</td>
                                <td>@record.patient_name</td>
                                <td>@record.relationship</td>
                                @* <td>
                                    @if (isComplete)
                                    {
                                        <span class="badge bg-success">Complete</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">In Progress</span>
                                    }
                                </td> *@
                                <td>@(record.dose_1_date?.ToString("dd/MM/yyyy") ?? "")</td>
                                <td>@(record.dose_2_date?.ToString("dd/MM/yyyy") ?? "")</td>
                                <td>@(record.dose_3_date?.ToString("dd/MM/yyyy") ?? "")</td>
                                <td>@(record.dose_4_date?.ToString("dd/MM/yyyy") ?? "")</td>
                                <td>@(record.dose_5_date?.ToString("dd/MM/yyyy") ?? "")</td>
                                <td>@(record.booster_dose_date?.ToString("dd/MM/yyyy") ?? "")</td>
                                <td>@record.remarks</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-record"
                                            data-record-id="@record.immun_record_uid" title="Edit">
                                        <i class="bi bi-pencil fs-6"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-record"
                                            data-record-id="@record.immun_record_uid" title="Delete">
                                        <i class="bi bi-trash fs-6"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="border p-3 mb-3 rounded glass">
            <h6>Existing Immunization Records</h6>
            <p class="text-muted text-center py-3">No Records exist</p>
        </div>
    }
</div>


<script>
    $(document).ready(function() {
        // Global variables for tracking current state
        let currentNextDose = 0;
        let isExistingRecord = false;

        // Initialize form when the immunization record section is shown
        initializeForm();

        // Patient name dropdown change event
        $('#PatientNameSelect').on('change', function () {
            var selectedOption = $(this).find('option:selected');
            var relationship = selectedOption.data('relationship') || '';
            var isSelf = selectedOption.data('is-self') === 'true';

            $('#Relationship').val(relationship);

            // Disable/enable relationship field based on selection
            if (isSelf) {
                $('#Relationship').prop('readonly', true).addClass('bg-light');
            } else {
                $('#Relationship').prop('readonly', false).removeClass('bg-light');
            }

            // Check for existing record when both patient and immunization type are selected
            // Use the global function if available, otherwise try local scope
            if (typeof window.checkForExistingRecord === 'function') {
                console.log('Calling global checkForExistingRecord function');
                window.checkForExistingRecord();
            } else if (typeof checkForExistingRecord === 'function') {
                console.log('Calling local checkForExistingRecord function');
                checkForExistingRecord();
            } else {
                console.log('checkForExistingRecord function not found');
            }
        });

        function initializeForm() {
            // Set default selection to "Self" if no patient is selected
            var currentSelection = $('#PatientNameSelect').val();
            if (!currentSelection || currentSelection === '') {
                $('#PatientNameSelect option[data-is-self="true"]').prop('selected', true);
            }

            // Trigger change event for current selection
            $('#PatientNameSelect').trigger('change');

            // Initialize dose fields
            manageDoseFields();
        }


        function checkForExistingRecord() {
            var patientName = $('#PatientNameSelect').val();
            var immunizationTypeId = $('#ImmunizationTypeId').val();
            var empNo = $('input[name="EmpNo"]').val();

            if (!patientName || !immunizationTypeId || !empNo) {
                return;
            }

            // Make AJAX call to check for existing record
            $.ajax({
                url: '@Url.Action("CheckExistingRecord", "EmployeeImmunization")',
                type: 'POST',
                data: {
                    empNo: empNo,
                    immunizationTypeId: immunizationTypeId,
                    patientName: patientName
                },
                success: function(result) {
                    if (result.exists) {
                        isExistingRecord = true;
                        $('#RecordId').val(result.recordId);
                        $('#IsNewEntry').val('false');

                        // POPULATE THE DOSE DATE FIELDS WITH ACTUAL VALUES
                        $('#Dose1Date').val(result.dose1Date || '');
                        $('#Dose2Date').val(result.dose2Date || '');
                        $('#Dose3Date').val(result.dose3Date || '');
                        $('#Dose4Date').val(result.dose4Date || '');
                        $('#Dose5Date').val(result.dose5Date || '');
                        $('#BoosterDoseDate').val(result.boosterDoseDate || '');
                        $('#Remarks').val(result.remarks || '');

                        if (result.isComplete) {
                            showDoseProgress(result.message, 'success');
                            // Enable all fields for editing completed records
                            manageDoseFieldsForExistingRecord(result.nextDose);
                            $('#saveBtn').prop('disabled', false).text('Update Record');
                        } else {
                            currentNextDose = result.nextDose.doseNumber;
                            $('#CurrentNextDose').val(currentNextDose);
                            showDoseProgress(result.message, 'info');
                            manageDoseFieldsForExistingRecord(result.nextDose);
                            $('#saveBtn').prop('disabled', false).text('Save Next Dose');
                        }
                    } else {
                        isExistingRecord = false;
                        $('#RecordId').val('');
                        $('#IsNewEntry').val('true');
                        currentNextDose = 1;
                        $('#CurrentNextDose').val(currentNextDose);

                        // CLEAR ALL DOSE FIELDS FOR NEW RECORD
                        $('#Dose1Date').val('');
                        $('#Dose2Date').val('');
                        $('#Dose3Date').val('');
                        $('#Dose4Date').val('');
                        $('#Dose5Date').val('');
                        $('#BoosterDoseDate').val('');
                        $('#Remarks').val('');

                        hideDoseProgress();
                        manageDoseFields();
                        $('#saveBtn').prop('disabled', false).text('Save');
                    }
                },
                error: function() {
                    console.log('Error checking for existing record');
                    // Default to new record behavior
                    isExistingRecord = false;
                    manageDoseFields();
                }
            });
        }


        function showDoseProgress(message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-info';
            $('#doseProgressSection .alert').removeClass('alert-info alert-success').addClass(alertClass);
            $('#doseProgressText').text(message);
            $('#doseProgressSection').show();
        }

        function hideDoseProgress() {
            $('#doseProgressSection').hide();
        }

        function manageDoseFields() {
            if (isExistingRecord) {
                return; // Let the existing record logic handle this
            }

            var dose1 = $('#Dose1Date').val();
            var dose2 = $('#Dose2Date').val();
            var dose3 = $('#Dose3Date').val();
            var dose4 = $('#Dose4Date').val();
            var dose5 = $('#Dose5Date').val();
            var booster = $('#BoosterDoseDate').val();

            // ENABLE ALL FIELDS
            $('.dose-field').prop('disabled', false).removeClass('bg-light next-dose-highlight');
            $('.badge').removeClass('bg-primary bg-success bg-warning bg-danger bg-info').hide();

            // Show status badges
            if (dose1) {
                $('#dose1Badge').text('DONE').addClass('bg-success').show();
            } else {
                $('#dose1Badge').text('NEXT').addClass('bg-primary').show();
                $('#Dose1Date').addClass('next-dose-highlight');
            }

            if (dose2) {
                $('#dose2Badge').text('DONE').addClass('bg-success').show();
            } else if (dose1) {
                $('#dose2Badge').text('NEXT').addClass('bg-primary').show();
                $('#Dose2Date').addClass('next-dose-highlight');
            }

            if (dose3) {
                $('#dose3Badge').text('DONE').addClass('bg-success').show();
            } else if (dose2) {
                $('#dose3Badge').text('NEXT').addClass('bg-primary').show();
                $('#Dose3Date').addClass('next-dose-highlight');
            }

            if (dose4) {
                $('#dose4Badge').text('DONE').addClass('bg-success').show();
            } else if (dose3) {
                $('#dose4Badge').text('NEXT').addClass('bg-primary').show();
                $('#Dose4Date').addClass('next-dose-highlight');
            }

            if (dose5) {
                $('#dose5Badge').text('DONE').addClass('bg-success').show();
            } else if (dose4) {
                $('#dose5Badge').text('NEXT').addClass('bg-primary').show();
                $('#Dose5Date').addClass('next-dose-highlight');
            }

            if (booster) {
                $('#dose6Badge').text('DONE').addClass('bg-success').show();
            } else if (dose5) {
                $('#dose6Badge').text('NEXT').addClass('bg-primary').show();
                $('#BoosterDoseDate').addClass('next-dose-highlight');
            }

            showDoseInstructions('All entered doses can be edited. Fill doses in sequence.');
        }

        function manageDoseFieldsForExistingRecord(nextDoseInfo) {
            // ENABLE ALL FIELDS for editing
            $('.dose-field').prop('disabled', false).removeClass('next-dose-highlight');
            $('.badge').removeClass('bg-primary bg-success bg-warning bg-danger bg-info').hide();

            // Show status for all doses
            var dose1 = $('#Dose1Date').val();
            var dose2 = $('#Dose2Date').val();
            var dose3 = $('#Dose3Date').val();
            var dose4 = $('#Dose4Date').val();
            var dose5 = $('#Dose5Date').val();
            var booster = $('#BoosterDoseDate').val();

            if (dose1) $('#dose1Badge').text('DONE').addClass('bg-success').show();
            else { $('#dose1Badge').text('NEXT').addClass('bg-primary').show(); $('#Dose1Date').addClass('next-dose-highlight'); }

            if (dose2) $('#dose2Badge').text('DONE').addClass('bg-success').show();
            else if (dose1) { $('#dose2Badge').text('NEXT').addClass('bg-primary').show(); $('#Dose2Date').addClass('next-dose-highlight'); }

            if (dose3) $('#dose3Badge').text('DONE').addClass('bg-success').show();
            else if (dose2) { $('#dose3Badge').text('NEXT').addClass('bg-primary').show(); $('#Dose3Date').addClass('next-dose-highlight'); }

            if (dose4) $('#dose4Badge').text('DONE').addClass('bg-success').show();
            else if (dose3) { $('#dose4Badge').text('NEXT').addClass('bg-primary').show(); $('#Dose4Date').addClass('next-dose-highlight'); }

            if (dose5) $('#dose5Badge').text('DONE').addClass('bg-success').show();
            else if (dose4) { $('#dose5Badge').text('NEXT').addClass('bg-primary').show(); $('#Dose5Date').addClass('next-dose-highlight'); }

            if (booster) $('#dose6Badge').text('DONE').addClass('bg-success').show();
            else if (dose5) { $('#dose6Badge').text('NEXT').addClass('bg-primary').show(); $('#BoosterDoseDate').addClass('next-dose-highlight'); }

            showDoseInstructions('All entered doses can be edited. Fill doses in sequence.');
        }
        function getDoseFieldById(doseNumber) {
            var fields = {
                1: $('#Dose1Date'),
                2: $('#Dose2Date'),
                3: $('#Dose3Date'),
                4: $('#Dose4Date'),
                5: $('#Dose5Date'),
                6: $('#BoosterDoseDate')
            };
            return fields[doseNumber];
        }

        function getDoseBadgeById(doseNumber) {
            var badges = {
                1: $('#dose1Badge'),
                2: $('#dose2Badge'),
                3: $('#dose3Badge'),
                4: $('#dose4Badge'),
                5: $('#dose5Badge'),
                6: $('#dose6Badge')
            };
            return badges[doseNumber];
        }

        function disableAllDoseFields() {
            $('.dose-field').prop('disabled', true).removeClass('next-dose-highlight');
            $('.badge').hide();
        }

        function showDoseInstructions(customText) {
            var text = customText || 'Please complete doses in sequence. Only the highlighted dose field can be filled.';
            $('#doseInstructionText').text(text);
            $('#doseInstructions').show();
        }

        // Dose field change events
        $('.dose-field').on('change', function() {
            if (!isExistingRecord) {
                manageDoseFields();
            }
        });

        // Make initializeForm available globally
        window.initializeForm = function() {
            initializeForm();
            checkForExistingRecord();
        };
    });
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}