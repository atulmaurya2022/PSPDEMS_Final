@model EMS.WebApp.Data.ImmunizationViewModel

<style>
    .glass {
        --glass-bg: rgba(255, 255, 255, 0.30) !important;
    }

    .dose-field:disabled {
        background-color: #f8f9fa;
        opacity: 0.6;
    }

    .dose-info-badge {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-weight: 500;
    }

    .next-dose-highlight {
        border: 2px solid #0d6efd !important;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .edit-mode-badge {
        background-color: #0d6efd;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 600;
    }
</style>

<!-- Employee Details Section -->
<div id="employeeDetailsSection" class="mb-3">
    @for (int i = 0; i < Model.EmployeeDetails.Count; i++)
    {
        <div class="border p-3 mb-3 rounded glass">
            <div class="d-flex justify-content-between align-items-center">
                <h6>Employee Details</h6>
            </div>
            <div class="row mt-2">
                <div class="col-md-3">
                    <label class="form-label">Employee ID:</label>
                    <div class="form-control-plaintext">@Model.EmployeeDetails[i].emp_id</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Name:</label>
                    <div class="form-control-plaintext">@Model.EmployeeDetails[i].emp_name</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Department:</label>
                    <div class="form-control-plaintext">@(Model.EmployeeDetails[i].org_department?.dept_name ?? "")</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Grade:</label>
                    <div class="form-control-plaintext">@Model.EmployeeDetails[i].emp_Grade</div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Dose Progress Info Section -->
<div id="doseProgressSection" class="mb-3" style="display: none;">
    <div class="alert alert-info d-flex align-items-center">
        <i class="bi bi-info-circle-fill me-2"></i>
        <div>
            <strong>Dose Progress:</strong>
            <span id="doseProgressText"></span>
        </div>
    </div>
</div>

<!-- Edit Record Section -->
<div id="immunizationEditSection">
    @if (Model.ExistingRecords.Any())
    {
        <div class="border p-3 mb-3 rounded glass">
            <h6 class="text-primary mb-3">Select Record to Edit</h6>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Immunization Type</th>
                            <th>Patient Name</th>
                            <th>Relationship</th>
                            <th>Progress</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in Model.ExistingRecords)
                        {
                            var isComplete = record.dose_1_date.HasValue &&
                            record.dose_2_date.HasValue &&
                            record.dose_3_date.HasValue &&
                            record.dose_4_date.HasValue &&
                            record.dose_5_date.HasValue &&
                            record.booster_dose_date.HasValue;

                            var doseCount = 0;
                            if (record.dose_1_date.HasValue) doseCount++;
                            if (record.dose_2_date.HasValue) doseCount++;
                            if (record.dose_3_date.HasValue) doseCount++;
                            if (record.dose_4_date.HasValue) doseCount++;
                            if (record.dose_5_date.HasValue) doseCount++;
                            if (record.booster_dose_date.HasValue) doseCount++;

                            <tr>
                                <td>@(record.RefImmunizationType?.immun_type_name ?? "")</td>
                                <td>@record.patient_name</td>
                                <td>@record.relationship</td>
                                <td>
                                    @if (isComplete)
                                    {
                                        <span class="badge bg-success">Complete (6/6)</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">@doseCount/6 Doses</span>
                                    }
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary edit-this-record"
                                            data-record-id="@record.immun_record_uid"
                                            data-patient-name="@record.patient_name"
                                            data-relationship="@record.relationship"
                                            data-dose1="@(record.dose_1_date?.ToString("yyyy-MM-dd") ?? "")"
                                            data-dose2="@(record.dose_2_date?.ToString("yyyy-MM-dd") ?? "")"
                                            data-dose3="@(record.dose_3_date?.ToString("yyyy-MM-dd") ?? "")"
                                            data-dose4="@(record.dose_4_date?.ToString("yyyy-MM-dd") ?? "")"
                                            data-dose5="@(record.dose_5_date?.ToString("yyyy-MM-dd") ?? "")"
                                            data-booster="@(record.booster_dose_date?.ToString("yyyy-MM-dd") ?? "")"
                                            data-remarks="@record.remarks"
                                            data-is-complete="@isComplete.ToString().ToLower()">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="border p-3 mb-3 rounded glass">
            <p class="text-muted text-center py-3">No records available to edit</p>
        </div>
    }
</div>

<!-- Edit Form Section (Initially Hidden) -->
<div id="editFormSection" style="display: none;">
    <form asp-action="SaveImmunizationRecord" asp-controller="EmployeeImmunization" method="post" id="editForm" data-ajax="true">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="EmpNo" />
        <input type="hidden" asp-for="RecordId" id="EditRecordId" />
        <input type="hidden" asp-for="IsNewEntry" id="EditIsNewEntry" value="false" />
        <input type="hidden" asp-for="PlantId" />
        <input type="hidden" asp-for="ImmunizationTypeId" id="EditImmunizationTypeId" />

        <div class="border p-3 mb-3 rounded glass">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary mb-0">Edit Immunization Record</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelEditBtn">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Name of Patient <span class="text-danger">*</span></label>
                    <input asp-for="PatientName" class="form-control rounded-2 glass" id="EditPatientName" readonly />
                    <span asp-validation-for="PatientName" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Relationship" class="form-label">Relationship</label>
                    <input asp-for="Relationship" class="form-control rounded-2 glass" id="EditRelationship" readonly />
                    <span asp-validation-for="Relationship" class="text-danger"></span>
                </div>
            </div>

            <!-- Dose Instructions -->
            <div id="editDoseInstructions" class="row mt-3" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="editDoseInstructionText">Please complete doses in sequence.</span>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-2">
                    <label asp-for="Dose1Date" class="form-label">
                        1st Dose
                        <span id="editDose1Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose1Date" type="date" class="form-control rounded-2 glass edit-dose-field" id="EditDose1Date" data-dose-number="1" />
                    <span asp-validation-for="Dose1Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose2Date" class="form-label">
                        2nd Dose
                        <span id="editDose2Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose2Date" type="date" class="form-control rounded-2 glass edit-dose-field" id="EditDose2Date" data-dose-number="2" />
                    <span asp-validation-for="Dose2Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose3Date" class="form-label">
                        3rd Dose
                        <span id="editDose3Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose3Date" type="date" class="form-control rounded-2 glass edit-dose-field" id="EditDose3Date" data-dose-number="3" />
                    <span asp-validation-for="Dose3Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose4Date" class="form-label">
                        4th Dose
                        <span id="editDose4Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose4Date" type="date" class="form-control rounded-2 glass edit-dose-field" id="EditDose4Date" data-dose-number="4" />
                    <span asp-validation-for="Dose4Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="Dose5Date" class="form-label">
                        5th Dose
                        <span id="editDose5Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="Dose5Date" type="date" class="form-control rounded-2 glass edit-dose-field" id="EditDose5Date" data-dose-number="5" />
                    <span asp-validation-for="Dose5Date" class="text-danger"></span>
                </div>

                <div class="col-md-2">
                    <label asp-for="BoosterDoseDate" class="form-label">
                        Booster Dose
                        <span id="editDose6Badge" class="badge" style="display: none;"></span>
                    </label>
                    <input asp-for="BoosterDoseDate" type="date" class="form-control rounded-2 glass edit-dose-field" id="EditBoosterDoseDate" data-dose-number="6" />
                    <span asp-validation-for="BoosterDoseDate" class="text-danger"></span>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <label asp-for="Remarks" class="form-label">Remarks</label>
                    <textarea asp-for="Remarks" class="form-control rounded-2 glass" rows="2" id="EditRemarks"></textarea>
                    <span asp-validation-for="Remarks" class="text-danger"></span>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn btn-primary me-2" id="saveEditBtn">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn2">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Close Button -->
<div id="closeButtonSection" class="row">
    <div class="col-12">
        <button type="button" class="btn btn-secondary" id="closeEditViewBtn">
            <i class="bi bi-arrow-left"></i> Close
        </button>
    </div>
</div>

<script>
    $(document).ready(function() {
        let currentEditingRecord = null;

        // Handle edit button click
        $('.edit-this-record').on('click', function() {
            var recordId = $(this).data('record-id');
            var patientName = $(this).data('patient-name');
            var relationship = $(this).data('relationship');
            var dose1 = $(this).data('dose1');
            var dose2 = $(this).data('dose2');
            var dose3 = $(this).data('dose3');
            var dose4 = $(this).data('dose4');
            var dose5 = $(this).data('dose5');
            var booster = $(this).data('booster');
            var remarks = $(this).data('remarks');
            var isComplete = $(this).data('is-complete');

            // Store current editing record
            currentEditingRecord = {
                recordId: recordId,
                patientName: patientName,
                relationship: relationship,
                dose1: dose1,
                dose2: dose2,
                dose3: dose3,
                dose4: dose4,
                dose5: dose5,
                booster: booster,
                remarks: remarks,
                isComplete: isComplete
            };

            // Populate form
            $('#EditRecordId').val(recordId);
            $('#EditPatientName').val(patientName);
            $('#EditRelationship').val(relationship);
            $('#EditDose1Date').val(dose1);
            $('#EditDose2Date').val(dose2);
            $('#EditDose3Date').val(dose3);
            $('#EditDose4Date').val(dose4);
            $('#EditDose5Date').val(dose5);
            $('#EditBoosterDoseDate').val(booster);
            $('#EditRemarks').val(remarks);

            // Hide record list, show form
            $('#immunizationEditSection').hide();
            $('#closeButtonSection').hide();
            $('#editFormSection').show();

            // Manage dose fields based on completion status
            if (isComplete) {
                showDoseProgressEdit('All doses completed', 'success');
                disableAllEditDoseFields();
                $('#saveEditBtn').prop('disabled', true).html('<i class="bi bi-check-circle"></i> All Doses Complete');
            } else {
                manageDoseFieldsForEdit();
                $('#saveEditBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Save Changes');
            }
        });

        // Cancel edit buttons
        $('#cancelEditBtn, #cancelEditBtn2').on('click', function() {
            $('#editFormSection').hide();
            $('#immunizationEditSection').show();
            $('#closeButtonSection').show();
            $('#doseProgressSection').hide();
            clearEditForm();
        });

        // Close button
        $('#closeEditViewBtn').on('click', function() {
            $('#immunizationFormContainer').html('');
            $('#allRecordsTableContainer').show();
            $('#backToAllRecordsBtn').hide();
        });

        // Save edit button
        $('#saveEditBtn').on('click', function(e) {
            e.preventDefault();
            saveEditRecord();
        });

        function manageDoseFieldsForEdit() {
            var dose1 = $('#EditDose1Date').val();
            var dose2 = $('#EditDose2Date').val();
            var dose3 = $('#EditDose3Date').val();
            var dose4 = $('#EditDose4Date').val();
            var dose5 = $('#EditDose5Date').val();
            var booster = $('#EditBoosterDoseDate').val();

            // Reset all fields - ENABLE ALL FIELDS FOR EDITING
            $('.edit-dose-field').prop('disabled', false).removeClass('next-dose-highlight');
            $('.badge').removeClass('bg-primary bg-success bg-warning bg-danger bg-info').hide();

            // Show status badges for all doses
            if (dose1) {
                $('#editDose1Badge').text('DONE').addClass('bg-success').show();
            } else {
                $('#editDose1Badge').text('NEXT').addClass('bg-primary').show();
                $('#EditDose1Date').addClass('next-dose-highlight');
            }

            if (dose2) {
                $('#editDose2Badge').text('DONE').addClass('bg-success').show();
            } else if (dose1) {
                $('#editDose2Badge').text('NEXT').addClass('bg-primary').show();
                $('#EditDose2Date').addClass('next-dose-highlight');
            }

            if (dose3) {
                $('#editDose3Badge').text('DONE').addClass('bg-success').show();
            } else if (dose2) {
                $('#editDose3Badge').text('NEXT').addClass('bg-primary').show();
                $('#EditDose3Date').addClass('next-dose-highlight');
            }

            if (dose4) {
                $('#editDose4Badge').text('DONE').addClass('bg-success').show();
            } else if (dose3) {
                $('#editDose4Badge').text('NEXT').addClass('bg-primary').show();
                $('#EditDose4Date').addClass('next-dose-highlight');
            }

            if (dose5) {
                $('#editDose5Badge').text('DONE').addClass('bg-success').show();
            } else if (dose4) {
                $('#editDose5Badge').text('NEXT').addClass('bg-primary').show();
                $('#EditDose5Date').addClass('next-dose-highlight');
            }

            if (booster) {
                $('#editDose6Badge').text('DONE').addClass('bg-success').show();
            } else if (dose5) {
                $('#editDose6Badge').text('NEXT').addClass('bg-primary').show();
                $('#EditBoosterDoseDate').addClass('next-dose-highlight');
            }

            showDoseInstructionsEdit('All entered doses can be edited. Fill doses in sequence.');
        }
        function disableAllEditDoseFields() {
            $('.edit-dose-field').prop('disabled', true).removeClass('next-dose-highlight');

            // Show all as done
            if ($('#EditDose1Date').val()) $('#editDose1Badge').text('DONE').addClass('bg-success').show();
            if ($('#EditDose2Date').val()) $('#editDose2Badge').text('DONE').addClass('bg-success').show();
            if ($('#EditDose3Date').val()) $('#editDose3Badge').text('DONE').addClass('bg-success').show();
            if ($('#EditDose4Date').val()) $('#editDose4Badge').text('DONE').addClass('bg-success').show();
            if ($('#EditDose5Date').val()) $('#editDose5Badge').text('DONE').addClass('bg-success').show();
            if ($('#EditBoosterDoseDate').val()) $('#editDose6Badge').text('DONE').addClass('bg-success').show();
        }

        function showDoseInstructionsEdit(text) {
            $('#editDoseInstructionText').text(text);
            $('#editDoseInstructions').show();
        }

        function showDoseProgressEdit(message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-info';
            $('#doseProgressSection .alert').removeClass('alert-info alert-success').addClass(alertClass);
            $('#doseProgressText').text(message);
            $('#doseProgressSection').show();
        }

        function clearEditForm() {
            $('#EditRecordId').val('');
            $('#EditPatientName').val('');
            $('#EditRelationship').val('');
            $('#EditDose1Date').val('');
            $('#EditDose2Date').val('');
            $('#EditDose3Date').val('');
            $('#EditDose4Date').val('');
            $('#EditDose5Date').val('');
            $('#EditBoosterDoseDate').val('');
            $('#EditRemarks').val('');
            $('.edit-dose-field').removeClass('next-dose-highlight').prop('disabled', false);
            $('.badge').hide();
            $('#editDoseInstructions').hide();
            currentEditingRecord = null;
        }

        function saveEditRecord() {
            var form = $('#editForm');
            if (form.length === 0) {
                showAlert('error', 'Form not found.');
                return;
            }

            var hasAnyDose = $('#EditDose1Date').val() || $('#EditDose2Date').val() ||
                           $('#EditDose3Date').val() || $('#EditDose4Date').val() ||
                           $('#EditDose5Date').val() || $('#EditBoosterDoseDate').val();

            if (!hasAnyDose) {
                showAlert('error', 'Please enter at least one dose date.');
                return;
            }

            // Temporarily enable all fields for serialization, then disable again
            var disabledFields = $('.edit-dose-field:disabled');
            disabledFields.prop('disabled', false);

            var formData = form.serialize();

            // Re-disable the fields
            disabledFields.prop('disabled', true);

            $('#saveEditBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Saving...');

            $.ajax({
                url: '@Url.Action("SaveImmunizationRecord", "EmployeeImmunization")',
                type: 'POST',
                data: formData,
                success: function (response) {
                    $('#saveEditBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Save Changes');

                    if (response.success) {
                        showAlert('success', response.message);

                        // Reload the edit view to show updated data
                        var empId = $('#empIdInput').val();
                        var immunizationType = $('#immunizationTypeFilter').val();
                        if (empId && immunizationType) {
                            setTimeout(function() {
                                window.location.reload();
                            }, 1500);
                        }
                    } else {
                        showAlert('error', response.message || 'Save failed. Please check the form data.');
                    }
                },
                error: function (xhr) {
                    $('#saveEditBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Save Changes');
                    if (xhr.status === 400) {
                        showAlert('error', 'Please correct the validation errors and try again.');
                    } else if (xhr.status === 403) {
                        showAlert('error', 'Access denied.');
                    } else {
                        showAlert('error', 'An error occurred while saving. Please try again.');
                    }
                }
            });
        }

        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : type === 'info' ? 'alert-info' : 'alert-danger';
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;

            $('#alertContainer').html(alertHtml);

            setTimeout(() => {
                const alertEl = document.getElementById(alertId);
                if (alertEl) {
                    bootstrap.Alert.getOrCreateInstance(alertEl).close();
                }
            }, 5000);
        }

        // Dose field change events
        $('.edit-dose-field').on('change', function() {
            manageDoseFieldsForEdit();
        });
    });
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}