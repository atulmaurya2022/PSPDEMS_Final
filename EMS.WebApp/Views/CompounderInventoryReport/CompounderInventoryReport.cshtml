@{
    ViewData["Title"] = "Compounder/Pharmacist Inventory Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/css/report.css" rel="stylesheet" />
<link href="~/css/report-inventory.css" rel="stylesheet" />

<style>
    /* Ensure all controls stay in one row */
    .controls-row {
        display: flex !important;
        flex-wrap: wrap !important;
        align-items: flex-end !important;
        gap: 1.5rem !important;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }

    .control-actions {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
        flex-shrink: 0;
        margin-left: auto;
    }

    .date-range-inputs {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-controls {
        display: flex;
        gap: 1rem;
        flex-wrap: nowrap;
    }

    /* Ensure buttons don't wrap */
    .control-actions .btn {
        white-space: nowrap;
    }

    /* ========== IMPROVED VIEW MODE TOGGLE STYLES ========== */
    .view-mode-toggle {
        display: inline-flex;
        background: #e9ecef;
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
    }

    .view-mode-btn {
        padding: 8px 16px;
        border: none;
        background: transparent;
        color: #495057;
        cursor: pointer;
        transition: all 0.25s ease;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

        .view-mode-btn:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
            color: #212529;
        }

        .view-mode-btn.active {
            background: #0d6efd;
            color: white;
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
        }

        .view-mode-btn i {
            font-size: 1rem;
        }

    /* View mode indicator badge in title */
    .view-mode-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-left: 1rem;
        vertical-align: middle;
    }

        .view-mode-indicator.batch-mode {
            background: #e7f1ff;
            color: #0d6efd;
            border: 1px solid #b6d4fe;
        }

        .view-mode-indicator.summary-mode {
            background: #d1e7dd;
            color: #198754;
            border: 1px solid #a3cfbb;
        }

    /* Hide batch-only columns in summary mode */
    .summary-view-active .batch-only-col {
        display: none !important;
    }

    /* Medicine summary row styling */
    .medicine-summary-row td {
        font-weight: 500;
    }

    .batch-count-badge {
        font-size: 0.7rem;
        color: #6c757d;
        font-weight: normal;
    }

    /* Stock status badge inline */
    .stock-status-inline {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 4px;
        font-weight: 500;
    }

        .stock-status-inline.in-stock {
            background: #d1e7dd;
            color: #198754;
        }

        .stock-status-inline.low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .stock-status-inline.out-of-stock {
            background: #f8d7da;
            color: #842029;
        }
</style>

<!-- Enhanced Dashboard Header -->
<div class="dashboard-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb breadcrumb-custom">
            <li class="breadcrumb-item">Reports</li>
            <li class="breadcrumb-item active" aria-current="page">Compounder/Pharmacist Inventory Report</li>
        </ol>
    </nav>
    <h1 class="dashboard-title">
        <i class="bi bi-boxes"></i>
        Compounder/Pharmacist Inventory Report
        <span id="viewModeIndicator" class="view-mode-indicator batch-mode">
            <i class="bi bi-archive"></i>
            Batch-wise View
        </span>
    </h1>
    <p class="dashboard-subtitle">Detailed batch-level inventory analysis with stock status monitoring and advanced filtering</p>
</div>

<div class="container-fluid">
    <!-- Enhanced Filter Controls Section -->
    <div class="report-controls-section">
        <div class="controls-row">
            <!-- View Mode Toggle -->
            <div class="control-group">
                <label class="control-label">
                    <i class="bi bi-eye me-2"></i>
                    View Mode
                </label>
                <div class="view-mode-toggle">
                    <button type="button" class="view-mode-btn active" id="batchViewBtn" onclick="setViewMode('batch')">
                        <i class="bi bi-archive"></i>
                        Batch-wise
                    </button>
                    <button type="button" class="view-mode-btn" id="summaryViewBtn" onclick="setViewMode('summary')">
                        <i class="bi bi-capsule"></i>
                        Medicine Summary
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">
                    <i class="bi bi-calendar-range me-2"></i>
                    Date Range
                </label>
                <div class="date-range-inputs">
                    <input type="date" class="form-control form-control-enhanced" id="fromDate" />
                    <span class="date-separator">to</span>
                    <input type="date" class="form-control form-control-enhanced" id="toDate" />
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">
                    <i class="bi bi-funnel me-2"></i>
                    Filters
                </label>
                <div class="filter-controls">
                    <div class="custom-checkbox-enhanced">
                        <input class="form-check-input-enhanced" type="checkbox" id="showOutOfStockFilter">
                        <label class="form-check-label-enhanced" for="showOutOfStockFilter">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Show Out of Stock Only
                        </label>
                    </div>
                    <div class="custom-checkbox-enhanced">
                        <input class="form-check-input-enhanced" type="checkbox" id="showAvailableStockFilter">
                        <label class="form-check-label-enhanced" for="showAvailableStockFilter">
                            <i class="bi bi-box-seam me-1"></i>
                            Show Available Stock Only
                        </label>
                    </div>
                </div>
            </div>

            <div class="control-actions">
                <button type="button" class="btn btn-primary btn-enhanced" onclick="loadReport()">
                    <i class="bi bi-search"></i>
                    Generate Report
                </button>
                <button type="button" class="btn btn-secondary btn-enhanced" id="exportButton" onclick="exportReport()" style="display: none;">
                    <i class="bi bi-download"></i>
                    Export
                </button>
                <button type="button" class="btn btn-outline-secondary btn-enhanced" id="printButton" onclick="printReport()" style="display: none;">
                    <i class="bi bi-printer"></i>
                    Print
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Report Summary Cards (6 cards) -->
    <div id="reportSummary" class="inventory-summary-grid" style="display: none;">
        <div class="summary-card" data-category="total-records">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title" id="recordsCardTitle">Total Records</h6>
                    <div class="summary-icon">
                        <i class="bi bi-list-ul"></i>
                    </div>
                </div>
                <div class="summary-value" id="totalRecords">0</div>
                <div class="summary-subtitle" id="recordsCardSubtitle">Inventory entries</div>
            </div>
        </div>

        <div class="summary-card" data-category="total-batches" id="batchesCard">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Total Batches</h6>
                    <div class="summary-icon">
                        <i class="bi bi-archive"></i>
                    </div>
                </div>
                <div class="summary-value" id="totalBatches">0</div>
                <div class="summary-subtitle">Unique batches tracked</div>
            </div>
        </div>

        <div class="summary-card" data-category="total-raised">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Total Raised</h6>
                    <div class="summary-icon">
                        <i class="bi bi-arrow-up-circle"></i>
                    </div>
                </div>
                <div class="summary-value" id="totalRaisedQuantity">0</div>
                <div class="summary-subtitle">Units requested</div>
            </div>
        </div>

        <div class="summary-card" data-category="available-stock">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Available Stock</h6>
                    <div class="summary-icon">
                        <i class="bi bi-box"></i>
                    </div>
                </div>
                <div class="summary-value" id="totalAvailableStock">0</div>
                <div class="summary-subtitle">Units in stock</div>
            </div>
        </div>

        <div class="summary-card" data-category="consumed-stock">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Consumed Stock</h6>
                    <div class="summary-icon">
                        <i class="bi bi-arrow-down-circle"></i>
                    </div>
                </div>
                <div class="summary-value" id="totalConsumedStock">0</div>
                <div class="summary-subtitle">Units consumed</div>
            </div>
        </div>

        <div class="summary-card" data-category="out-of-stock">
            <div class="summary-card-body">
                <div class="summary-header">
                    <h6 class="summary-title">Stock Alerts</h6>
                    <div class="summary-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="summary-value" id="stockAlerts">0</div>
                <div class="summary-subtitle">Critical alerts</div>
            </div>
        </div>
    </div>

    <!-- Enhanced Plant Information -->
    <div id="plantInfo" class="plant-info-section" style="display: none;">
        <div class="plant-info-content">
            <div class="plant-info-header">
                <i class="bi bi-building me-2"></i>
                <h6 class="plant-info-title">Plant Information</h6>
            </div>
            <div class="plant-info-details">
                <div class="plant-detail-item">
                    <span class="plant-detail-label">Plant Code:</span>
                    <span class="plant-detail-value" id="currentPlantCode">-</span>
                </div>
                <div class="plant-detail-separator"></div>
                <div class="plant-detail-item">
                    <span class="plant-detail-label">Plant Name:</span>
                    <span class="plant-detail-value" id="currentPlantName">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Report Header -->
    <div id="reportHeader" class="report-header-section" style="display: none;">
        <div class="report-header-content">
            <div class="company-info">
                <h4 id="unitHeader">Unit: ITC LIMITED - PSPD-N/A</h4>
                <div class="report-meta">
                    <span class="meta-item">
                        <i class="bi bi-clock me-1"></i>
                        Generated: <span id="runDateTime"></span>
                    </span>
                    <span class="meta-item">
                        <i class="bi bi-person me-1"></i>
                        By: <span id="generatedBy"></span>
                    </span>
                </div>
            </div>
            <div class="report-title">
                <h3>COMPOUNDER/PHARMACIST INVENTORY</h3>
                <p class="report-subtitle" id="reportSubtitle">Batch Level Report</p>
            </div>
        </div>
    </div>

    <!-- Enhanced Search Section -->
    <div id="searchSection" class="search-controls-section" style="display: none;">
        <div class="search-wrapper">
            <div class="search-input-group">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="form-control search-input-enhanced" id="searchInput"
                       placeholder="Search by medicine name, batch no, manufacturer, vendor code...">
                <button type="button" class="btn btn-clear" onclick="clearSearch()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="search-results-info">
                <small class="text-muted" id="searchResultCount">No search applied</small>
            </div>
        </div>
    </div>

    <!-- Enhanced Report Table -->
    <div id="reportTableSection" class="inventory-table-section" style="display: none;">
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-striped table-glass glass-table table-sm" id="reportTable">
                    <thead id="tableHeader">
                        <!-- Header will be dynamically generated -->
                    </thead>
                    <tbody id="reportData">
                        <!-- Data will be populated here -->
                    </tbody>
                    <tfoot id="tableFooter">
                        <!-- Footer will be dynamically generated -->
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Enhanced No Data State -->
    <div id="noDataMessage" class="empty-state-section" style="display: none;">
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-archive"></i>
            </div>
            <h6 class="empty-state-title">No Inventory Data Found</h6>
            <p class="empty-state-description">
                No compounder inventory batch records found for the selected date range.<br>
                Try adjusting your date filters or removing the out-of-stock filter.
            </p>
            <button type="button" class="btn btn-outline-primary btn-enhanced" onclick="$('#fromDate, #toDate').focus()">
                <i class="bi bi-funnel"></i>
                Adjust Filters
            </button>
        </div>
    </div>

    <!-- Enhanced Loading State -->
    <div id="loadingSpinner" class="loading-state-section" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner-large"></div>
            <h6 class="loading-title">Generating Inventory Report</h6>
            <p class="loading-description">Processing batch-level inventory data...</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var allReportData = []; // Store all data for filtering
        var currentFilteredData = []; // Store currently filtered data
        var currentViewMode = 'batch'; // 'batch' or 'summary'

        $(document).ready(function() {
            // Initialize table headers
            renderTableHeader();

            // Filter checkbox event
            $('#showOutOfStockFilter').change(function() {
                applyFilters();
                if ($(this).is(':checked')) {
                    showAlert('info', 'Showing only out-of-stock items', 'Filter Applied');
                } else {
                    showAlert('info', 'Showing all inventory items', 'Filter Removed');
                }
            });

            // Available stock filter event - reloads data from server
            $('#showAvailableStockFilter').change(function() {
                if (allReportData && allReportData.length > 0) {
                    loadReport();
                }
            });

            // Search input event with debounce
            $('#searchInput').on('input', debounce(function() {
                applyFilters();
            }, 300));

            // Enhanced form validation
            $('#fromDate, #toDate').on('change', function() {
                validateDateRange();
            });
        });

        // View Mode Toggle Function
        function setViewMode(mode) {
            currentViewMode = mode;

            // Update button states
            $('#batchViewBtn, #summaryViewBtn').removeClass('active');
            if (mode === 'batch') {
                $('#batchViewBtn').addClass('active');
                $('#viewModeIndicator')
                    .removeClass('summary-mode')
                    .addClass('batch-mode')
                    .html('<i class="bi bi-archive"></i> Batch-wise View');
                $('#reportSubtitle').text('Batch Level Report');
                $('#recordsCardTitle').text('Total Records');
                $('#recordsCardSubtitle').text('Inventory entries');
                $('#batchesCard').show();
                $('#searchInput').attr('placeholder', 'Search by medicine name, batch no, manufacturer, vendor code...');
            } else {
                $('#summaryViewBtn').addClass('active');
                $('#viewModeIndicator')
                    .removeClass('batch-mode')
                    .addClass('summary-mode')
                    .html('<i class="bi bi-capsule"></i> Medicine Summary View');
                $('#reportSubtitle').text('Medicine Summary Report');
                $('#recordsCardTitle').text('Total Medicines');
                $('#recordsCardSubtitle').text('Unique medicines');
                $('#batchesCard').hide();
                $('#searchInput').attr('placeholder', 'Search by medicine name, manufacturer, potency...');
            }

            // Re-render table structure and data
            renderTableHeader();
            if (allReportData && allReportData.length > 0) {
                applyFilters();
                updateSummaryCardsForMode();
            }
        }

        // Render table header based on view mode
        function renderTableHeader() {
            var thead = $('#tableHeader');
            var tfoot = $('#tableFooter');

            if (currentViewMode === 'batch') {
                thead.html(`
                    <tr>
                        <th class="col-sl">SL</th>
                        <th class="col-indent-id">INDENT ID</th>
                        <th class="col-raised-date">RAISED DATE</th>
                        <th class="col-medicine-name">MEDICINE NAME</th>
                        <th class="col-potency">POTENCY</th>
                        <th class="col-manufacturer">MANUFACTURER</th>
                        <th class="col-batch-no">BATCH NO</th>
                        <th class="col-vendor-code">VENDOR CODE</th>
                        <th class="col-raised-qty">RAISED QTY</th>
                        <th class="col-received-qty">RECEIVED QTY</th>
                        <th class="col-consumed">CONSUMED</th>
                        <th class="col-available">AVAILABLE</th>
                        <th class="col-expiry-date">EXPIRY DATE</th>
                        <th class="col-raised-by">RAISED BY</th>
                    </tr>
                `);
                tfoot.html(`
                    <tr class="inventory-table-footer">
                        <th colspan="8" class="text-end">Totals:</th>
                        <th id="footerTotalRaisedQty" class="total-value">0</th>
                        <th id="footerTotalReceivedQty" class="total-value">0</th>
                        <th id="footerTotalConsumed" class="total-value">0</th>
                        <th id="footerTotalAvailable" class="total-value">0</th>
                        <th colspan="2"></th>
                    </tr>
                `);
            } else {
                thead.html(`
                    <tr>
                        <th class="col-sl">SL</th>
                        <th class="col-medicine-name">MEDICINE NAME</th>
                        <th class="col-potency">POTENCY</th>
                        <th class="col-manufacturer">MANUFACTURER</th>
                        <th class="col-raised-qty">RAISED QTY</th>
                        <th class="col-received-qty">RECEIVED QTY</th>
                        <th class="col-consumed">CONSUMED</th>
                        <th class="col-available">AVAILABLE</th>
                        <th class="col-status">STATUS</th>
                    </tr>
                `);
                tfoot.html(`
                    <tr class="inventory-table-footer">
                        <th colspan="4" class="text-end">Totals:</th>
                        <th id="footerTotalRaisedQty" class="total-value">0</th>
                        <th id="footerTotalReceivedQty" class="total-value">0</th>
                        <th id="footerTotalConsumed" class="total-value">0</th>
                        <th id="footerTotalAvailable" class="total-value">0</th>
                        <th></th>
                    </tr>
                `);
            }
        }

        // Aggregate data for Medicine Summary view
        function aggregateByMedicine(data) {
            var medicineMap = new Map();

            data.forEach(function(item) {
                var key = (item.medicineName || '').toLowerCase() + '||' + (item.potency || '') + '||' + (item.manufacturerBy || '');

                if (medicineMap.has(key)) {
                    var existing = medicineMap.get(key);
                    existing.receivedQuantity += Number(item.receivedQuantity || 0);
                    existing.availableStock += Number(item.availableStock || 0);
                    existing.consumedStock += Number(item.consumedStock || 0);
                    existing.batchCount += 1;
                    // Track unique indent IDs to avoid double-counting raised qty
                    if (!existing.indentIds.has(item.indentId + '||' + item.medicineName)) {
                        existing.raisedQuantity += Number(item.raisedQuantity || 0);
                        existing.indentIds.add(item.indentId + '||' + item.medicineName);
                    }
                } else {
                    var indentIds = new Set();
                    indentIds.add(item.indentId + '||' + item.medicineName);
                    medicineMap.set(key, {
                        medicineName: item.medicineName,
                        potency: item.potency,
                        manufacturerBy: item.manufacturerBy,
                        raisedQuantity: Number(item.raisedQuantity || 0),
                        receivedQuantity: Number(item.receivedQuantity || 0),
                        availableStock: Number(item.availableStock || 0),
                        consumedStock: Number(item.consumedStock || 0),
                        batchCount: 1,
                        indentIds: indentIds
                    });
                }
            });

            // Calculate stock status and convert to array
            var result = Array.from(medicineMap.values()).map(function(item) {
                if (item.availableStock === 0) {
                    item.stockStatus = 'Out of Stock';
                } else if (item.availableStock < item.receivedQuantity * 0.2) {
                    item.stockStatus = 'Low Stock';
                } else {
                    item.stockStatus = 'In Stock';
                }
                delete item.indentIds; // Clean up helper property
                return item;
            });

            return result.sort((a, b) => (a.medicineName || '').localeCompare(b.medicineName || ''));
        }

        // Enhanced date validation
        function validateDateRange() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
                showAlert('warning', 'From Date cannot be greater than To Date', 'Invalid Date Range');
                return false;
            }
            return true;
        }

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function loadReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            var showOnlyAvailable = $('#showAvailableStockFilter').is(':checked');

            if ((fromDate && !toDate) || (!fromDate && toDate)) {
                showAlert('warning', 'Please select both dates or leave both empty', 'Invalid Date Range');
                return;
            }

            $('#loadingSpinner').show();
            $('#reportTableSection, #noDataMessage, #reportSummary, #plantInfo, #reportHeader, #searchSection').hide();

            $.ajax({
                url: '@Url.Action("CompounderInventoryReport", "CompounderInventoryReport")',
                type: 'GET',
                data: {
                    fromDate: fromDate || null,
                    toDate: toDate || null,
                    showOnlyAvailable: showOnlyAvailable
                },
                success: function(response) {
                    $('#loadingSpinner').hide();

                    if (response.success && response.data && response.data.length > 0) {
                        allReportData = response.data;
                        currentFilteredData = allReportData;

                        applyFilters();
                        updateReportHeader(response.reportInfo);
                        updatePlantInfo(response.reportInfo);
                        updateSummaryCards(response.reportInfo);

                        $('#reportSummary').fadeIn(300);
                        setTimeout(() => {
                            $('#plantInfo, #reportHeader, #searchSection, #reportTableSection').fadeIn(300);
                            $('#exportButton, #printButton').show();
                        }, 200);

                    } else {
                        allReportData = [];
                        currentFilteredData = [];
                        $('#noDataMessage').fadeIn(300);
                        $('#exportButton, #printButton').hide();
                    }
                },
                error: function(xhr, status, error) {
                    $('#loadingSpinner').hide();
                    showAlert('error', 'An error occurred while generating the report: ' + error, 'Error');
                }
            });
        }

        function applyFilters() {
            var searchText = $('#searchInput').val().toLowerCase();
            var showOutOfStockOnly = $('#showOutOfStockFilter').is(':checked');

            currentFilteredData = allReportData.filter(function(item) {
                var matchesSearch = !searchText ||
                    (item.medicineName && item.medicineName.toLowerCase().includes(searchText)) ||
                    (item.batchNo && item.batchNo.toLowerCase().includes(searchText)) ||
                    (item.manufacturerBy && item.manufacturerBy.toLowerCase().includes(searchText)) ||
                    (item.vendorCode && item.vendorCode.toLowerCase().includes(searchText)) ||
                    (item.potency && item.potency.toLowerCase().includes(searchText)) ||
                    (item.raisedBy && item.raisedBy.toLowerCase().includes(searchText));

                var matchesStockFilter = !showOutOfStockOnly || item.stockStatus === 'Out of Stock';

                return matchesSearch && matchesStockFilter;
            });

            if (currentViewMode === 'summary') {
                var aggregatedData = aggregateByMedicine(currentFilteredData);
                renderSummaryTable(aggregatedData);
            } else {
                renderBatchTable(currentFilteredData);
            }

            updateSearchResultCount();
        }

        function updateSearchResultCount() {
            var searchText = $('#searchInput').val();
            var displayCount = currentViewMode === 'summary'
                ? aggregateByMedicine(currentFilteredData).length
                : currentFilteredData.length;

            if (searchText) {
                $('#searchResultCount').text('Found ' + displayCount + ' results for "' + searchText + '"');
            } else {
                $('#searchResultCount').text('Showing ' + displayCount + ' ' + (currentViewMode === 'summary' ? 'medicines' : 'records'));
            }
        }

        function clearSearch() {
            $('#searchInput').val('');
            applyFilters();
            $('#searchResultCount').text('No search applied');
        }

        // Compute raised total by group average for batch view
        function computeRaisedTotalByGroupAverage(data) {
            const groupMap = new Map();
            data.forEach(item => {
                const key = `${item.indentId}||${(item.medicineName || '').toLowerCase()}`;
                if (!groupMap.has(key)) {
                    groupMap.set(key, { total: 0, count: 0 });
                }
                groupMap.get(key).total += Number(item.raisedQuantity || 0);
                groupMap.get(key).count += 1;
            });

            let total = 0;
            groupMap.forEach(group => {
                total += Math.round(group.total / group.count);
            });
            return total;
        }

        // Render Batch-wise table
        function renderBatchTable(data) {
            var tbody = $('#reportData');
            tbody.empty();

            const avgMap = new Map();
            data.forEach(item => {
                const key = `${item.indentId}||${(item.medicineName || '').toLowerCase()}`;
                if (!avgMap.has(key)) {
                    avgMap.set(key, { total: 0, count: 0 });
                }
                avgMap.get(key).total += Number(item.raisedQuantity || 0);
                avgMap.get(key).count += 1;
            });
            avgMap.forEach((val, key) => {
                avgMap.set(key, Math.round(val.total / val.count));
            });

            var totalReceivedQty = 0;
            var totalAvailable = 0;
            var totalConsumed = 0;

            data.forEach(function(item, index) {
                var rowClass = '';
                switch(item.stockStatus) {
                    case 'In Stock': rowClass = 'row-success'; break;
                    case 'Low Stock': rowClass = 'row-warning'; break;
                    case 'Out of Stock': rowClass = 'row-danger'; break;
                }

                var expiryBadgeClass = '';
                if (item.expiryDate && item.expiryDate !== 'Not Set') {
                    var expiryDate = new Date(item.expiryDate.split('/').reverse().join('-'));
                    var today = new Date();
                    var thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));

                    if (expiryDate < today) {
                        expiryBadgeClass = 'expiry-badge-expired';
                    } else if (expiryDate <= thirtyDaysFromNow) {
                        expiryBadgeClass = 'expiry-badge-warning';
                    } else {
                        expiryBadgeClass = 'expiry-badge-normal';
                    }
                }

                totalReceivedQty += Number(item.receivedQuantity || 0);
                totalAvailable += Number(item.availableStock || 0);
                totalConsumed += Number(item.consumedStock || 0);

                const key = `${item.indentId}||${(item.medicineName || '').toLowerCase()}`;
                const displayRaisedQty = avgMap.get(key) ?? Number(item.raisedQuantity || 0);

                var row = `<tr class="inventory-table-row ${rowClass}">
                    <td class="sl-cell">${index + 1}</td>
                    <td class="indent-id-cell"><span class="id-badge">${item.indentId}</span></td>
                    <td class="date-cell">${item.raisedDate}</td>
                    <td class="medicine-cell"><span class="medicine-name">${item.medicineName}</span></td>
                    <td class="potency-cell">${item.potency}</td>
                    <td class="manufacturer-cell">${item.manufacturerBy}</td>
                    <td class="batch-cell"><span class="batch-badge">${item.batchNo}</span></td>
                    <td class="vendor-cell">${item.vendorCode}</td>
                    <td class="quantity-cell"><span class="quantity-badge raised">${displayRaisedQty}</span></td>
                    <td class="quantity-cell"><span class="quantity-badge received">${item.receivedQuantity}</span></td>
                    <td class="quantity-cell"><span class="quantity-badge consumed">${item.consumedStock}</span></td>
                    <td class="quantity-cell"><span class="quantity-badge ${item.availableStock > 0 ? 'available' : 'unavailable'}">${item.availableStock}</span></td>
                    <td class="expiry-cell"><span class="expiry-badge ${expiryBadgeClass}">${item.expiryDate}</span></td>
                    <td class="raised-by-cell">${item.raisedBy}</td>
                </tr>`;
                tbody.append(row);
            });

            const raisedTotal = computeRaisedTotalByGroupAverage(data);
            $('#footerTotalRaisedQty').text(raisedTotal.toLocaleString());
            $('#footerTotalReceivedQty').text(totalReceivedQty.toLocaleString());
            $('#footerTotalConsumed').text(totalConsumed.toLocaleString());
            $('#footerTotalAvailable').text(totalAvailable.toLocaleString());
        }

        // Render Medicine Summary table
        function renderSummaryTable(data) {
            var tbody = $('#reportData');
            tbody.empty();

            var totalRaisedQty = 0;
            var totalReceivedQty = 0;
            var totalAvailable = 0;
            var totalConsumed = 0;

            data.forEach(function(item, index) {
                var rowClass = '';
                var statusClass = '';
                var statusText = item.stockStatus;

                switch(item.stockStatus) {
                    case 'In Stock':
                        rowClass = 'row-success';
                        statusClass = 'in-stock';
                        break;
                    case 'Low Stock':
                        rowClass = 'row-warning';
                        statusClass = 'low-stock';
                        break;
                    case 'Out of Stock':
                        rowClass = 'row-danger';
                        statusClass = 'out-of-stock';
                        break;
                }

                totalRaisedQty += Number(item.raisedQuantity || 0);
                totalReceivedQty += Number(item.receivedQuantity || 0);
                totalAvailable += Number(item.availableStock || 0);
                totalConsumed += Number(item.consumedStock || 0);

                var row = `<tr class="inventory-table-row medicine-summary-row ${rowClass}">
                    <td class="sl-cell">${index + 1}</td>
                    <td class="medicine-cell">
                        <span class="medicine-name">${item.medicineName}</span>
                        <span class="batch-count-badge d-block">${item.batchCount} batch(es)</span>
                    </td>
                    <td class="potency-cell">${item.potency}</td>
                    <td class="manufacturer-cell">${item.manufacturerBy}</td>
                    <td class="quantity-cell"><span class="quantity-badge raised">${item.raisedQuantity}</span></td>
                    <td class="quantity-cell"><span class="quantity-badge received">${item.receivedQuantity}</span></td>
                    <td class="quantity-cell"><span class="quantity-badge consumed">${item.consumedStock}</span></td>
                    <td class="quantity-cell"><span class="quantity-badge ${item.availableStock > 0 ? 'available' : 'unavailable'}">${item.availableStock}</span></td>
                    <td class="status-cell"><span class="stock-status-inline ${statusClass}">${statusText}</span></td>
                </tr>`;
                tbody.append(row);
            });

            $('#footerTotalRaisedQty').text(totalRaisedQty.toLocaleString());
            $('#footerTotalReceivedQty').text(totalReceivedQty.toLocaleString());
            $('#footerTotalConsumed').text(totalConsumed.toLocaleString());
            $('#footerTotalAvailable').text(totalAvailable.toLocaleString());

            // Update records count for summary mode
            $('#totalRecords').text(data.length);
        }

        function updateReportHeader(reportInfo) {
            $('#runDateTime').text(reportInfo.generatedOn);
            $('#generatedBy').text(reportInfo.generatedBy);

            var unitText = 'Unit: ITC LIMITED - PSPD-' + (reportInfo.plantCode || 'N/A');
            if (reportInfo.plantName && reportInfo.plantName !== 'Unknown Plant') {
                unitText += ' (' + reportInfo.plantName + ')';
            }
            $('#unitHeader').text(unitText);
        }

        function updateSummaryCards(reportInfo) {
            const correctedRaisedTotal = computeRaisedTotalByGroupAverage(allReportData);

            animateValue('totalRecords', 0, reportInfo.totalRecords, 1000);
            animateValue('totalBatches', 0, reportInfo.totalBatches, 1100);
            animateValue('totalRaisedQuantity', 0, correctedRaisedTotal, 1200);
            animateValue('totalAvailableStock', 0, reportInfo.totalAvailableStock, 1300);
            animateValue('totalConsumedStock', 0, reportInfo.totalConsumedStock, 1400);
            animateValue('stockAlerts', 0, (reportInfo.outOfStockItems || 0) + (reportInfo.lowStockItems || 0), 1500);
        }

        function updateSummaryCardsForMode() {
            if (currentViewMode === 'summary') {
                var aggregatedData = aggregateByMedicine(allReportData);
                var totalAvailable = aggregatedData.reduce((sum, item) => sum + item.availableStock, 0);
                var totalConsumed = aggregatedData.reduce((sum, item) => sum + item.consumedStock, 0);
                var totalRaised = aggregatedData.reduce((sum, item) => sum + item.raisedQuantity, 0);
                var outOfStockCount = aggregatedData.filter(item => item.stockStatus === 'Out of Stock').length;
                var lowStockCount = aggregatedData.filter(item => item.stockStatus === 'Low Stock').length;

                $('#totalRecords').text(aggregatedData.length);
                $('#totalRaisedQuantity').text(totalRaised.toLocaleString());
                $('#totalAvailableStock').text(totalAvailable.toLocaleString());
                $('#totalConsumedStock').text(totalConsumed.toLocaleString());
                $('#stockAlerts').text(outOfStockCount + lowStockCount);
            } else {
                // Recalculate for batch mode
                const correctedRaisedTotal = computeRaisedTotalByGroupAverage(allReportData);
                var totalAvailable = allReportData.reduce((sum, item) => sum + Number(item.availableStock || 0), 0);
                var totalConsumed = allReportData.reduce((sum, item) => sum + Number(item.consumedStock || 0), 0);
                var outOfStock = allReportData.filter(item => item.stockStatus === 'Out of Stock').length;
                var lowStock = allReportData.filter(item => item.stockStatus === 'Low Stock').length;

                $('#totalRecords').text(allReportData.length);
                $('#totalBatches').text(allReportData.filter(r => r.batchNo !== 'No Batch Info').length);
                $('#totalRaisedQuantity').text(correctedRaisedTotal.toLocaleString());
                $('#totalAvailableStock').text(totalAvailable.toLocaleString());
                $('#totalConsumedStock').text(totalConsumed.toLocaleString());
                $('#stockAlerts').text(outOfStock + lowStock);
            }
        }

        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const startTime = performance.now();

            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (end - start) * progress);

                element.textContent = current.toLocaleString();

                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                }
            }

            requestAnimationFrame(updateValue);
        }

        function updatePlantInfo(reportInfo) {
            $('#currentPlantCode').text(reportInfo.plantCode || 'N/A');
            $('#currentPlantName').text(reportInfo.plantName || 'Unknown Plant');
        }

        function exportReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            var showOnlyAvailable = $('#showAvailableStockFilter').is(':checked');

            if ((fromDate && !toDate) || (!fromDate && toDate)) {
                showAlert('warning', 'Please select both dates or leave both empty', 'Export Failed');
                return;
            }

            showAlert('info', 'Preparing inventory export file...', 'Export Started');

            var exportUrl = '@Url.Action("ExportCompounderInventoryReport", "CompounderInventoryReport")' +
                '?fromDate=' + (fromDate || '') +
                '&toDate=' + (toDate || '') +
                '&showOnlyAvailable=' + showOnlyAvailable;

            window.location.href = exportUrl;
        }

        function printReport() {
            if ($('#reportTableSection').is(':visible')) {
                showAlert('info', 'Preparing print view...', 'Print Started');
                setTimeout(() => window.print(), 500);
            } else {
                showAlert('warning', 'Please generate the report first', 'Print Failed');
            }
        }

        function showAlert(type, message, title = null) {
            console.log(`${title || type.toUpperCase()}: ${message}`);
        }
    </script>
}
